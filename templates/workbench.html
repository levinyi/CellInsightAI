{% extends 'base.html' %}
{% load i18n %}

{% block title %}CellInsightAI {% trans "Â∑•‰ΩúÂè∞" %}{% endblock %}

{% block extra_js %}
<!-- JavaScript i18n catalog -->
<script src="{% url 'javascript-catalog' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
  /* Main Layout */
  .main-container { display:grid; grid-template-columns:340px 1fr; height:calc(100vh - 105px); }

  /* Project Context Bar */
  .project-context {
    background:var(--panel); border-bottom:1px solid var(--border); padding:12px 24px;
    display:flex; align-items:center; justify-content:space-between; font-size:14px;
  }
  .project-info { display:flex; align-items:center; gap:12px; }
  .project-label { color:var(--muted); }
  .project-name {
    font-weight:600; color:var(--accent); cursor:pointer;
    text-decoration:underline; text-underline-offset:2px;
  }
  .project-name:hover { opacity:0.8; }
  .project-actions { display:flex; align-items:center; gap:8px; }
  .project-select {
    min-width:200px; background:var(--bg); border:1px solid var(--border);
    color:var(--text); border-radius:6px; padding:6px 12px;
  }

  /* Sidebar */
  .sidebar {
    background:var(--panel); border-right:1px solid var(--border); overflow-y:auto;
    display:flex; flex-direction:column;
  }
  .sidebar-section { padding:20px; border-bottom:1px solid var(--border); }
  .sidebar-section:last-child { border-bottom:none; flex:1; }
  .section-title { font-size:14px; font-weight:600; margin:0 0 16px 0; color:#bcd1ff; }

  /* Steps Section */
  .steps-container { max-height:400px; overflow-y:auto; }
  .step-item {
    display:flex; align-items:center; padding:12px; border-radius:8px; margin-bottom:8px;
    background:rgba(255,255,255,0.02); cursor:pointer; transition:all 0.2s;
  }
  .step-item:hover { background:rgba(255,255,255,0.06); }
  .step-item.active { background:var(--accent); color:white; }
  .step-item.completed { background:rgba(49,196,141,0.1); border:1px solid rgba(49,196,141,0.3); }
  .step-number {
    width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,0.1);
    display:flex; align-items:center; justify-content:center; font-size:12px; margin-right:12px;
  }
  .step-item.active .step-number { background:white; color:var(--accent); }
  .step-item.completed .step-number { background:var(--ok); color:white; }
  .step-info { flex:1; }
  .step-name { font-size:14px; font-weight:500; margin:0; }
  .step-desc { font-size:12px; color:var(--muted); margin:2px 0 0 0; }
  .step-status { font-size:11px; padding:2px 6px; border-radius:4px; }
  .step-status.pending { background:rgba(245,158,11,0.2); color:#f59e0b; }
  .step-status.running { background:rgba(79,141,245,0.2); color:var(--accent); }
  .step-status.completed { background:rgba(49,196,141,0.2); color:var(--ok); }
  .step-status.failed { background:rgba(244,63,94,0.2); color:#f43f5e; }

  /* Continue Analysis Section */
  .continue-section {
    background:rgba(79,141,245,0.1); border:1px solid rgba(79,141,245,0.3);
    border-radius:8px; padding:16px; margin-bottom:16px;
  }
  .continue-title {
    font-size:14px; font-weight:600; margin:0 0 12px 0; color:var(--accent);
    display:flex; align-items:center; gap:6px;
  }
  .continue-list { max-height:200px; overflow-y:auto; }
  .continue-item {
    background:rgba(255,255,255,0.04); border-radius:6px; padding:10px; margin-bottom:8px;
    cursor:pointer; transition:all 0.2s; display:flex; justify-content:space-between; align-items:center;
  }
  .continue-item:hover { background:rgba(255,255,255,0.08); }
  .continue-info { flex:1; }
  .continue-name { font-size:13px; font-weight:500; margin:0 0 2px 0; }
  .continue-meta { font-size:11px; color:var(--muted); }
  .continue-btn {
    padding:4px 8px; background:var(--accent); color:white; border:none;
    border-radius:4px; font-size:11px; cursor:pointer;
  }
  .continue-btn:hover { background:#3b7ce6; }

  /* Main Content */
  .content { display:flex; flex-direction:column; overflow:hidden; }

  /* Workflow Header */
  .workflow-header {
    padding:20px 24px; border-bottom:1px solid var(--border); background:var(--panel);
    display:flex; align-items:center; justify-content:space-between;
  }
  .workflow-title { font-size:20px; font-weight:600; margin:0; }
  .workflow-actions { display:flex; gap:12px; }

  .btn {
    padding:10px 20px; border-radius:8px; font-size:14px; font-weight:500;
    border:1px solid transparent; cursor:pointer; transition:all 0.2s ease;
  }
  .btn.primary { background:var(--accent); color:white; border:1px solid var(--accent); box-shadow:0 2px 8px rgba(79,141,245,0.3); }
  .btn.primary:hover:not(:disabled) { background:#3b7ce6; border-color:#3b7ce6; box-shadow:0 4px 12px rgba(79,141,245,0.4); transform:translateY(-1px); }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* Tabs */
  .tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel); }
  .tab { padding:12px 20px; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; font-size:14px; }
  .tab:hover { background:var(--hover); }
  .tab.active { border-bottom-color:var(--accent); color:var(--accent); }

  /* Tab Content */
  .tab-content { flex:1; overflow:auto; }
  .tab-pane { display:none; padding:24px; height:100%; }
  .tab-pane.active { display:block; }

  /* Parameters Panel */
  .params-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; }
  .param-group {
    background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:16px;
  }
  .param-group h3 { font-size:14px; margin:0 0 12px 0; color:#bcd1ff; }
  .param-row { margin-bottom:12px; }
  .param-row:last-child { margin-bottom:0; }
  .param-label { display:block; font-size:13px; color:#bcd1ff; margin-bottom:6px; }
  .param-input { width:100%; }

  /* Upload (big panel) */
  .upload-area {
    border:2px dashed rgba(255,255,255,0.2); border-radius:12px; padding:28px; text-align:center;
    cursor:pointer; transition:all 0.2s;
  }
  .upload-area:hover, .upload-area.dragover { border-color:var(--accent); background:rgba(79,141,245,0.05); }
  .upload-icon { font-size:36px; margin-bottom:12px; opacity:0.6; }
  .upload-text { margin:8px 0; }
  .upload-hint { font-size:12px; color:var(--muted); }
  .file-list { margin-top:16px; }
  .file-item {
    display:flex; align-items:center; justify-content:space-between; padding:8px 12px;
    background:rgba(255,255,255,0.04); border-radius:6px; margin-bottom:8px;
  }
  .file-item .name { font-size:14px; }
  .file-item .size { font-size:12px; color:var(--muted); }

  /* Results Panel */
  .results-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; height:100%; }
  .result-panel {
    background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px;
    display:flex; flex-direction:column;
  }
  .panel-header { padding:16px; border-bottom:1px solid var(--border); font-weight:600; }
  .panel-content { flex:1; padding:16px; overflow:auto; }
  .chart-placeholder {
    height:300px; background:rgba(255,255,255,0.02); border-radius:8px;
    display:flex; align-items:center; justify-content:center; color:var(--muted);
  }

  /* Metrics */
  .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px; }
  .metric-card { background:rgba(255,255,255,0.04); border-radius:8px; padding:12px; text-align:center; }
  .metric-value { font-size:20px; font-weight:600; margin-bottom:4px; }
  .metric-label { font-size:12px; color:var(--muted); }
  .metric-card.ok .metric-value { color:var(--ok); }
  .metric-card.warn .metric-value { color:var(--warn); }
  .metric-card.err .metric-value { color:var(--err); }

  /* Log */
  .log-container {
    background:#0a1120; border:1px solid var(--border); border-radius:8px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    height:200px; overflow:auto; padding:12px; font-size:12px; color:#a7b6d9;
  }

  /* Project Selection Modal (Âç†‰ΩçÔºåÂΩìÂâçÁî® prompt ÁÆÄÂåñ) */
  .project-selection-overlay { display:none; }
</style>
{% endblock %}

{% block content %}
  <!-- Organization Selector -->
  <div style="background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <label style="font-size:14px;color:var(--muted);margin-right:8px;">{% trans "ÂΩìÂâçÁªÑÁªá:" %}</label>
      <select id="org_select" style="min-width:200px;" onchange="onOrgChange()">
        <option value="">{% trans "ÈÄâÊã©ÁªÑÁªá..." %}</option>
      </select>
    </div>
    <div id="user_profile" style="display:none;">
      <span id="user_name">{% trans "Êú™ÁôªÂΩï" %}</span>
      <button class="login-btn" onclick="showLoginModal()" style="margin-left:12px;padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">{% trans "ÁÇπÂáªÁôªÂΩï" %}</button>
    </div>
  </div>

  <!-- Project Context Bar -->
  <div class="project-context">
    <div class="project-info">
      <span class="project-label">{% trans "ÂΩìÂâçÈ°πÁõÆ:" %}</span>
      <span class="project-name" id="current_project_name" onclick="showProjectSelector()">{% trans "Êú™ÈÄâÊã©È°πÁõÆ" %}</span>
    </div>
    <div class="project-actions">
      <select class="project-select" id="project_quick_select" onchange="onProjectQuickChange()" style="display:none;">
        <option value="">{% trans "ÂàáÊç¢È°πÁõÆ..." %}</option>
      </select>
      <a href="{{ APP_URLS.PROJECTS }}" style="color:var(--muted);text-decoration:none;font-size:13px;">{% trans "üìÅ È°πÁõÆÁÆ°ÁêÜ" %}</a>
    </div>
  </div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Continue Analysis -->
      <div class="sidebar-section" id="continue_section" style="display:none;">
        <div class="continue-section">
          <div class="continue-title">
            üîÑ {% trans "ÁªßÁª≠ÂàÜÊûê" %}
          </div>
          <div class="continue-list" id="continue_list"></div>
        </div>
      </div>

      <!-- Analysis Steps -->
      <div class="sidebar-section">
        <h2 class="section-title">üî¨ {% trans "ÂàÜÊûêÊ≠•È™§" %}</h2>
        <div class="steps-container" id="steps_container">
          <div class="step-item" data-step="upload">
            <div class="step-number">1</div>
            <div class="step-info">
              <div class="step-name">{% trans "Êï∞ÊçÆ‰∏ä‰º†" %}</div>
              <div class="step-desc">{% trans "‰∏ä‰º†ÂéüÂßãÊï∞ÊçÆÊñá‰ª∂" %}</div>
            </div>
            <div class="step-status pending">{% trans "ÂæÖÂ§ÑÁêÜ" %}</div>
          </div>
          <div class="step-item" data-step="qc">
            <div class="step-number">2</div>
            <div class="step-info">
              <div class="step-name">{% trans "Ë¥®ÈáèÊéßÂà∂" %}</div>
              <div class="step-desc">{% trans "ËøáÊª§‰ΩéË¥®ÈáèÁªÜËÉûÂíåÂü∫Âõ†" %}</div>
            </div>
            <div class="step-status pending">{% trans "ÂæÖÂ§ÑÁêÜ" %}</div>
          </div>
          <div class="step-item" data-step="hvg">
            <div class="step-number">3</div>
            <div class="step-info">
              <div class="step-name">{% trans "È´òÂèòÂü∫Âõ†" %}</div>
              <div class="step-desc">{% trans "ËØÜÂà´È´òÂèòÂºÇÂü∫Âõ†" %}</div>
            </div>
            <div class="step-status pending">{% trans "ÂæÖÂ§ÑÁêÜ" %}</div>
          </div>
          <div class="step-item" data-step="pca">
            <div class="step-number">4</div>
            <div class="step-info">
              <div class="step-name">{% trans "‰∏ªÊàêÂàÜÂàÜÊûê" %}</div>
              <div class="step-desc">{% trans "ÈôçÁª¥Â§ÑÁêÜ" %}</div>
            </div>
            <div class="step-status pending">{% trans "ÂæÖÂ§ÑÁêÜ" %}</div>
          </div>
          <div class="step-item" data-step="umap">
            <div class="step-number">5</div>
            <div class="step-info">
              <div class="step-name">{% trans "UMAPÂµåÂÖ•" %}</div>
              <div class="step-desc">{% trans "2DÂèØËßÜÂåñ" %}</div>
            </div>
            <div class="step-status pending">{% trans "ÂæÖÂ§ÑÁêÜ" %}</div>
          </div>
          <div class="step-item" data-step="clustering">
            <div class="step-number">6</div>
            <div class="step-info">
              <div class="step-name">{% trans "ÁªÜËÉûËÅöÁ±ª" %}</div>
              <div class="step-desc">{% trans "ËØÜÂà´ÁªÜËÉûÁ±ªÂûã" %}</div>
            </div>
            <div class="step-status pending">{% trans "ÂæÖÂ§ÑÁêÜ" %}</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="sidebar-section">
        <h2 class="section-title">üìä {% trans "ËøêË°åÂéÜÂè≤" %}</h2>
        <div class="history-list" id="history_list">
          <div style="text-align:center; color:var(--muted); padding:20px;">{% trans "ÊöÇÊó†ËøêË°åËÆ∞ÂΩï" %}</div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Header -->
      <div class="workflow-header">
        <h1 class="workflow-title" id="workflow_title">{% trans "Êï∞ÊçÆ‰∏ä‰º†" %}</h1>
        <div class="workflow-actions">
          <!-- Run ÊåâÈíÆ‰ªÖÂú®Èùû‰∏ä‰º†Ê≠•È™§ÊòæÁ§∫ -->
          <button class="btn primary" id="run_btn" onclick="runCurrentStep()" style="display:none;" disabled>
            {% trans "ÂºÄÂßãÂàÜÊûê" %}
          </button>
        </div>
      </div>

      <!-- TabsÔºà‰ªÖÂú®Èùû‰∏ä‰º†Ê≠•È™§ÊòæÁ§∫Ôºâ -->
      <div id="tabs_wrapper" style="display:none;">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('params', event)">{% trans "ÂèÇÊï∞ÈÖçÁΩÆ" %}</div>
          <div class="tab" onclick="switchTab('results', event)">{% trans "ÁªìÊûúÂ±ïÁ§∫" %}</div>
          <div class="tab" onclick="switchTab('logs', event)">{% trans "ËøêË°åÊó•Âøó" %}</div>
        </div>

        <div class="tab-content">
          <!-- Parameters Tab -->
          <div class="tab-pane active" id="tab_params">
            <div class="params-grid" id="params_grid"></div>
          </div>

          <!-- Results Tab -->
          <div class="tab-pane" id="tab_results">
            <div class="results-grid">
              <div class="result-panel">
                <div class="panel-header">üìä {% trans "ÂÖ≥ÈîÆÊåáÊ†á" %}</div>
                <div class="panel-content">
                  <div class="metrics-grid" id="metrics_grid">
                    <div class="metric-card">
                      <div class="metric-value" id="metric_cells">-</div>
                      <div class="metric-label">{% trans "ÁªÜËÉûÊï∞" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_genes">-</div>
                      <div class="metric-label">{% trans "Âü∫Âõ†Êï∞" %}</div>
                    </div>
                    <div class="metric-card warn">
                      <div class="metric-value" id="metric_doublets">-</div>
                      <div class="metric-label">{% trans "ÂèåÁªÜËÉûÁéá" %}</div>
                    </div>
                    <div class="metric-card err">
                      <div class="metric-value" id="metric_mito">-</div>
                      <div class="metric-label">{% trans "Á∫øÁ≤í‰ΩìÊØî‰æã" %}</div>
                    </div>
                  </div>
                  <div class="chart-placeholder">
                    {% trans "ÂàÜÊûêÂÆåÊàêÂêéÂ∞ÜÊòæÁ§∫ UMAP ÂõæË°®" %}
                  </div>
                </div>
              </div>
              <div class="result-panel">
                <div class="panel-header">ü§ñ {% trans "AI Âª∫ËÆÆ" %}</div>
                <div class="panel-content">
                  <div id="advice_content" style="color:var(--muted); text-align:center; padding:40px 20px;">
                    {% trans "ËøêË°åÂàÜÊûêÂêéÂ∞ÜÊòæÁ§∫ AI ‰ºòÂåñÂª∫ËÆÆ" %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs Tab -->
          <div class="tab-pane" id="tab_logs">
            <div class="log-container" id="log_container">
              <div style="color:var(--muted);">[{% trans "Á≥ªÁªü" %}] {% trans "Á≠âÂæÖÂºÄÂßãÂàÜÊûê..." %}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload OnlyÔºà‰ªÖÂú®Á¨¨ 1 Ê≠•ÊòæÁ§∫Ôºâ -->
      <div id="upload_only_view" style="padding:24px;">
        <div id="upload_project_cta_mount"></div> <!-- ‚òÖ Êó†È°πÁõÆÊó∂ÁöÑ CTA ÊåÇËΩΩÁÇπ -->
        <div class="params-grid">
          <div class="param-group">
            <h3>üìÅ {% trans "‰∏ä‰º†ÂçïÁªÜËÉûÊï∞ÊçÆ" %}</h3>
            <p style="color:var(--muted);line-height:1.6;">
              {% trans "ÊîØÊåÅ .h5ad, .h5, .csv, .mtx, .zip Á≠âÔºõÂèØÊãñÊãΩÊàñÁÇπÂáªÈÄâÊã©„ÄÇ" %}
              <br>
              {% trans "ÈÄâÊã©Êñá‰ª∂ÂêéÔºåÁÇπÂáª‚Äú‰∏ä‰º†Êï∞ÊçÆ‚ÄùÂºÄÂßã‰∏ä‰º†ÔºõÂÆåÊàêÂêéÂ∞ÜËá™Âä®ËøõÂÖ•Ë¥®ÈáèÊéßÂà∂Ê≠•È™§„ÄÇ" %}
            </p>
            <div id="big_upload_drop" class="upload-area" style="margin-top:12px;">
              <div class="upload-icon">üì§</div>
              <div class="upload-text">{% trans "ÁÇπÂáªÊàñÊãñÊãΩÂà∞Ê≠§Â§ÑÈÄâÊã©Êñá‰ª∂" %}</div>
              <div class="upload-hint">{% trans "Âª∫ËÆÆ‰ºòÂÖà‰ΩøÁî® .h5ad Êàñ 10x ÂéãÁº©ÂåÖ" %}</div>
              <input type="file" id="big_file_input" style="display:none" multiple
                     accept=".h5ad,.h5,.csv,.mtx,.tsv,.txt,.gz,.zip">
            </div>
            <div class="file-list" id="big_file_list" style="margin-top:12px;"></div>
            <div style="display:flex;gap:12px;margin-top:16px;">
              <!-- ‰ªÖ‰øùÁïô‚Äú‰∏ä‰º†Êï∞ÊçÆ‚ÄùÊåâÈíÆ -->
              <button id="btn_submit_upload" class="btn primary" type="button" disabled>{% trans "‰∏ä‰º†Êï∞ÊçÆ" %}</button>
            </div>
            <div id="upload_progress" style="margin-top:12px;color:var(--muted);"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal hidden" id="login_modal">
    <div class="modal-content">
      <h2 class="modal-title">{% trans "ÁôªÂΩï CellInsightAI" %}</h2>
      <div class="modal-row">
        <label class="param-label">{% trans "ÈÇÆÁÆ±ÊàñÁî®Êà∑Âêç" %}</label>
        <input type="text" id="login_email" class="param-input" placeholder="your@email.com">
      </div>
      <div class="modal-row">
        <label class="param-label">{% trans "ÂØÜÁ†Å" %}</label>
        <input type="password" id="login_password" class="param-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="hideLoginModal()">{% trans "ÂèñÊ∂à" %}</button>
        <button class="btn" onclick="demoLogin()">{% trans "Demo ÁôªÂΩï" %}</button>
        <button class="btn primary" onclick="doLogin()">{% trans "ÁôªÂΩï" %}</button>
      </div>
    </div>
  </div>

  <script id="app-urls" type="application/json">{{ APP_URLS_JSON|safe }}</script>

  <script>
    // -------------------- Global State --------------------
    let currentUser = null;
    let currentOrg = localStorage.getItem('active_org') || null;
    let currentStep = 'upload';
    let uploadedFiles = [];
    let currentProject = null;
    let currentDataset = null;
    let currentSession = null;
    let availableSteps = [];
    let availableProjects = [];
    let recentSessions = [];

    // ============ Project Context Helpers ============
    function updateProjectUI() {
      const nameEl = document.getElementById('current_project_name');
      const quickSelect = document.getElementById('project_quick_select');
      const cur = currentProject && availableProjects.find(p => String(p.id) === String(currentProject));
      if (nameEl) nameEl.textContent = cur ? (cur.name || ('#' + cur.id)) : gettext('Êú™ÈÄâÊã©È°πÁõÆ');
      if (quickSelect) {
        quickSelect.style.display = availableProjects.length ? '' : 'none';
        if (cur) quickSelect.value = String(cur.id);
      }
      updateUploadBtnDisabled();
      // Êó†È°πÁõÆÊó∂ÔºåÊ∏≤Êüì‰∏ä‰º†ËßÜÂõæÈ°∂ÈÉ® CTA
      const ctaMount = document.getElementById('upload_project_cta_mount');
      if (ctaMount) renderUploadEmptyProjectCTA(ctaMount);
    }

    async function loadAvailableProjects() {
      if (!currentOrg) { availableProjects = []; updateProjectUI(); return; }
      try {
        const url = `${window.APP_URLS.API_PROJECTS}?organization=${encodeURIComponent(currentOrg)}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        availableProjects = Array.isArray(data) ? data : (data.results || []);
        const quickSelect = document.getElementById('project_quick_select');
        if (quickSelect) {
          quickSelect.innerHTML = `<option value="">${gettext('ÂàáÊç¢È°πÁõÆ...')}</option>` +
            availableProjects.map(p => `<option value="${p.id}">${p.name || ('#' + p.id)}</option>`).join('');
        }
        updateProjectUI();
      } catch (e) {
        console.error('loadAvailableProjects error:', e);
        availableProjects = [];
        updateProjectUI();
      }
    }

    async function initProjectContext() {
      const fromUrl = new URLSearchParams(location.search).get('project');
      const fromStore = localStorage.getItem('selected_project');
      currentProject = fromUrl || fromStore || null;
      if (currentProject && !availableProjects.find(p => String(p.id) === String(currentProject))) {
        currentProject = null;
      }
      updateProjectUI();
      if (currentProject) {
        await loadProjectSessions(currentProject);
      } else {
        renderContinueList([]);
      }
    }

    function showProjectSelector() {
      const quickSelect = document.getElementById('project_quick_select');
      if (!quickSelect) return;
      quickSelect.style.display = '';
      quickSelect.focus();
    }

    async function onProjectQuickChange() {
      const quickSelect = document.getElementById('project_quick_select');
      if (!quickSelect) return;
      const val = quickSelect.value || '';
      currentProject = val || null;
      if (currentProject) {
        localStorage.setItem('selected_project', currentProject);
        await loadProjectSessions(currentProject);
      } else {
        localStorage.removeItem('selected_project');
        renderContinueList([]);
      }
      updateProjectUI();
    }

    async function loadProjectSessions(projectId) {
      try {
        const url = `${window.APP_URLS.API_SESSIONS}?project=${encodeURIComponent(projectId)}&ordering=-updated_at&limit=10`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        recentSessions = Array.isArray(data) ? data : (data.results || []);
        renderContinueList(recentSessions);
      } catch (e) {
        console.error('loadProjectSessions error:', e);
        renderContinueList([]);
      }
    }

    function renderContinueList(list) {
      const sec = document.getElementById('continue_section');
      const ul = document.getElementById('continue_list');
      if (!sec || !ul) return;
      if (!list.length) {
        sec.style.display = 'none';
        ul.innerHTML = '';
        return;
      }
      sec.style.display = '';
      ul.innerHTML = list.map(s => {
        const status = s.status || 'paused';
        const step = s.current_step || 'upload';
        const when = s.updated_at ? new Date(s.updated_at).toLocaleString() : '';
        const label = s.name || (`#${s.id}`);
        return `
          <div class="continue-item" data-session-id="${s.id}">
            <div class="continue-info">
              <div class="continue-name">${label}</div>
              <div class="continue-meta">${gettext('Áä∂ÊÄÅ')}: ${status} ¬∑ ${gettext('ÂΩìÂâçÊ≠•È™§')}: ${step} ¬∑ ${when}</div>
            </div>
            <button class="continue-btn" data-session-id="${s.id}">${gettext('ÁªßÁª≠')}</button>
          </div>
        `;
      }).join('');

      ul.onclick = async (e) => {
        const btn = e.target.closest('.continue-btn, .continue-item');
        if (!btn) return;
        const sid = btn.getAttribute('data-session-id');
        if (!sid) return;
        await enterSession(sid);
      };
    }

    async function enterSession(sessionId) {
      try {
        const url = `${window.APP_URLS.API_SESSIONS}${sessionId}/`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const s = await res.json();
        currentSession = s.id;
        currentDataset = s.dataset;
        currentProject = s.project || currentProject;
        updateProjectUI();
        await loadSessionHistory();
        const step = s.current_step || 'qc';
        setStepActive(step);
      } catch (e) {
        console.error('enterSession error:', e);
        alert(gettext('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•'));
      } finally {
        updateRunButtonState();
      }
    }

    // -------------------- Utils --------------------
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }
    function getCsrfToken() { return getCookie('csrftoken') || ''; }
    function authHeaders(extra = {}) {
      const h = { 'X-CSRFToken': getCsrfToken() };
      if (currentOrg) h['X-Org'] = currentOrg;
      return Object.assign(h, extra);
    }
    function logMessage(message) {
      const container = document.getElementById('log_container');
      if (!container) return;
      const timestamp = new Date().toLocaleTimeString();
      container.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      container.scrollTop = container.scrollHeight;
    }

    // -------------------- App URLs --------------------
    try {
      window.APP_URLS = JSON.parse(document.getElementById('app-urls').textContent || '{}');
    } catch (e) {
      window.APP_URLS = {};
      console.error('Failed to parse APP_URLS JSON', e);
    }
    // ========= Êñ∞Â¢ûÂ∏ÆÂä©ÂáΩÊï∞ÔºàÊîæÂú®ÊúÄ‰∏äÈù¢ÁöÑ‚ÄúGlobal State‚ÄùÈôÑËøëÊàñ Utils ‰∏äÊñπÈÉΩÂèØ‰ª•Ôºâ =========
    function getOrganizationsUrl() {
      // ÂÖºÂÆπ API_ORGANIZATIONS / API_ORGS ‰∏§Áßç key
      const u = window.APP_URLS || {};
      return u.API_ORGANIZATIONS || u.API_ORGS || '/api/v1/organizations/';
    }
    function getDefaultOrgFromUser(user) {
      // Â∞ΩÈáè‰ªé /me ËøîÂõûÈáåÂèñÈªòËÆ§ÁªÑÁªáÔºõÂÖºÂÆπ‰∏çÂêåÂ≠óÊÆµÂëΩÂêç
      if (!user) return null;
      if (user.profile && (user.profile.organization || (user.profile.organization_id))) {
        return String(user.profile.organization?.id || user.profile.organization_id || user.profile.organization);
      }
      if (user.default_organization || user.default_organization_id) {
        return String(user.default_organization?.id || user.default_organization_id || user.default_organization);
      }
      // ‰∏Ä‰∫õÂêéÁ´Ø‰ºöÊääÂΩìÂâç org ÊîæÂú® user.organization
      if (user.organization || user.organization_id) {
        return String(user.organization?.id || user.organization_id || user.organization);
      }
      return null;
    }
    function setCurrentOrg(orgId) {
      currentOrg = orgId ? String(orgId) : null;
      const sel = document.getElementById('org_select');
      if (sel) sel.value = currentOrg || '';
      if (currentOrg) localStorage.setItem('active_org', currentOrg);
      else localStorage.removeItem('active_org');
    }
    // ========= ÊõøÊç¢ fetchCurrentUser ÂáΩÊï∞ =========
    async function fetchCurrentUser() {
      try {
        const res = await fetch(window.APP_URLS.API_USER_ME, { headers: authHeaders() });
        const userProfile = document.getElementById('user_profile');
        const userName = document.getElementById('user_name');
        const loginBtn = userProfile.querySelector('.login-btn');

        if (res.ok) {
          const user = await res.json();
          currentUser = user;
          userName.textContent = user.username || user.email || gettext('Áî®Êà∑');
          loginBtn.textContent = gettext('Â∑≤ÁôªÂΩï');
          loginBtn.style.background = 'var(--ok)';
          loginBtn.onclick = null;
          userProfile.style.display = 'block';

          // ÂÖ≥ÈîÆÔºöÂú®ËøôÈáåÂÖàËß£Êûê‚ÄúÈªòËÆ§ÁªÑÁªá‚ÄùÔºåÂ¶ÇÊúâÂàôË¶ÜÁõñÊú¨Âú∞ÁöÑ active_org
          const userDefaultOrg = getDefaultOrgFromUser(user);
          // Â¶ÇÊûúÊú¨Âú∞Ê≤°Êúâ active_org ÊàñÊú¨Âú∞ÁöÑÂπ∂‰∏çÂ≠òÂú®‰∫éËØ•Áî®Êà∑ÔºåÁªü‰∏Ä‰ª•Áî®Êà∑ÈªòËÆ§ÁªÑÁªá‰∏∫ÂáÜ
          if (!currentOrg || currentOrg === 'undefined') {
            setCurrentOrg(userDefaultOrg);
          }

          await loadOrganizations(user);        // ‰º† userÔºåÊñπ‰æøÂáΩÊï∞ÂÜÖÈÉ®ÂÖúÂ∫ï
          await loadAvailableProjects();        // ‰æùËµñ currentOrg ÁöÑÂàóË°®
          await initProjectContext();
        } else {
          // Êú™ÁôªÂΩïÂàÜÊîØ
          currentUser = null;
          userName.textContent = gettext('Êú™ÁôªÂΩï');
          loginBtn.textContent = gettext('ÁÇπÂáªÁôªÂΩï');
          loginBtn.style.background = 'var(--accent)';
          loginBtn.onclick = showLoginModal;
          userProfile.style.display = 'block';
          // Ê∏ÖÁ©∫Êú¨Âú∞ org
          setCurrentOrg(null);
        }
      } catch (e) {
        console.error('Error fetching user:', e);
      }
    }
    // ========= ÊõøÊç¢ loadOrganizations ÂáΩÊï∞ÔºàÊñ∞Â¢û user ÂèÇÊï∞ÔºåËá™Âä®ÈÄâ‰∏≠ÈÄªËæëÔºâ =========
    async function loadOrganizations(user = currentUser) {
      if (!user) return;
      try {
        const url = getOrganizationsUrl();
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const orgs = await res.json();

        const orgSelect = document.getElementById('org_select');
        if (orgSelect) {
          orgSelect.innerHTML = '<option value="">' + gettext('ÈÄâÊã©ÁªÑÁªá...') + '</option>';
          // ÂÖºÂÆπËøîÂõûÁªìÊûÑÔºöÊï∞ÁªÑÊàñ {results: []}
          const list = Array.isArray(orgs) ? orgs : (orgs.results || []);
          list.forEach(org => {
            const option = document.createElement('option');
            option.value = String(org.id);
            option.textContent = org.name || ('#' + org.id);
            orgSelect.appendChild(option);
          });

          // Ëá™Âä®ÈÄâÊã©Á≠ñÁï•Ôºö
          // 1) currentOrgÔºàÂ¶ÇÊûúÂêàÊ≥ïÔºâÔºõ
          // 2) Áî®Êà∑ÈªòËÆ§ÁªÑÁªá getDefaultOrgFromUser(user)Ôºõ
          // 3) Âè™Êúâ‰∏Ä‰∏™ÁªÑÁªáÊó∂ÈÄâÂÆÉÔºõ
          // 4) Âê¶Âàô‰øùÊåÅÁ©∫
          const userDefaultOrg = getDefaultOrgFromUser(user);
          const ids = list.map(o => String(o.id));
          let nextOrg = null;

          if (currentOrg && ids.includes(String(currentOrg))) {
            nextOrg = String(currentOrg);
          } else if (userDefaultOrg && ids.includes(String(userDefaultOrg))) {
            nextOrg = String(userDefaultOrg);
          } else if (list.length === 1) {
            nextOrg = String(list[0].id);
          }

          setCurrentOrg(nextOrg);  // ‰ºöÂêåÊ≠• select + localStorage
        }
      } catch (e) {
        console.error('Failed to load organizations:', e);
      }
    }

    async function autoSelectFirstOrganization() {
      try {
        console.log('Attempting to auto-select organization...');
        const res = await fetch(window.APP_URLS.API_ORGANIZATIONS, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          const orgsList = Array.isArray(data) ? data : (data.results || []);
          console.log('Organizations response:', orgsList);
          
          if (orgsList.length > 0) {
            const lowerEq = (a,b) => String(a||'').toLowerCase() === String(b||'').toLowerCase();
            const lowerInc = (a,b) => String(a||'').toLowerCase().includes(String(b||'').toLowerCase());
            
            // 1) Á≤æÁ°ÆÂåπÈÖçÂêçÁß∞‰∏∫ 'Demo Org'
            let targetOrg = orgsList.find(org => lowerEq(org.name, 'Demo Org'));
            // 2) ÂÖ∂Ê¨°ÔºöÂêçÁß∞ÂåÖÂê´ 'demo' Êàñ‰∏≠Êñá‚ÄúÊºîÁ§∫/Á§∫‰æã‚Äù
            if (!targetOrg) targetOrg = orgsList.find(org => lowerInc(org.name, 'demo') || lowerInc(org.name, 'ÊºîÁ§∫') || lowerInc(org.name, 'Á§∫‰æã'));
            // 3) Âê¶ÂàôÔºöÁ¨¨‰∏Ä‰∏™ÁªÑÁªá
            if (!targetOrg) targetOrg = orgsList[0];
            
            currentOrg = String(targetOrg.id);
            localStorage.setItem('active_org', currentOrg);
            console.log('Auto-selected organization:', targetOrg.name, 'ID:', currentOrg);
            
            const orgSelect = document.getElementById('org_select');
            if (orgSelect) {
              // Â¶ÇÊûúÈÄâÈ°πÂàóË°®Â∞öÊú™Âä†ËΩΩ/‰∏çÂ≠òÂú®ËØ•ÈÄâÈ°πÔºåÂàôÈáçÂª∫‰∏ÄÊ¨°
              let needRebuild = true;
              if (orgSelect.options && orgSelect.options.length > 0) {
                for (let option of orgSelect.options) {
                  if (String(option.value) === String(currentOrg)) { needRebuild = false; break; }
                }
              }
              if (needRebuild) {
                orgSelect.innerHTML = '<option value="">' + gettext('ÈÄâÊã©ÁªÑÁªá...') + '</option>';
                orgsList.forEach(org => {
                  const opt = document.createElement('option');
                  opt.value = org.id;
                  opt.textContent = org.name;
                  orgSelect.appendChild(opt);
                });
              }
              orgSelect.value = currentOrg;
            }
            
            await loadAvailableProjects();
            updateProjectUI();
            updateUploadBtnDisabled();
          } else {
            console.log('No organizations found for auto-selection');
          }
        } else {
          console.error('Failed to fetch organizations:', res.status, await res.text());
        }
      } catch (e) {
        console.error('Failed to auto-select organization:', e);
      }
    }

    // ========= Â∞èÊîπ onOrgChangeÔºåÁ°Æ‰øùÂÜôÂÖ•Êú¨Âú∞Âπ∂Âà∑Êñ∞Áõ∏ÂÖ≥‰æùËµñ =========
    function onOrgChange() {
      const select = document.getElementById('org_select');
      if (!select) return;
      setCurrentOrg(select.value || null);  // Áªü‰∏ÄÂÖ•Âè£
      loadAvailableProjects();              // ÈöèÁªÑÁªáÂàáÊç¢Âà∑Êñ∞È°πÁõÆ
      updateProjectUI();
      updateUploadBtnDisabled();
    }

    function showLoginModal() {
      const modal = document.getElementById('login_modal');
      if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('login_email').focus();
      }
    }

    function hideLoginModal() {
      const modal = document.getElementById('login_modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    async function doLogin() {
      const email = document.getElementById('login_email').value.trim();
      const password = document.getElementById('login_password').value;

      if (!email || !password) {
        alert(gettext('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å'));
        return;
      }

      try {
        const res = await fetch(`${window.APP_URLS.API_USERS_BASE}/login/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
          body: JSON.stringify({ email, password })
        });

        if (res.ok) {
          hideLoginModal();
          await fetchCurrentUser();
        } else {
          alert(gettext('ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å'));
        }
      } catch (e) {
        console.error('Login error:', e);
        alert(gettext('ÁôªÂΩïÂ§±Ë¥•'));
      }
    }

    /**
     * ÊºîÁ§∫ÁôªÂΩïÂäüËÉΩ - Ëá™Âä®ÂÖ≥ËÅîÂà∞ÁªÑÁªá
     */
    async function demoLogin() {
      try {
        const res = await fetch(window.APP_URLS.API_DEMO_LOGIN, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCsrfToken() }
        });
        if (res.ok) {
          hideLoginModal();
          await fetchCurrentUser();
          // ‚òÖ DemoÁôªÂΩïÂêéËá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁªÑÁªá
          await autoSelectFirstOrganization();
        } else {
          alert(gettext('Demo ÁôªÂΩïÂ§±Ë¥•'));
        }
      } catch (e) {
        console.error('Demo login error:', e);
        alert(gettext('Demo ÁôªÂΩïÂ§±Ë¥•'));
      }
    }

    // -------------------- Steps Management --------------------
    async function loadAvailableSteps() {
      try {
        const res = await fetch(window.APP_URLS.API_STEPS, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          availableSteps = Array.isArray(data) ? data : (data.results || []);
        }
      } catch (e) {
        console.error('Failed to load steps:', e);
      }
    }

    function setStepActive(stepName) {
      currentStep = stepName;

      document.querySelectorAll('.step-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-step') === stepName) {
          item.classList.add('active');
        }
      });

      const titleEl = document.getElementById('workflow_title');
      const stepTitles = {
        'upload': gettext('Êï∞ÊçÆ‰∏ä‰º†'),
        'qc': gettext('Ë¥®ÈáèÊéßÂà∂'),
        'hvg': gettext('È´òÂèòÂü∫Âõ†'),
        'pca': gettext('‰∏ªÊàêÂàÜÂàÜÊûê'),
        'umap': gettext('UMAPÂµåÂÖ•'),
        'clustering': gettext('ÁªÜËÉûËÅöÁ±ª')
      };
      if (titleEl) {
        titleEl.textContent = stepTitles[stepName] || stepName;
      }

      const uploadView = document.getElementById('upload_only_view');
      const tabsWrapper = document.getElementById('tabs_wrapper');
      const runBtn = document.getElementById('run_btn');

      if (stepName === 'upload') {
        if (uploadView) uploadView.style.display = 'block';
        if (tabsWrapper) tabsWrapper.style.display = 'none';
        if (runBtn) runBtn.style.display = 'none';
        renderUploadView();
      } else {
        if (uploadView) uploadView.style.display = 'none';
        if (tabsWrapper) tabsWrapper.style.display = 'block';
        if (runBtn) runBtn.style.display = 'inline-block';
        renderParametersView(stepName);
      }

      updateRunButtonState();
    }

    function setStepStatus(stepName, status) {
      const stepItem = document.querySelector(`.step-item[data-step="${stepName}"]`);
      if (!stepItem) return;

      const statusEl = stepItem.querySelector('.step-status');
      if (statusEl) {
        statusEl.className = `step-status ${status}`;
        const statusTexts = {
          'pending': gettext('ÂæÖÂ§ÑÁêÜ'),
          'running': gettext('ËøêË°å‰∏≠'),
          'completed': gettext('Â∑≤ÂÆåÊàê'),
          'failed': gettext('Â§±Ë¥•')
        };
        statusEl.textContent = statusTexts[status] || status;
      }

      stepItem.classList.remove('completed', 'failed');
      if (status === 'completed') stepItem.classList.add('completed');
      if (status === 'failed') stepItem.classList.add('failed');
    }

    function updateRunButtonState() {
      const runBtn = document.getElementById('run_btn');
      if (!runBtn) return;
      const hasRequiredContext = currentProject && currentDataset && currentSession;
      runBtn.disabled = !hasRequiredContext;
      runBtn.textContent = hasRequiredContext ? gettext('ÂºÄÂßãÂàÜÊûê') : gettext('ËØ∑ÂÖàÂÆåÊàêÊï∞ÊçÆ‰∏ä‰º†');
    }

    function updateUploadBtnDisabled() {
      const btn = document.getElementById('btn_submit_upload');
      if (!btn) return;
      const hasFiles = uploadedFiles && uploadedFiles.length > 0;
      const hasProject = !!currentProject;
      const hasOrg = !!currentOrg;
      btn.disabled = !(hasFiles && hasProject && hasOrg);
    }

    // -------------------- Tabs --------------------
    function switchTab(tabName, event) {
      if (event) event.preventDefault();
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      const targetPane = document.getElementById(`tab_${tabName}`);
      if (targetPane) targetPane.classList.add('active');
    }

    // -------------------- Session History --------------------
    async function loadSessionHistory() {
      if (!currentSession) return;
      try {
        const res = await fetch(`${window.APP_URLS.API_STEP_RUNS}?session=${currentSession}`, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          const runs = Array.isArray(data) ? data : (data.results || []);
          renderHistoryList(runs);
        }
      } catch (e) {
        console.error('Failed to load session history:', e);
      }
    }

    function renderHistoryList(runs) {
      const historyList = document.getElementById('history_list');
      if (!historyList) return;
      if (runs.length === 0) {
        historyList.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">' + gettext('ÊöÇÊó†ËøêË°åËÆ∞ÂΩï') + '</div>';
        return;
      }
      historyList.innerHTML = runs.map(run => `
        <div class="history-item" style="padding:8px 12px; border-bottom:1px solid var(--border); cursor:pointer;">
          <div style="font-size:13px; font-weight:500;">${run.step.name}</div>
          <div style="font-size:11px; color:var(--muted);">${run.status} ‚Ä¢ ${new Date(run.created_at).toLocaleString()}</div>
        </div>
      `).join('');
    }

    // -------------------- Run Step --------------------
    async function runCurrentStep() {
      if (!currentProject || !currentDataset || !currentSession) {
        alert(gettext('ËØ∑ÂÖàÂÆåÊàêÊï∞ÊçÆ‰∏ä‰º†'));
        return;
      }
      const stepInfo = availableSteps.find(s => s.step_type === currentStep);
      if (!stepInfo) { alert(gettext('Êú™ÊâæÂà∞Ê≠•È™§ÈÖçÁΩÆ')); return; }

      setStepStatus(currentStep, 'running');
      logMessage(gettext('ÂºÄÂßãÊâßË°åÊ≠•È™§Ôºö') + stepInfo.name);

      try {
        const payload = { session: currentSession, step: stepInfo.id, parameters: {} };
        const res = await fetch(window.APP_URLS.API_CORE_RUN, {
          method: 'POST', headers: authHeaders({'Content-Type': 'application/json'}), body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        await res.json();
        setStepStatus(currentStep, 'completed');
        logMessage(gettext('Ê≠•È™§ÊâßË°åÂÆåÊàê'));
        await loadSessionHistory();
        const order = ['upload','qc','hvg','pca','umap','clustering'];
        const i = order.indexOf(currentStep);
        if (i >= 0 && i < order.length - 1) setStepActive(order[i+1]);
      } catch (e) {
        console.error('Step execution failed:', e);
        setStepStatus(currentStep, 'failed');
        logMessage(gettext('Ê≠•È™§ÊâßË°åÂ§±Ë¥•Ôºö') + (e.message || e));
      }
    }

    // -------------------- Parameters View --------------------
    function renderParametersView(stepName) {
      const paramsGrid = document.getElementById('params_grid');
      if (!paramsGrid) return;
      paramsGrid.innerHTML = `
        <div class="param-group">
          <h3>üìä ${gettext('ÂèÇÊï∞ÈÖçÁΩÆ')}</h3>
          <p style="color:var(--muted);">${gettext('Ê≠•È™§')} ${stepName} ${gettext('ÁöÑÂèÇÊï∞ÈÖçÁΩÆÂ∞ÜÂú®Ê≠§ÊòæÁ§∫')}</p>
        </div>
      `;
    }

    // -------------------- Êñ∞Â¢ûÔºöÂàõÂª∫È°πÁõÆÔºàËΩªÈáè promptÔºâ --------------------
    async function createProjectViaPrompt(defaultName = '') {
      if (!currentOrg) { 
        alert(gettext('ËØ∑ÂÖàÈÄâÊã©ÁªÑÁªá')); 
        throw new Error('no org'); 
      }
      
      const name = prompt(
        gettext('ËØ∑ËæìÂÖ•È°πÁõÆÂêçÁß∞'), 
        defaultName || ('Project_' + new Date().toISOString().slice(0,16).replace(/[T:]/g,'-'))
      );
      
      if (!name || name.trim() === '') {
        throw new Error(gettext('È°πÁõÆÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫'));
      }
      
      const payload = { 
        name: name.trim(), 
        organization: currentOrg 
      };
      
      const res = await fetch(window.APP_URLS.API_PROJECTS, {
        method:'POST', 
        headers:authHeaders({'Content-Type':'application/json'}), 
        body:JSON.stringify(payload)
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(gettext('ÂàõÂª∫È°πÁõÆÂ§±Ë¥•Ôºö') + errorText);
      }
      
      const proj = await res.json();
      currentProject = String(proj.id);
      localStorage.setItem('selected_project', currentProject);
      
      await loadAvailableProjects();
      updateProjectUI();
      
      console.log('Project created successfully:', proj.name);
      return proj;
    }

    /**
     * ÂàõÂª∫È°πÁõÆÂπ∂ÂºÄÂßã‰∏ä‰º†ÊµÅÁ®ã
     */
    async function createProjectAndUpload() {
      try {
        const defaultName = 'Project_' + new Date().toLocaleString().replace(/[\/\s:]/g, '-');
        await createProjectViaPrompt(defaultName);
        
        // Ëã•Â∑≤ÈÄâÊñá‰ª∂‰∏îÁªÑÁªáÂ∑≤ÈÄâÔºåËá™Âä®Ëß¶Âèë‰∏ÄÊ¨°"‰∏ä‰º†Êï∞ÊçÆ"
        const submitBtn = document.getElementById('btn_submit_upload');
        if (uploadedFiles.length > 0 && submitBtn && !submitBtn.disabled) {
          submitBtn.click();
        }
      } catch(e) {
        console.error('Create project and upload failed:', e);
      }
    }

    /**
     * Ê∏≤ÊüìÊó†È°πÁõÆÁ©∫ÊÄÅ CTA
     */
    function renderUploadEmptyProjectCTA(mountEl) {
      if (!mountEl) return;
      if (currentProject) { 
        mountEl.innerHTML = ''; 
        return; 
      }
      
      mountEl.innerHTML = `
        <div class="continue-section" style="margin-bottom:12px;">
          <div class="continue-title">üìÅ ${gettext('ÂºÄÂßãÂâçÂÖàÂª∫‰∏™È°πÁõÆÔºü')}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btn_create_project" class="btn primary">${gettext('ÂàõÂª∫È°πÁõÆ')}</button>
            <button id="btn_quick_upload_project" class="btn">${gettext('‰∏ä‰º†Âπ∂Êñ∞Âª∫È°πÁõÆ')}</button>
          </div>
          <div class="continue-meta" style="margin-top:8px;color:var(--muted);font-size:12px;">
            ${gettext('È°πÁõÆÁî®‰∫éÂΩíÈõÜÊï∞ÊçÆ‰∏éÂàÜÊûêÔºå‰æø‰∫éÊùÉÈôê‰∏éÂéÜÂè≤ÁÆ°ÁêÜ„ÄÇ')}
          </div>
        </div>
      `;
      
      // ‚òÖ ÁªëÂÆöÂàõÂª∫È°πÁõÆÊåâÈíÆ‰∫ã‰ª∂
      const btnCreate = document.getElementById('btn_create_project');
      const btnQuick = document.getElementById('btn_quick_upload_project');
      
      if (btnCreate) {
        btnCreate.onclick = async () => {
          try { 
            await createProjectViaPrompt(); 
          } catch(e) {
            console.error('Create project failed:', e);
          }
        };
      }
      
      if (btnQuick) {
        btnQuick.onclick = createProjectAndUpload;
      }
    }

    // -------------------- Upload View --------------------
    function renderUploadView() {
      const drop = document.getElementById('big_upload_drop');
      const input = document.getElementById('big_file_input');
      const list = document.getElementById('big_file_list');
      const submitBtn = document.getElementById('btn_submit_upload');
      const prog = document.getElementById('upload_progress');
      const ctaMount = document.getElementById('upload_project_cta_mount');

      // ‚òÖ ÊåÇËΩΩÊó†È°πÁõÆ CTA
      if (ctaMount) renderUploadEmptyProjectCTA(ctaMount);

      if (list) list.innerHTML = '';
      if (prog) prog.textContent = '';

      function renderBigList() {
        list.innerHTML = '';
        uploadedFiles.forEach((f, i) => {
          const row = document.createElement('div');
          row.className = 'file-item';
          row.innerHTML = `
            <div>
              <div class="name">${f.name}</div>
              <div class="size">${(f.size/1024/1024).toFixed(2)} MB</div>
            </div>
            <button data-idx="${i}" style="background:none;border:none;color:var(--err);cursor:pointer;">‚úï</button>
          `;
          list.appendChild(row);
        });
        updateUploadBtnDisabled();
      }

      function attachUploadEvents() {
        drop.addEventListener('click', () => input.click());
        drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
        drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
        drop.addEventListener('drop', e => {
          e.preventDefault(); drop.classList.remove('dragover');
          uploadedFiles = Array.from(e.dataTransfer.files || []);
          renderBigList();
        });
        input.addEventListener('change', () => {
          uploadedFiles = Array.from(input.files || []);
          renderBigList();
        });
        list.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-idx]');
          if (!btn) return;
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          uploadedFiles.splice(idx, 1);
          renderBigList();
        });
        submitBtn.addEventListener('click', submitUpload);
      }

      async function submitUpload() {
        if (!currentOrg) { alert(gettext('ËØ∑ÈÄâÊã©ÁªÑÁªá')); return; }
        // ‚òÖ Ëã•Ê≤°ÊúâÈ°πÁõÆÔºåÂàôÂÖàÂºïÂØºÂàõÂª∫Ôºà‰∏é CTA ‰∫íË°•ÔºåÁ°Æ‰øù‰∏ÄÈîÆÊàêÂäüÔºâ
        if (!currentProject) {
          try { await createProjectViaPrompt('Project_' + new Date().toLocaleString()); }
          catch(_) { return; }
        }
        if (uploadedFiles.length === 0) { alert(gettext('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂')); return; }

        setStepStatus('upload', 'running');
        if (prog) prog.textContent = gettext('Ê≠£Âú®‰∏ä‰º†...');

        try {
          // 1) ‰∏ä‰º†Êñá‰ª∂
          const fd = new FormData();
          const firstFile = uploadedFiles[0];
          fd.append('file', firstFile, firstFile.name);
          const res = await fetch(window.APP_URLS.API_STORAGE_UPLOAD, {
            method:'POST', headers:authHeaders(), body:fd
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();

          // 2) ÂàõÂª∫Êï∞ÊçÆÈõÜ
          const datasetPayload = {
            project: currentProject,
            name: gettext('Êï∞ÊçÆÈõÜ') + ' ' + new Date().getTime(),
            dataset_type: 'single_cell',
            input_h5ad_path: data.path
          };
          const datasetRes = await fetch(window.APP_URLS.API_DATASETS, {
            method:'POST', headers:authHeaders({'Content-Type':'application/json'}),
            body: JSON.stringify(datasetPayload)
          });
          if (!datasetRes.ok) throw new Error(gettext('ÂàõÂª∫Êï∞ÊçÆÈõÜÂ§±Ë¥•Ôºö') + await datasetRes.text());
          const dataset = await datasetRes.json();
          currentDataset = dataset.id;

          // 3) ÂàõÂª∫‰ºöËØù
          const sessionPayload = {
            dataset: currentDataset,
            name: gettext('ÂàÜÊûê‰ºöËØù') + ' ' + new Date().getTime(),
            description: gettext('Êñ∞ÁöÑÂçïÁªÜËÉûÂàÜÊûê‰ºöËØù')
          };
          const sessionRes = await fetch(window.APP_URLS.API_SESSIONS, {
            method:'POST', headers:authHeaders({'Content-Type':'application/json'}),
            body: JSON.stringify(sessionPayload)
          });
          if (!sessionRes.ok) throw new Error(gettext('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•Ôºö') + await sessionRes.text());
          const session = await sessionRes.json();
          currentSession = session.id;

          if (prog) prog.textContent = gettext('‰∏ä‰º†ÂÆåÊàê ‚úÖ');
          setStepStatus('upload', 'completed');
          await loadSessionHistory();
          await loadProjectSessions(currentProject);
          setStepActive('qc');
        } catch(e) {
          if (prog) prog.textContent = gettext('‰∏ä‰º†Â§±Ë¥•Ôºö') + String(e.message || e);
          setStepStatus('upload', 'failed');
        } finally {
          updateRunButtonState();
        }
      }

      attachUploadEvents();
      renderBigList();
    }

    // -------------------- Init --------------------
    document.addEventListener('DOMContentLoaded', function() {
      fetchCurrentUser();
      loadAvailableSteps();

      // ÁªëÂÆöÁªÑÁªáÈÄâÊã©‰∏ãÊãâÊ°Ü‰∫ã‰ª∂
      const orgSelect = document.getElementById('org_select');
      if (orgSelect) {
        orgSelect.addEventListener('change', onOrgChange);
      }

      // ÁªëÂÆöÁôªÂΩïÊåâÈíÆ‰∫ã‰ª∂
      const loginBtn = document.querySelector('#user_profile .login-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', showLoginModal);
      }

      const stepsContainer = document.getElementById('steps_container');
      if (stepsContainer) {
        stepsContainer.addEventListener('click', (e) => {
          const item = e.target.closest('.step-item');
          if (!item) return;
          const step = item.getAttribute('data-step');
          if (step !== 'upload' && (!currentDataset || !currentSession)) {
            alert(gettext('ËØ∑ÂÖàÂÆåÊàêÁ¨¨ 1 Ê≠•ÔºöÊï∞ÊçÆ‰∏ä‰º†'));
            return;
          }
          setStepActive(step);
        });
      }

      setStepActive('upload');
    });
  </script>
{% endblock %}