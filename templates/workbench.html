{% extends 'base.html' %}

{% block title %}CellInsightAI å·¥ä½œå°{% endblock %}

{% block extra_css %}
<style>
    /* Main Layout */
    .main-container { display:grid; grid-template-columns:340px 1fr; height:calc(100vh - 65px); }
    
    /* Sidebar */
    .sidebar { 
      background:var(--panel); border-right:1px solid var(--border); overflow-y:auto; 
      display:flex; flex-direction:column;
    }
    .sidebar-section { padding:20px; border-bottom:1px solid var(--border); }
    .sidebar-section:last-child { border-bottom:none; flex:1; }
    .section-title { font-size:14px; font-weight:600; margin:0 0 16px 0; color:#bcd1ff; }
    
    /* Upload Section */
    .upload-area { 
      border:2px dashed rgba(255,255,255,0.2); border-radius:12px; padding:24px; text-align:center; 
      cursor:pointer; transition:all 0.2s;
    }
    .upload-area:hover, .upload-area.dragover { border-color:var(--accent); background:rgba(79,141,245,0.05); }
    .upload-icon { font-size:32px; margin-bottom:12px; opacity:0.6; }
    .upload-text { margin:8px 0; }
    .upload-hint { font-size:12px; color:var(--muted); }
    .file-list { margin-top:16px; }
    .file-item { 
      display:flex; align-items:center; justify-content:space-between; padding:8px 12px; 
      background:rgba(255,255,255,0.04); border-radius:6px; margin-bottom:8px;
    }
    .file-item .name { font-size:14px; }
    .file-item .size { font-size:12px; color:var(--muted); }
    
    /* Steps Section */
    .steps-container { max-height:400px; overflow-y:auto; }
    .step-item { 
      display:flex; align-items:center; padding:12px; border-radius:8px; margin-bottom:8px; 
      background:rgba(255,255,255,0.02); cursor:pointer; transition:all 0.2s;
    }
    .step-item:hover { background:rgba(255,255,255,0.06); }
    .step-item.active { background:var(--accent); color:white; }
    .step-item.completed { background:rgba(49,196,141,0.1); border:1px solid rgba(49,196,141,0.3); }
    .step-number { 
      width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,0.1); 
      display:flex; align-items:center; justify-content:center; font-size:12px; margin-right:12px;
    }
    .step-item.active .step-number { background:white; color:var(--accent); }
    .step-item.completed .step-number { background:var(--ok); color:white; }
    .step-info { flex:1; }
    .step-name { font-size:14px; font-weight:500; margin:0; }
    .step-desc { font-size:12px; color:var(--muted); margin:2px 0 0 0; }
    .step-status { font-size:11px; padding:2px 6px; border-radius:4px; }
    .step-status.pending { background:rgba(245,158,11,0.2); color:#f59e0b; }
    .step-status.running { background:rgba(79,141,245,0.2); color:var(--accent); }
    .step-status.completed { background:rgba(49,196,141,0.2); color:var(--ok); }
    
    /* Main Content */
    .content { display:flex; flex-direction:column; overflow:hidden; }
    
    /* Workflow Header */
    .workflow-header { 
      padding:20px 24px; border-bottom:1px solid var(--border); background:var(--panel);
      display:flex; align-items:center; justify-content:space-between;
    }
    .workflow-title { font-size:20px; font-weight:600; margin:0; }
    .workflow-actions { display:flex; gap:12px; }
    
    /* Tabs */
    .tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel); }
    .tab { 
      padding:12px 20px; cursor:pointer; border-bottom:2px solid transparent; 
      transition:all 0.2s; font-size:14px;
    }
    .tab:hover { background:var(--hover); }
    .tab.active { border-bottom-color:var(--accent); color:var(--accent); }
    
    /* Tab Content */
    .tab-content { flex:1; overflow:auto; }
    .tab-pane { display:none; padding:24px; height:100%; }
    .tab-pane.active { display:block; }
    
    /* Parameters Panel */
    .params-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; }
    .param-group { 
      background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:16px;
    }
    .param-group h3 { font-size:14px; margin:0 0 12px 0; color:#bcd1ff; }
    .param-row { margin-bottom:12px; }
    .param-row:last-child { margin-bottom:0; }
    .param-label { display:block; font-size:13px; color:#bcd1ff; margin-bottom:6px; }
    .param-input { width:100%; }
    
    /* Results Panel */
    .results-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; height:100%; }
    .result-panel { 
      background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; 
      display:flex; flex-direction:column;
    }
    .panel-header { padding:16px; border-bottom:1px solid var(--border); font-weight:600; }
    .panel-content { flex:1; padding:16px; overflow:auto; }
    .chart-placeholder { 
      height:300px; background:rgba(255,255,255,0.02); border-radius:8px; 
      display:flex; align-items:center; justify-content:center; color:var(--muted);
    }
    
    /* Metrics */
    .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px; }
    .metric-card { 
      background:rgba(255,255,255,0.04); border-radius:8px; padding:12px; text-align:center;
    }
    .metric-value { font-size:20px; font-weight:600; margin-bottom:4px; }
    .metric-label { font-size:12px; color:var(--muted); }
    .metric-card.ok .metric-value { color:var(--ok); }
    .metric-card.warn .metric-value { color:var(--warn); }
    .metric-card.err .metric-value { color:var(--err); }
    
    /* Log */
    .log-container { 
      background:#0a1120; border:1px solid var(--border); border-radius:8px; 
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; 
      height:200px; overflow:auto; padding:12px; font-size:12px; color:#a7b6d9;
    }
    
    /* History */
    .history-list { max-height:300px; overflow-y:auto; }
    .history-item { 
      display:flex; align-items:center; justify-content:space-between; padding:8px 12px; 
      background:rgba(255,255,255,0.02); border-radius:6px; margin-bottom:8px; font-size:13px;
    }
    .history-item:hover { background:rgba(255,255,255,0.06); }
    .run-id { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; color:var(--muted); }
    
    /* Login Modal */
    .modal { 
      position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); 
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal.hidden { display:none; }
    .modal-content { 
      background:var(--panel); border:1px solid var(--border); border-radius:12px; 
      padding:24px; width:400px; max-width:90vw;
    }
    .modal-title { font-size:18px; margin:0 0 20px 0; }
    .modal-row { margin-bottom:16px; }
    .modal-row:last-child { margin-bottom:0; }
    .modal-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:20px; }
    
    /* Navigation styles */
    nav a:hover {
      background:var(--hover) !important;
      color:var(--accent) !important;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .main-container { grid-template-columns:280px 1fr; }
      .params-grid { grid-template-columns:1fr; }
      .results-grid { grid-template-columns:1fr; }
    }
    
    @media (max-width: 768px) {
      header { padding:12px; flex-wrap:wrap; }
      nav { order:3; width:100%; margin-top:12px; justify-content:center; }
      nav a { font-size:12px; padding:6px 8px; }
      .user-info { gap:8px; }
      .main-container { grid-template-columns:1fr; }
      .sidebar { position:fixed; left:-100%; top:105px; bottom:0; width:280px; z-index:99; transition:left 0.3s; }
      .sidebar.open { left:0; }
      .content { grid-column:1; }
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Organization Selector for Workbench -->
  <div style="background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <label style="font-size:14px;color:var(--muted);margin-right:8px;">å½“å‰ç»„ç»‡:</label>
      <select id="org_select" style="min-width:200px;" onchange="onOrgChange()">
        <option value="">é€‰æ‹©ç»„ç»‡...</option>
      </select>
    </div>
    <div id="user_profile" style="display:none;">
      <span id="user_name">æœªç™»å½•</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Upload Section -->
      <div class="sidebar-section">
        <h2 class="section-title">ğŸ“ æ•°æ®ä¸Šä¼ </h2>
        <div class="upload-area" onclick="document.getElementById('file_input').click()">
          <div class="upload-icon">ğŸ“¤</div>
          <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ•°æ®æ–‡ä»¶</div>
          <div class="upload-hint">æ”¯æŒ .h5ad, .h5, .csv, .mtx, .zip ç­‰æ ¼å¼</div>
          <input type="file" id="file_input" style="display:none" multiple 
                 accept=".h5ad,.h5,.csv,.mtx,.tsv,.txt,.gz,.zip" onchange="handleFileSelect(event)">
        </div>
        <div class="file-list" id="file_list"></div>
      </div>

      <!-- Analysis Steps -->
      <div class="sidebar-section">
        <h2 class="section-title">ğŸ”¬ åˆ†ææ­¥éª¤</h2>
        <div class="steps-container" id="steps_container">
          <div class="step-item" data-step="upload">
            <div class="step-number">1</div>
            <div class="step-info">
              <div class="step-name">æ•°æ®ä¸Šä¼ </div>
              <div class="step-desc">ä¸Šä¼ åŸå§‹æ•°æ®æ–‡ä»¶</div>
            </div>
            <div class="step-status pending">å¾…å¤„ç†</div>
          </div>
          <div class="step-item" data-step="qc">
            <div class="step-number">2</div>
            <div class="step-info">
              <div class="step-name">è´¨é‡æ§åˆ¶</div>
              <div class="step-desc">è¿‡æ»¤ä½è´¨é‡ç»†èƒå’ŒåŸºå› </div>
            </div>
            <div class="step-status pending">å¾…å¤„ç†</div>
          </div>
          <div class="step-item" data-step="hvg">
            <div class="step-number">3</div>
            <div class="step-info">
              <div class="step-name">é«˜å˜åŸºå› </div>
              <div class="step-desc">è¯†åˆ«é«˜å˜å¼‚åŸºå› </div>
            </div>
            <div class="step-status pending">å¾…å¤„ç†</div>
          </div>
          <div class="step-item" data-step="pca">
            <div class="step-number">4</div>
            <div class="step-info">
              <div class="step-name">ä¸»æˆåˆ†åˆ†æ</div>
              <div class="step-desc">é™ç»´å¤„ç†</div>
            </div>
            <div class="step-status pending">å¾…å¤„ç†</div>
          </div>
          <div class="step-item" data-step="umap">
            <div class="step-number">5</div>
            <div class="step-info">
              <div class="step-name">UMAPåµŒå…¥</div>
              <div class="step-desc">2Då¯è§†åŒ–</div>
            </div>
            <div class="step-status pending">å¾…å¤„ç†</div>
          </div>
          <div class="step-item" data-step="clustering">
            <div class="step-number">6</div>
            <div class="step-info">
              <div class="step-name">ç»†èƒèšç±»</div>
              <div class="step-desc">è¯†åˆ«ç»†èƒç±»å‹</div>
            </div>
            <div class="step-status pending">å¾…å¤„ç†</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="sidebar-section">
        <h2 class="section-title">ğŸ“Š è¿è¡Œå†å²</h2>
        <div class="history-list" id="history_list">
          <div style="text-align:center; color:var(--muted); padding:20px;">æš‚æ— è¿è¡Œè®°å½•</div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Workflow Header -->
      <div class="workflow-header">
        <h1 class="workflow-title" id="workflow_title">å‡†å¤‡å¼€å§‹åˆ†æ</h1>
        <div class="workflow-actions">
          <button class="btn" onclick="resetWorkflow()">é‡ç½®æµç¨‹</button>
          <button class="btn accent" id="run_btn" onclick="runCurrentStep()" disabled>å¼€å§‹åˆ†æ</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('params')">å‚æ•°é…ç½®</div>
        <div class="tab" onclick="switchTab('results')">ç»“æœå±•ç¤º</div>
        <div class="tab" onclick="switchTab('logs')">è¿è¡Œæ—¥å¿—</div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Parameters Tab -->
        <div class="tab-pane active" id="tab_params">
          <div class="params-grid" id="params_grid">
            <div class="param-group">
              <h3>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ CellInsightAI</h3>
              <p style="color:var(--muted); line-height:1.6;">
                è¯·å…ˆä¸Šä¼ æ‚¨çš„å•ç»†èƒæ•°æ®æ–‡ä»¶ï¼Œç„¶åæŒ‰ç…§å·¦ä¾§çš„åˆ†ææ­¥éª¤è¿›è¡Œé…ç½®å’Œè¿è¡Œã€‚
                ç³»ç»Ÿå°†è‡ªåŠ¨å¼•å¯¼æ‚¨å®Œæˆè´¨é‡æ§åˆ¶ã€é™ç»´ã€èšç±»ç­‰æ ‡å‡†åˆ†ææµç¨‹ã€‚
              </p>
            </div>
          </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-pane" id="tab_results">
          <div class="results-grid">
            <div class="result-panel">
              <div class="panel-header">ğŸ“Š å…³é”®æŒ‡æ ‡</div>
              <div class="panel-content">
                <div class="metrics-grid" id="metrics_grid">
                  <div class="metric-card">
                    <div class="metric-value" id="metric_cells">-</div>
                    <div class="metric-label">ç»†èƒæ•°</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-value" id="metric_genes">-</div>
                    <div class="metric-label">åŸºå› æ•°</div>
                  </div>
                  <div class="metric-card warn">
                    <div class="metric-value" id="metric_doublets">-</div>
                    <div class="metric-label">åŒç»†èƒç‡</div>
                  </div>
                  <div class="metric-card err">
                    <div class="metric-value" id="metric_mito">-</div>
                    <div class="metric-label">çº¿ç²’ä½“æ¯”ä¾‹</div>
                  </div>
                </div>
                <div class="chart-placeholder">
                  åˆ†æå®Œæˆåå°†æ˜¾ç¤º UMAP å›¾è¡¨
                </div>
              </div>
            </div>
            <div class="result-panel">
              <div class="panel-header">ğŸ¤– AI å»ºè®®</div>
              <div class="panel-content">
                <div id="advice_content" style="color:var(--muted); text-align:center; padding:40px 20px;">
                  è¿è¡Œåˆ†æåå°†æ˜¾ç¤º AI ä¼˜åŒ–å»ºè®®
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div class="tab-pane" id="tab_logs">
          <div class="log-container" id="log_container">
            <div style="color:var(--muted);">[ç³»ç»Ÿ] ç­‰å¾…å¼€å§‹åˆ†æ...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal hidden" id="login_modal">
    <div class="modal-content">
      <h2 class="modal-title">ç™»å½• CellInsightAI</h2>
      <div class="modal-row">
        <label class="param-label">é‚®ç®±æˆ–ç”¨æˆ·å</label>
        <input type="text" id="login_email" class="param-input" placeholder="your@email.com">
      </div>
      <div class="modal-row">
        <label class="param-label">å¯†ç </label>
        <input type="password" id="login_password" class="param-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="hideLoginModal()">å–æ¶ˆ</button>
        <button class="btn" onclick="demoLogin()">Demo ç™»å½•</button>
        <button class="btn accent" onclick="doLogin()">ç™»å½•</button>
      </div>
    </div>
  </div>

  <script id="app-urls" type="application/json">{{ APP_URLS_JSON|safe }}</script>
  <script>
    // è§£æ APP_URLS
    try {
      window.APP_URLS = JSON.parse(document.getElementById('app-urls').textContent || '{}');
    } catch (e) {
      window.APP_URLS = {};
      console.error('Failed to parse APP_URLS JSON', e);
    }

    // Global state
    let currentUser = null;
    let currentOrg = null;
    let currentStep = 'upload';
    let uploadedFiles = [];
    let currentProject = null;
    let currentSample = null;
    let wsConnection = null;
    let stepRuns = {};

    // Utility functions
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }

    function getCsrfToken() {
      return getCookie('csrftoken') || '';
    }

    function authHeaders(extra = {}) {
      const h = { 'X-CSRFToken': getCsrfToken() };
      if (currentOrg) h['X-Org'] = currentOrg;
      return Object.assign(h, extra);
    }

    function logMessage(message) {
      const container = document.getElementById('log_container');
      const timestamp = new Date().toLocaleTimeString();
      container.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      container.scrollTop = container.scrollHeight;
    }

    // Modal functions
    function showLoginModal() {
      document.getElementById('login_modal').classList.remove('hidden');
    }

    function hideLoginModal() {
      document.getElementById('login_modal').classList.add('hidden');
    }

    // Authentication
    async function doLogin() {
      const email = document.getElementById('login_email').value.trim();
      const password = document.getElementById('login_password').value;
      
      if (!email || !password) {
        alert('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
        return;
      }

      try {
        const res = await fetch(`${window.APP_URLS.API_USERS_BASE}/login/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ');
          return;
        }

        const userData = await res.json();
        currentUser = userData;
        updateUserDisplay();
        hideLoginModal();
        await loadOrganizations();
        logMessage('ç™»å½•æˆåŠŸ');
      } catch (error) {
        console.error('Login error:', error);
        alert('ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
      }
    }

    async function demoLogin() {
      try {
        const res = await fetch(window.APP_URLS.API_DEMO_LOGIN, {
          method: 'POST',
          headers: authHeaders()
        });

        if (!res.ok) {
          alert('Demo ç™»å½•å¤±è´¥');
          return;
        }

        // Get user info
        const meRes = await fetch(window.APP_URLS.API_USER_ME, {
          headers: authHeaders()
        });
        
        if (meRes.ok) {
          currentUser = await meRes.json();
          updateUserDisplay();
          hideLoginModal();
          await loadOrganizations();
          await ensureDefaultSteps();
          logMessage('Demo ç™»å½•æˆåŠŸ');
        }
      } catch (error) {
        console.error('Demo login error:', error);
        alert('Demo ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
      }
    }

    async function doLogout() {
      try {
        await fetch(window.APP_URLS.API_LOGOUT, {
          method: 'POST',
          headers: authHeaders()
        });
        
        currentUser = null;
        currentOrg = null;
        updateUserDisplay();
        logMessage('å·²ç™»å‡º');
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    function updateUserDisplay() {
      const authBtn = document.getElementById('auth_btn');
      const userProfile = document.getElementById('user_profile');
      const userName = document.getElementById('user_name');
      const userAvatar = document.getElementById('user_avatar');
      const demoBtn = document.getElementById('demo_btn');
      const logoutBtn = document.getElementById('logout_btn');

      if (currentUser) {
        authBtn.style.display = 'none';
        demoBtn.style.display = 'none';
        userProfile.style.display = 'flex';
        logoutBtn.style.display = 'inline-block';
        userName.textContent = currentUser.username || currentUser.email;
        userAvatar.textContent = (currentUser.username || currentUser.email)[0].toUpperCase();
      } else {
        authBtn.style.display = 'block';
        demoBtn.style.display = 'block';
        logoutBtn.style.display = 'none';
        userProfile.style.display = 'none';
      }
      updateRunButtonState();
    }

    // Organizations
    async function loadOrganizations() {
      if (!currentUser) return;

      try {
        const res = await fetch(window.APP_URLS.API_ORGANIZATIONS, {
          headers: authHeaders()
        });
        
        if (res.ok) {
          const data = await res.json();
          const orgs = data?.results || data || [];
          const select = document.getElementById('org_select');
          
          select.innerHTML = '<option value="">é€‰æ‹©ç»„ç»‡...</option>' + 
            orgs.map(org => `<option value="${org.id}">${org.name}</option>`).join('');
          
          // Auto-select first org if available
          if (orgs.length > 0 && !currentOrg) {
            currentOrg = orgs[0].id;
            select.value = currentOrg;
          }
        }
      } catch (error) {
        console.error('Load organizations error:', error);
      }
    }

    function onOrgChange() {
      const select = document.getElementById('org_select');
      currentOrg = select.value;
      if (currentOrg) {
        logMessage(`åˆ‡æ¢åˆ°ç»„ç»‡: ${select.selectedOptions[0].text}`);
      }
      updateRunButtonState(); // Update button state when org changes
    }

    // Steps management
    async function ensureDefaultSteps() {
      try {
        await fetch(`${window.APP_URLS.API_STEPS}ensure_defaults/`, {
          method: 'POST',
          headers: authHeaders()
        });
      } catch (error) {
        console.error('Ensure default steps error:', error);
      }
    }

    // File upload
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      files.forEach(file => {
        if (!uploadedFiles.find(f => f.name === file.name)) {
          uploadedFiles.push(file);
        }
      });
      updateFileList();
      updateStepStatus('upload', 'completed');
      enableNextStep('qc');
      updateRunButtonState(); // Update button state when files are uploaded
    }

    function updateFileList() {
      const container = document.getElementById('file_list');
      
      if (uploadedFiles.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = uploadedFiles.map(file => `
        <div class="file-item">
          <div>
            <div class="name">${file.name}</div>
            <div class="size">${formatFileSize(file.size)}</div>
          </div>
          <button class="btn small" onclick="removeFile('${file.name}')">ç§»é™¤</button>
        </div>
      `).join('');
    }

    function removeFile(fileName) {
      uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
      updateFileList();
      
      if (uploadedFiles.length === 0) {
        updateStepStatus('upload', 'pending');
        resetFromStep('qc');
      }
      updateRunButtonState(); // Update button state when files are removed
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Steps workflow
    function updateStepStatus(stepName, status) {
      const stepElement = document.querySelector(`.step-item[data-step="${stepName}"]`);
      if (stepElement) {
        const statusElement = stepElement.querySelector('.step-status');
        statusElement.className = `step-status ${status}`;
        statusElement.textContent = {
          'pending': 'å¾…å¤„ç†',
          'running': 'è¿è¡Œä¸­',
          'completed': 'å·²å®Œæˆ'
        }[status] || status;

        if (status === 'completed') {
          stepElement.classList.add('completed');
        } else {
          stepElement.classList.remove('completed');
        }
      }
    }

    function enableNextStep(stepName) {
      const stepElement = document.querySelector(`.step-item[data-step="${stepName}"]`);
      if (stepElement) {
        stepElement.onclick = () => selectStep(stepName);
        stepElement.style.cursor = 'pointer';
      }
    }

    function selectStep(stepName) {
      // Remove active from all steps
      document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
      
      // Add active to selected step
      const stepElement = document.querySelector(`.step-item[data-step="${stepName}"]`);
      if (stepElement) {
        stepElement.classList.add('active');
        currentStep = stepName;
        updateWorkflowHeader();
        loadStepParameters();
        
        // Enable run button if step is ready and we have uploaded files
        updateRunButtonState();
      }
    }

    function updateRunButtonState() {
      const runBtn = document.getElementById('run_btn');
      
      // Only enable if:
      // 1. User is logged in and org is selected
      // 2. Files are uploaded
      // 3. Current step is not 'upload'
      const hasAuth = currentUser && currentOrg;
      const hasFiles = uploadedFiles.length > 0;
      const isValidStep = currentStep !== 'upload';
      
      runBtn.disabled = !(hasAuth && hasFiles && isValidStep);
    }

    function resetFromStep(fromStep) {
      const steps = ['upload', 'qc', 'hvg', 'pca', 'umap', 'clustering'];
      const fromIndex = steps.indexOf(fromStep);
      
      for (let i = fromIndex; i < steps.length; i++) {
        updateStepStatus(steps[i], 'pending');
        const stepElement = document.querySelector(`.step-item[data-step="${steps[i]}"]`);
        if (stepElement) {
          stepElement.onclick = null;
          stepElement.style.cursor = 'default';
          stepElement.classList.remove('active', 'completed');
        }
      }
    }

    function resetWorkflow() {
      uploadedFiles = [];
      updateFileList();
      resetFromStep('upload');
      currentStep = 'upload';
      updateWorkflowHeader();
      document.getElementById('run_btn').disabled = true;
      
      // Clear results
      document.getElementById('metric_cells').textContent = '-';
      document.getElementById('metric_genes').textContent = '-';
      document.getElementById('metric_doublets').textContent = '-';
      document.getElementById('metric_mito').textContent = '-';
      
      logMessage('å·¥ä½œæµç¨‹å·²é‡ç½®');
    }

    function updateWorkflowHeader() {
      const title = document.getElementById('workflow_title');
      const stepNames = {
        'upload': 'æ•°æ®ä¸Šä¼ ',
        'qc': 'è´¨é‡æ§åˆ¶åˆ†æ',
        'hvg': 'é«˜å˜åŸºå› è¯†åˆ«',
        'pca': 'ä¸»æˆåˆ†åˆ†æ',
        'umap': 'UMAP é™ç»´',
        'clustering': 'ç»†èƒèšç±»'
      };
      
      title.textContent = stepNames[currentStep] || 'åˆ†ææµç¨‹';
    }

    // Parameters
    function loadStepParameters() {
      const paramsGrid = document.getElementById('params_grid');
      
      const paramConfigs = {
        'qc': [
          { group: 'Quality Control', params: [
            { name: 'min_genes', label: 'æœ€å°åŸºå› æ•°', type: 'number', value: 200, help: 'æ¯ä¸ªç»†èƒè¡¨è¾¾çš„æœ€å°åŸºå› æ•°' },
            { name: 'max_genes', label: 'æœ€å¤§åŸºå› æ•°', type: 'number', value: 5000, help: 'æ¯ä¸ªç»†èƒè¡¨è¾¾çš„æœ€å¤§åŸºå› æ•°' },
            { name: 'max_mito', label: 'çº¿ç²’ä½“åŸºå› æ¯”ä¾‹ (%)', type: 'number', value: 20, help: 'çº¿ç²’ä½“åŸºå› è¡¨è¾¾çš„æœ€å¤§æ¯”ä¾‹' }
          ]}
        ],
        'hvg': [
          { group: 'Highly Variable Genes', params: [
            { name: 'hvg_method', label: 'HVG æ–¹æ³•', type: 'select', value: 'seurat_v3', options: ['seurat_v3', 'cell_ranger', 'seurat'], help: 'é«˜å˜åŸºå› è¯†åˆ«æ–¹æ³•' },
            { name: 'n_top_genes', label: 'åŸºå› æ•°é‡', type: 'number', value: 2000, help: 'é€‰æ‹©çš„é«˜å˜åŸºå› æ•°é‡' }
          ]}
        ],
        'pca': [
          { group: 'Principal Component Analysis', params: [
            { name: 'n_comps', label: 'PC æ•°é‡', type: 'number', value: 50, help: 'ä¸»æˆåˆ†æ•°é‡' },
            { name: 'svd_solver', label: 'SVD ç®—æ³•', type: 'select', value: 'arpack', options: ['arpack', 'randomized'], help: 'SVD æ±‚è§£å™¨' }
          ]}
        ],
        'umap': [
          { group: 'UMAP Parameters', params: [
            { name: 'n_neighbors', label: 'é‚»å±…æ•°é‡', type: 'number', value: 15, help: 'UMAP é‚»å±…æ•°é‡' },
            { name: 'min_dist', label: 'æœ€å°è·ç¦»', type: 'number', value: 0.5, step: 0.1, help: 'UMAP æœ€å°è·ç¦»å‚æ•°' }
          ]}
        ],
        'clustering': [
          { group: 'Clustering', params: [
            { name: 'resolution', label: 'èšç±»åˆ†è¾¨ç‡', type: 'number', value: 0.5, step: 0.1, help: 'Leiden èšç±»åˆ†è¾¨ç‡' },
            { name: 'algorithm', label: 'èšç±»ç®—æ³•', type: 'select', value: 'leiden', options: ['leiden', 'louvain'], help: 'èšç±»ç®—æ³•é€‰æ‹©' }
          ]}
        ]
      };

      const config = paramConfigs[currentStep];
      if (!config) {
        paramsGrid.innerHTML = '<div class="param-group"><h3>è¯·é€‰æ‹©åˆ†ææ­¥éª¤</h3></div>';
        return;
      }

      paramsGrid.innerHTML = config.map(group => `
        <div class="param-group">
          <h3>${group.group}</h3>
          ${group.params.map(param => `
            <div class="param-row">
              <label class="param-label" title="${param.help || ''}">${param.label}</label>
              ${param.type === 'select' ? 
                `<select class="param-input" id="param_${param.name}">
                  ${param.options.map(opt => `<option value="${opt}" ${opt === param.value ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>` :
                `<input class="param-input" id="param_${param.name}" type="${param.type}" value="${param.value}" ${param.step ? `step="${param.step}"` : ''}>`
              }
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    function collectStepParams() {
      const params = {};
      document.querySelectorAll('[id^="param_"]').forEach(input => {
        const name = input.id.replace('param_', '');
        let value = input.value;
        
        if (input.type === 'number') {
          value = parseFloat(value);
          // Convert percentage to decimal for mito
          if (name === 'max_mito') {
            value = value / 100;
          }
        }
        
        params[name] = value;
      });
      
      return params;
    }

    // Run analysis
    async function runCurrentStep() {
      if (!currentUser || !currentOrg) {
        alert('è¯·å…ˆç™»å½•å¹¶é€‰æ‹©ç»„ç»‡');
        return;
      }

      if (currentStep === 'upload') {
        alert('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
        return;
      }

      if (uploadedFiles.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
        return;
      }

      try {
        // First, ensure we have a project and sample
        if (!currentProject) {
          await createProjectAndSample();
        }

        // Upload files if needed
        await uploadDataFiles();

        // Get step ID
        const stepId = await getStepId(currentStep);
        if (!stepId) {
          alert('æ‰¾ä¸åˆ°å¯¹åº”çš„åˆ†ææ­¥éª¤ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
          return;
        }

        // Collect parameters
        const params = collectStepParams();

        // Start step run
        updateStepStatus(currentStep, 'running');
        logMessage(`å¼€å§‹æ‰§è¡Œ ${currentStep} åˆ†æ...`);

        // Use the correct API endpoint that exists in backend
        logMessage(`å‡†å¤‡è¯·æ±‚: POST /api/v1/tasks`);
        logMessage(`è¯·æ±‚æ•°æ®: sample=${currentSample.id}, step=${stepId}`);
        
        const runRes = await fetch('/api/v1/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({
            sample: currentSample.id,
            step: stepId,
            params: params
          })
        });

        logMessage(`è¯·æ±‚å“åº”çŠ¶æ€: ${runRes.status} ${runRes.statusText}`);

        if (!runRes.ok) {
          const errorData = await runRes.json().catch(() => ({}));
          logMessage(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(errorData)}`);
          throw new Error(errorData.detail || 'å¯åŠ¨åˆ†æå¤±è´¥');
        }

        const runData = await runRes.json();
        stepRuns[currentStep] = runData;

        // Connect to WebSocket for updates
        if (runData.ws_url) {
          connectWebSocket(runData.ws_url);
        }

        logMessage(`åˆ†æä»»åŠ¡å·²å¯åŠ¨ï¼ŒID: ${runData.task_id || runData.id}`);

      } catch (error) {
        console.error('Run step error:', error);
        updateStepStatus(currentStep, 'pending');
        logMessage(`æ‰§è¡Œå¤±è´¥: ${error.message}`);
        // Log additional context for debugging
        logMessage(`é”™è¯¯ç±»å‹: ${error.constructor.name}`);
        logMessage(`é”™è¯¯å †æ ˆ: ${error.stack || 'N/A'}`);
        alert('å¯åŠ¨åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    async function createProjectAndSample() {
      // Create project
      const projectRes = await fetch(window.APP_URLS.API_PROJECTS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...authHeaders() },
        body: JSON.stringify({
          name: `åˆ†æé¡¹ç›® ${new Date().toLocaleString()}`,
          description: 'é€šè¿‡å·¥ä½œå°åˆ›å»ºçš„åˆ†æé¡¹ç›®'
        })
      });

      if (!projectRes.ok) {
        throw new Error('åˆ›å»ºé¡¹ç›®å¤±è´¥');
      }

      currentProject = await projectRes.json();
      logMessage(`åˆ›å»ºé¡¹ç›®: ${currentProject.name}`);

      // Create sample
      const sampleRes = await fetch(window.APP_URLS.API_SAMPLES, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...authHeaders() },
        body: JSON.stringify({
          project: currentProject.id,
          name: uploadedFiles[0].name.replace(/\.[^/.]+$/, ''),
          sample_type: 'single_cell'
        })
      });

      if (!sampleRes.ok) {
        throw new Error('åˆ›å»ºæ ·æœ¬å¤±è´¥');
      }

      currentSample = await sampleRes.json();
      logMessage(`åˆ›å»ºæ ·æœ¬: ${currentSample.name}`);
    }

    async function uploadDataFiles() {
      // Track detected 10X parts
      let tenxParts = { mtx: null, features: null, barcodes: null };
      let zipUploadedPath = null;
    
      for (const file of uploadedFiles) {
        let uploadSuccess = false;
        let presignData = null;
        
        try {
          // Try presigned URL first
          const presignRes = await fetch(window.APP_URLS.API_STORAGE_PRESIGN, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify({
              path: `samples/${currentSample.id}/${file.name}`,
              method: 'put',
              content_type: file.type || 'application/octet-stream'
            })
          });
      
          if (!presignRes.ok) {
            throw new Error(`è·å–ä¸Šä¼ é“¾æ¥å¤±è´¥: ${file.name}`);
          }
      
          presignData = await presignRes.json();
      
          // Try to upload to presigned URL
          const uploadRes = await fetch(presignData.url, {
            method: 'PUT',
            body: file,
            headers: {
              'Content-Type': file.type || 'application/octet-stream'
            }
          });
      
          if (uploadRes.ok) {
            uploadSuccess = true;
            logMessage(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ (presigned): ${file.name}`);
          } else {
            throw new Error(`Presigned upload failed: ${uploadRes.status}`);
          }
        } catch (error) {
          logMessage(`é¢„ç­¾åä¸Šä¼ å¤±è´¥ï¼Œå°è¯•ç›´ä¼ : ${error.message}`);
          
          // Fallback to direct server upload
          try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', `samples/${currentSample.id}/${file.name}`);
            
            const directRes = await fetch(window.APP_URLS.API_STORAGE_UPLOAD, {
              method: 'POST',
              headers: authHeaders(), // Don't set Content-Type for FormData
              body: formData
            });
            
            if (directRes.ok) {
              const directData = await directRes.json();
              presignData = { path: directData.path }; // Mimic presign response
              uploadSuccess = true;
              logMessage(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ (ç›´ä¼ ): ${file.name}`);
            } else {
              const errorData = await directRes.json().catch(() => ({}));
              throw new Error(errorData.detail || `ç›´ä¼ å¤±è´¥: ${directRes.status}`);
            }
          } catch (directError) {
            logMessage(`ç›´ä¼ ä¹Ÿå¤±è´¥: ${directError.message}`);
            throw new Error(`ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ${file.name} - ${directError.message}`);
          }
        }
        
        if (!uploadSuccess || !presignData) {
          throw new Error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${file.name}`);
        }
    
        // Detect 10X component by filename
        const lower = file.name.toLowerCase();
        if (lower.endsWith('.mtx') || lower.endsWith('matrix.mtx') || lower.endsWith('matrix.mtx.gz')) {
          tenxParts.mtx = presignData.path;
        } else if (lower.endsWith('features.tsv') || lower.endsWith('features.tsv.gz') || lower.endsWith('genes.tsv') || lower.endsWith('genes.tsv.gz')) {
          tenxParts.features = presignData.path;
        } else if (lower.endsWith('barcodes.tsv') || lower.endsWith('barcodes.tsv.gz')) {
          tenxParts.barcodes = presignData.path;
        } else if (lower.endsWith('.h5ad') || lower.endsWith('.h5')) {
          // Fall back: treat as h5ad input
          // Only set if no 10X parts are detected
          if (!tenxParts.mtx && !tenxParts.features && !tenxParts.barcodes) {
            // Update sample with file path (h5ad)
            const updateRes = await fetch(`${window.APP_URLS.API_SAMPLES}${currentSample.id}/`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', ...authHeaders() },
              body: JSON.stringify({ input_h5ad_path: presignData.path })
            });
            if (updateRes.ok) {
              currentSample = await updateRes.json();
            }
          }
        } else if (lower.endsWith('.zip')) {
          zipUploadedPath = presignData.path;
        }
      }
    
      // If a ZIP was uploaded, ask backend to extract and detect 10X files
      if (zipUploadedPath && (!tenxParts.mtx || !tenxParts.features || !tenxParts.barcodes)) {
        try {
          const res = await fetch(`${window.APP_URLS.API_STORAGE_BASE}/extract-zip-10x`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify({ zip_path: zipUploadedPath })
          });
          if (res.ok) {
            const data = await res.json();
            tenxParts.mtx = tenxParts.mtx || data.mtx;
            tenxParts.features = tenxParts.features || data.features;
            tenxParts.barcodes = tenxParts.barcodes || data.barcodes;
          } else {
            const err = await res.json().catch(() => ({}));
            logMessage(`ZIP è§£å‹è¯†åˆ«å¤±è´¥: ${err.detail || res.status}`);
          }
        } catch (e) {
          console.error(e);
          logMessage('ZIP è§£å‹è¯†åˆ«å¼‚å¸¸');
        }
      }
    
      // If 10X parts are detected, patch sample with these paths
      if (tenxParts.mtx && tenxParts.features && tenxParts.barcodes) {
        const updateRes = await fetch(`${window.APP_URLS.API_SAMPLES}${currentSample.id}/`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({
            input_mtx_path: tenxParts.mtx,
            input_features_path: tenxParts.features,
            input_barcodes_path: tenxParts.barcodes
          })
        });
        if (updateRes.ok) {
          currentSample = await updateRes.json();
          logMessage('å·²è¯†åˆ« 10X è¾“å…¥æ–‡ä»¶å¹¶æ›´æ–°æ ·æœ¬');
        }
      }
    }

    async function getStepId(stepType) {
      try {
        const res = await fetch(window.APP_URLS.API_STEPS, {
          headers: authHeaders()
        });
        
        if (res.ok) {
          const data = await res.json();
          const steps = data?.results || data || [];
          const step = steps.find(s => s.step_type === stepType);
          return step?.id || null;
        }
      } catch (error) {
        console.error('Get step ID error:', error);
      }
      return null;
    }

    // WebSocket connection
    function connectWebSocket(wsUrl) {
      if (wsConnection) {
        wsConnection.close();
      }

      wsConnection = new WebSocket(wsUrl);

      wsConnection.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
      };

      wsConnection.onclose = () => {
        logMessage('WebSocket è¿æ¥å·²å…³é—­');
      };

      wsConnection.onerror = (error) => {
        logMessage('WebSocket è¿æ¥é”™è¯¯');
        console.error('WebSocket error:', error);
      };
    }

    function handleWebSocketMessage(message) {
      logMessage(`[${message.phase}] ${message.message}`);

      // Update metrics if available
      if (message.metrics) {
        updateMetrics(message.metrics);
      }

      // Handle phase completion
      if (message.phase === 'DONE' || message.phase === 'COMPLETED') {
        updateStepStatus(currentStep, 'completed');
        
        // Enable next step
        const steps = ['upload', 'qc', 'hvg', 'pca', 'umap', 'clustering'];
        const currentIndex = steps.indexOf(currentStep);
        if (currentIndex < steps.length - 1) {
          const nextStep = steps[currentIndex + 1];
          enableNextStep(nextStep);
          logMessage(`${currentStep} åˆ†æå®Œæˆï¼Œå¯ä»¥è¿›è¡Œ ${nextStep} åˆ†æ`);
        } else {
          logMessage('æ‰€æœ‰åˆ†ææ­¥éª¤å·²å®Œæˆï¼');
        }

        // Load advice if available
        loadAdvice();
      } else if (message.phase === 'FAILED') {
        updateStepStatus(currentStep, 'pending');
        logMessage(`åˆ†æå¤±è´¥: ${message.message}`);
      }
    }

    function updateMetrics(metrics) {
      if (metrics.cells !== undefined) {
        document.getElementById('metric_cells').textContent = metrics.cells.toLocaleString();
      }
      if (metrics.genes !== undefined) {
        document.getElementById('metric_genes').textContent = metrics.genes.toLocaleString();
      }
      if (metrics.doublet_rate !== undefined) {
        document.getElementById('metric_doublets').textContent = (metrics.doublet_rate * 100).toFixed(1) + '%';
      }
      if (metrics.high_mito !== undefined) {
        document.getElementById('metric_mito').textContent = (metrics.high_mito * 100).toFixed(1) + '%';
      }
    }

    async function loadAdvice() {
      const currentRun = stepRuns[currentStep];
      if (!currentRun) return;

      try {
        const res = await fetch(`${window.APP_URLS.API_STEP_RUNS}${currentRun.id}/advice/`, {
          headers: authHeaders()
        });

        if (res.ok) {
          const advice = await res.json();
          displayAdvice(advice);
        }
      } catch (error) {
        console.error('Load advice error:', error);
      }
    }

    function displayAdvice(adviceList) {
      const container = document.getElementById('advice_content');
      
      if (!adviceList || adviceList.length === 0) {
        container.innerHTML = '<div style="color:var(--muted); text-align:center; padding:40px 20px;">æš‚æ— ä¼˜åŒ–å»ºè®®</div>';
        return;
      }

      container.innerHTML = adviceList.map(advice => `
        <div style="background:rgba(255,255,255,0.04); border-radius:8px; padding:16px; margin-bottom:12px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <strong>${advice.title}</strong>
            <span style="font-size:12px; padding:2px 6px; border-radius:4px; background:${advice.risk_level === 'high' ? 'var(--err)' : advice.risk_level === 'medium' ? 'var(--warn)' : 'var(--ok)'}; color:white;">
              ${advice.risk_level}
            </span>
          </div>
          <div style="color:var(--muted); font-size:14px; margin-bottom:12px;">${advice.description}</div>
          <div style="display:flex; gap:8px;">
            <button class="btn small accent" onclick="applyAdvice('${advice.id}')">åº”ç”¨å»ºè®®</button>
            <button class="btn small" onclick="dismissAdvice('${advice.id}')">å¿½ç•¥</button>
          </div>
        </div>
      `).join('');
    }

    async function applyAdvice(adviceId) {
      try {
        const res = await fetch(`/api/v1/core/advice/${adviceId}/apply/`, {
          method: 'POST',
          headers: authHeaders()
        });

        if (res.ok) {
          logMessage('AI å»ºè®®å·²åº”ç”¨');
          loadAdvice(); // Refresh advice list
        }
      } catch (error) {
        console.error('Apply advice error:', error);
        alert('åº”ç”¨å»ºè®®å¤±è´¥');
      }
    }

    async function dismissAdvice(adviceId) {
      // This would typically mark the advice as dismissed
      logMessage('AI å»ºè®®å·²å¿½ç•¥');
      loadAdvice(); // Refresh advice list
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      document.getElementById(`tab_${tabName}`).classList.add('active');
    }

    // Drag and drop
    function setupDragAndDrop() {
      const uploadArea = document.querySelector('.upload-area');
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        files.forEach(file => {
          if (!uploadedFiles.find(f => f.name === file.name)) {
            uploadedFiles.push(file);
          }
        });
        
        updateFileList();
        updateStepStatus('upload', 'completed');
        enableNextStep('qc');
      });
    }

    // Initialize
    async function init() {
      setupDragAndDrop();
      updateUserDisplay();
      updateWorkflowHeader();
      loadStepParameters();
      
      // Check if user is already logged in
      await checkLoginStatus();
      
      // Auto-login if demo mode
      if (window.location.search.includes('demo=1')) {
        setTimeout(demoLogin, 500);
      }
    }

    // Check current login status on page load
    async function checkLoginStatus() {
      try {
        const res = await fetch('/api/v1/users/users/me/', {
          headers: authHeaders()
        });
        
        if (res.ok) {
          currentUser = await res.json();
          updateUserDisplay();
          await loadOrganizations();
          await ensureDefaultSteps();
          logMessage('å·²æ¢å¤ç™»å½•çŠ¶æ€');
        } else {
          // Not logged in, keep current state
          logMessage('å½“å‰æœªç™»å½•');
        }
      } catch (error) {
        console.error('Check login status error:', error);
        // Silently handle error - user is not logged in
      }
    }

    // Start the application
    init();
  </script>
{% endblock %}