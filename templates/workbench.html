{% extends 'base.html' %}
{% load i18n %}

{% block title %}CellInsightAI {% trans "工作台" %}{% endblock %}

{% block extra_js %}
<!-- JavaScript i18n catalog -->
<script src="{% url 'javascript-catalog' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
    /* Main Layout */
    .main-container { display:grid; grid-template-columns:340px 1fr; height:calc(100vh - 65px); }
    
    /* Sidebar */
    .sidebar { 
      background:var(--panel); border-right:1px solid var(--border); overflow-y:auto; 
      display:flex; flex-direction:column;
    }
    .sidebar-section { padding:20px; border-bottom:1px solid var(--border); }
    .sidebar-section:last-child { border-bottom:none; flex:1; }
    .section-title { font-size:14px; font-weight:600; margin:0 0 16px 0; color:#bcd1ff; }
    
    /* Upload Section */
    .upload-area { 
      border:2px dashed rgba(255,255,255,0.2); border-radius:12px; padding:24px; text-align:center; 
      cursor:pointer; transition:all 0.2s;
    }
    .upload-area:hover, .upload-area.dragover { border-color:var(--accent); background:rgba(79,141,245,0.05); }
    .upload-icon { font-size:32px; margin-bottom:12px; opacity:0.6; }
    .upload-text { margin:8px 0; }
    .upload-hint { font-size:12px; color:var(--muted); }
    .file-list { margin-top:16px; }
    .file-item { 
      display:flex; align-items:center; justify-content:space-between; padding:8px 12px; 
      background:rgba(255,255,255,0.04); border-radius:6px; margin-bottom:8px;
    }
    .file-item .name { font-size:14px; }
    .file-item .size { font-size:12px; color:var(--muted); }
    
    /* Steps Section */
    .steps-container { max-height:400px; overflow-y:auto; }
    .step-item { 
      display:flex; align-items:center; padding:12px; border-radius:8px; margin-bottom:8px; 
      background:rgba(255,255,255,0.02); cursor:pointer; transition:all 0.2s;
    }
    .step-item:hover { background:rgba(255,255,255,0.06); }
    .step-item.active { background:var(--accent); color:white; }
    .step-item.completed { background:rgba(49,196,141,0.1); border:1px solid rgba(49,196,141,0.3); }
    .step-number { 
      width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,0.1); 
      display:flex; align-items:center; justify-content:center; font-size:12px; margin-right:12px;
    }
    .step-item.active .step-number { background:white; color:var(--accent); }
    .step-item.completed .step-number { background:var(--ok); color:white; }
    .step-info { flex:1; }
    .step-name { font-size:14px; font-weight:500; margin:0; }
    .step-desc { font-size:12px; color:var(--muted); margin:2px 0 0 0; }
    .step-status { font-size:11px; padding:2px 6px; border-radius:4px; }
    .step-status.pending { background:rgba(245,158,11,0.2); color:#f59e0b; }
    .step-status.running { background:rgba(79,141,245,0.2); color:var(--accent); }
    .step-status.completed { background:rgba(49,196,141,0.2); color:var(--ok); }
    
    /* Main Content */
    .content { display:flex; flex-direction:column; overflow:hidden; }
    
    /* Workflow Header */
    .workflow-header { 
      padding:20px 24px; border-bottom:1px solid var(--border); background:var(--panel);
      display:flex; align-items:center; justify-content:space-between;
    }
    .workflow-title { font-size:20px; font-weight:600; margin:0; }
    .workflow-actions { display:flex; gap:12px; }
    
    /* Enhanced Button Styles for Dark Theme */
    .workflow-actions .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    /* Reset Workflow Button - Secondary Style */
    .workflow-actions .btn:first-child {
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.15);
    }
    
    .workflow-actions .btn:first-child:hover:not(:disabled) {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.25);
      color: var(--text);
      box-shadow: 0 2px 8px rgba(255,255,255,0.1);
    }
    
    /* Start Analysis Button - Primary Style */
    .workflow-actions .btn:last-child {
      background: var(--accent);
      color: white;
      border: 1px solid var(--accent);
      box-shadow: 0 2px 8px rgba(79,141,245,0.3);
    }
    
    .workflow-actions .btn:last-child:hover:not(:disabled) {
      background: #3b7ce6;
      border-color: #3b7ce6;
      box-shadow: 0 4px 12px rgba(79,141,245,0.4);
      transform: translateY(-1px);
    }
    
    .workflow-actions .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255,255,255,0.04) !important;
      color: var(--muted) !important;
      border-color: rgba(255,255,255,0.08) !important;
      box-shadow: none !important;
      transform: none !important;
    }
    
    /* Light theme adjustments */
    [data-theme="light"] .workflow-actions .btn:first-child {
      background: rgba(0,0,0,0.06);
      color: var(--text);
      border: 1px solid rgba(0,0,0,0.12);
    }
    
    [data-theme="light"] .workflow-actions .btn:first-child:hover:not(:disabled) {
      background: rgba(0,0,0,0.08);
      border-color: rgba(0,0,0,0.18);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    [data-theme="light"] .workflow-actions .btn:disabled {
      background: rgba(0,0,0,0.04) !important;
      color: var(--muted) !important;
      border-color: rgba(0,0,0,0.08) !important;
    }
    
    /* Tabs */
    .tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel); }
    .tab { 
      padding:12px 20px; cursor:pointer; border-bottom:2px solid transparent; 
      transition:all 0.2s; font-size:14px;
    }
    .tab:hover { background:var(--hover); }
    .tab.active { border-bottom-color:var(--accent); color:var(--accent); }
    
    /* Tab Content */
    .tab-content { flex:1; overflow:auto; }
    .tab-pane { display:none; padding:24px; height:100%; }
    .tab-pane.active { display:block; }
    
    /* Parameters Panel */
    .params-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; }
    .param-group { 
      background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:16px;
    }
    .param-group h3 { font-size:14px; margin:0 0 12px 0; color:#bcd1ff; }
    .param-row { margin-bottom:12px; }
    .param-row:last-child { margin-bottom:0; }
    .param-label { display:block; font-size:13px; color:#bcd1ff; margin-bottom:6px; }
    .param-input { width:100%; }
    
    /* Results Panel */
    .results-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; height:100%; }
    .result-panel { 
      background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; 
      display:flex; flex-direction:column;
    }
    .panel-header { padding:16px; border-bottom:1px solid var(--border); font-weight:600; }
    .panel-content { flex:1; padding:16px; overflow:auto; }
    .chart-placeholder { 
      height:300px; background:rgba(255,255,255,0.02); border-radius:8px; 
      display:flex; align-items:center; justify-content:center; color:var(--muted);
    }
    
    /* Metrics */
    .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px; }
    .metric-card { 
      background:rgba(255,255,255,0.04); border-radius:8px; padding:12px; text-align:center;
    }
    .metric-value { font-size:20px; font-weight:600; margin-bottom:4px; }
    .metric-label { font-size:12px; color:var(--muted); }
    .metric-card.ok .metric-value { color:var(--ok); }
    .metric-card.warn .metric-value { color:var(--warn); }
    .metric-card.err .metric-value { color:var(--err); }
    
    /* Log */
    .log-container { 
      background:#0a1120; border:1px solid var(--border); border-radius:8px; 
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; 
      height:200px; overflow:auto; padding:12px; font-size:12px; color:#a7b6d9;
    }
    
    /* History */
    .history-list { max-height:300px; overflow-y:auto; }
    .history-item { 
      display:flex; align-items:center; justify-content:space-between; padding:8px 12px; 
      background:rgba(255,255,255,0.02); border-radius:6px; margin-bottom:8px; font-size:13px;
    }
    .history-item:hover { background:rgba(255,255,255,0.06); }
    .run-id { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; color:var(--muted); }
    
    /* Login Modal */
    .modal { 
      position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); 
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal.hidden { display:none; }
    .modal-content { 
      background:var(--panel); border:1px solid var(--border); border-radius:12px; 
      padding:24px; width:400px; max-width:90vw;
    }
    .modal-title { font-size:18px; margin:0 0 20px 0; }
    .modal-row { margin-bottom:16px; }
    .modal-row:last-child { margin-bottom:0; }
    .modal-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:20px; }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .main-container { grid-template-columns:280px 1fr; }
      .params-grid { grid-template-columns:1fr; }
      .results-grid { grid-template-columns:1fr; }
    }
    
    @media (max-width: 768px) {
      header { padding:12px; flex-wrap:wrap; }
      nav { order:3; width:100%; margin-top:12px; justify-content:center; }
      nav a { font-size:12px; padding:6px 8px; }
      .user-info { gap:8px; }
      .main-container { grid-template-columns:1fr; }
      .sidebar { position:fixed; left:-100%; top:105px; bottom:0; width:280px; z-index:99; transition:left 0.3s; }
      .sidebar.open { left:0; }
      .content { grid-column:1; }
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Organization Selector for Workbench -->
  <div style="background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <label style="font-size:14px;color:var(--muted);margin-right:8px;">{% trans "当前组织:" %}</label>
      <select id="org_select" style="min-width:200px;" onchange="onOrgChange()">
        <option value="">{% trans "选择组织..." %}</option>
      </select>
    </div>
    <div id="user_profile" style="display:none;">
      <span id="user_name">{% trans "未登录" %}</span>
      <button class="login-btn" onclick="showLoginModal()" style="margin-left:12px;padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">{% trans "点击登录" %}</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Upload Section -->
      <div class="sidebar-section">
        <h2 class="section-title">📁 {% trans "数据上传" %}</h2>
        <div class="upload-area" onclick="document.getElementById('file_input').click()">
          <div class="upload-icon">📤</div>
          <div class="upload-text">{% trans "点击或拖拽上传数据文件" %}</div>
          <div class="upload-hint">{% trans "支持 .h5ad, .h5, .csv, .mtx, .zip 等格式" %}</div>
          <input type="file" id="file_input" style="display:none" multiple 
                 accept=".h5ad,.h5,.csv,.mtx,.tsv,.txt,.gz,.zip" onchange="handleFileSelect(event)">
        </div>
        <div class="file-list" id="file_list"></div>
      </div>

      <!-- Analysis Steps -->
      <div class="sidebar-section">
        <h2 class="section-title">🔬 {% trans "分析步骤" %}</h2>
        <div class="steps-container" id="steps_container">
          <div class="step-item" data-step="upload">
            <div class="step-number">1</div>
            <div class="step-info">
              <div class="step-name">{% trans "数据上传" %}</div>
              <div class="step-desc">{% trans "上传原始数据文件" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="qc">
            <div class="step-number">2</div>
            <div class="step-info">
              <div class="step-name">{% trans "质量控制" %}</div>
              <div class="step-desc">{% trans "过滤低质量细胞和基因" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="hvg">
            <div class="step-number">3</div>
            <div class="step-info">
              <div class="step-name">{% trans "高变基因" %}</div>
              <div class="step-desc">{% trans "识别高变异基因" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="pca">
            <div class="step-number">4</div>
            <div class="step-info">
              <div class="step-name">{% trans "主成分分析" %}</div>
              <div class="step-desc">{% trans "降维处理" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="umap">
            <div class="step-number">5</div>
            <div class="step-info">
              <div class="step-name">{% trans "UMAP嵌入" %}</div>
              <div class="step-desc">{% trans "2D可视化" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="clustering">
            <div class="step-number">6</div>
            <div class="step-info">
              <div class="step-name">{% trans "细胞聚类" %}</div>
              <div class="step-desc">{% trans "识别细胞类型" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="sidebar-section">
        <h2 class="section-title">📊 {% trans "运行历史" %}</h2>
        <div class="history-list" id="history_list">
          <div style="text-align:center; color:var(--muted); padding:20px;">{% trans "暂无运行记录" %}</div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Workflow Header -->
      <div class="workflow-header">
        <h1 class="workflow-title" id="workflow_title">{% trans "准备开始分析" %}</h1>
        <div class="workflow-actions">
          <button class="btn" onclick="resetWorkflow()">{% trans "重置流程" %}</button>
          <button class="btn" id="run_btn" onclick="runCurrentStep()" disabled>{% trans "开始分析" %}</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('params')">{% trans "参数配置" %}</div>
        <div class="tab" onclick="switchTab('results')">{% trans "结果展示" %}</div>
        <div class="tab" onclick="switchTab('logs')">{% trans "运行日志" %}</div>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Parameters Tab -->
        <div class="tab-pane active" id="tab_params">
          <div class="params-grid" id="params_grid">
            <div class="param-group">
              <h3>👋 {% trans "欢迎使用 CellInsightAI" %}</h3>
              <p style="color:var(--muted); line-height:1.6;">
                {% trans "请先上传您的单细胞数据文件，然后按照左侧的分析步骤进行配置和运行。" %}
                {% trans "系统将自动引导您完成质量控制、降维、聚类等标准分析流程。" %}
              </p>
            </div>
          </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-pane" id="tab_results">
          <div class="results-grid">
            <div class="result-panel">
              <div class="panel-header">📊 {% trans "关键指标" %}</div>
              <div class="panel-content">
                <div class="metrics-grid" id="metrics_grid">
                  <div class="metric-card">
                    <div class="metric-value" id="metric_cells">-</div>
                    <div class="metric-label">{% trans "细胞数" %}</div>
                  </div>
                  <div class="metric-card">
                    <div class="metric-value" id="metric_genes">-</div>
                    <div class="metric-label">{% trans "基因数" %}</div>
                  </div>
                  <div class="metric-card warn">
                    <div class="metric-value" id="metric_doublets">-</div>
                    <div class="metric-label">{% trans "双细胞率" %}</div>
                  </div>
                  <div class="metric-card err">
                    <div class="metric-value" id="metric_mito">-</div>
                    <div class="metric-label">{% trans "线粒体比例" %}</div>
                  </div>
                </div>
                <div class="chart-placeholder">
                  {% trans "分析完成后将显示 UMAP 图表" %}
                </div>
              </div>
            </div>
            <div class="result-panel">
              <div class="panel-header">🤖 {% trans "AI 建议" %}</div>
              <div class="panel-content">
                <div id="advice_content" style="color:var(--muted); text-align:center; padding:40px 20px;">
                  {% trans "运行分析后将显示 AI 优化建议" %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div class="tab-pane" id="tab_logs">
          <div class="log-container" id="log_container">
            <div style="color:var(--muted);">[{% trans "系统" %}] {% trans "等待开始分析..." %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal hidden" id="login_modal">
    <div class="modal-content">
      <h2 class="modal-title">{% trans "登录 CellInsightAI" %}</h2>
      <div class="modal-row">
        <label class="param-label">{% trans "邮箱或用户名" %}</label>
        <input type="text" id="login_email" class="param-input" placeholder="your@email.com">
      </div>
      <div class="modal-row">
        <label class="param-label">{% trans "密码" %}</label>
        <input type="password" id="login_password" class="param-input" placeholder="••••••••">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="hideLoginModal()">{% trans "取消" %}</button>
        <button class="btn" onclick="demoLogin()">{% trans "Demo 登录" %}</button>
        <button class="btn accent" onclick="doLogin()">{% trans "登录" %}</button>
      </div>
    </div>
  </div>

  <script id="app-urls" type="application/json">{{ APP_URLS_JSON|safe }}</script>
  
  <!-- Django JavaScript Catalog for i18n -->
  <script type="text/javascript" src="{% url 'javascript-catalog' %}"></script>
  
  <script>
    // 解析 APP_URLS
    try {
      window.APP_URLS = JSON.parse(document.getElementById('app-urls').textContent || '{}');
    } catch (e) {
      window.APP_URLS = {};
      console.error('Failed to parse APP_URLS JSON', e);
    }

    // Global state
    let currentUser = null;
    let currentOrg = localStorage.getItem('active_org') || null;
    let currentStep = 'upload';
    let uploadedFiles = [];
    let currentProject = null;
    let currentSample = null;
    let wsConnection = null;
    let stepRuns = {};

    // Utility functions
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }

    function getCsrfToken() {
      return getCookie('csrftoken') || '';
    }

    function authHeaders(extra = {}) {
      const h = { 'X-CSRFToken': getCsrfToken() };
      if (currentOrg) h['X-Org'] = currentOrg;
      return Object.assign(h, extra);
    }

    function logMessage(message) {
      const container = document.getElementById('log_container');
      const timestamp = new Date().toLocaleTimeString();
      container.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      container.scrollTop = container.scrollHeight;
    }

    // Modal functions
    function showLoginModal() {
      document.getElementById('login_modal').classList.remove('hidden');
    }

    function hideLoginModal() {
      document.getElementById('login_modal').classList.add('hidden');
    }

    // Authentication
    async function doLogin() {
      const email = document.getElementById('login_email').value.trim();
      const password = document.getElementById('login_password').value;
      
      if (!email || !password) {
        alert(gettext('请填写邮箱和密码'));
        return;
      }

      try {
        const res = await fetch(`${window.APP_URLS.API_USERS_BASE}/login/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          alert(gettext('登录失败，请检查邮箱和密码'));
          return;
        }

        const userData = await res.json();
        currentUser = userData;
        updateUserDisplay();
        hideLoginModal();
        await loadOrganizations();
        logMessage(gettext('登录成功'));
      } catch (error) {
        console.error('Login error:', error);
        alert(gettext('登录过程中出现错误'));
      }
    }

    async function demoLogin() {
      try {
        const res = await fetch(window.APP_URLS.API_DEMO_LOGIN, {
          method: 'POST',
          headers: authHeaders()
        });

        if (!res.ok) {
          alert(gettext('Demo 登录失败'));
          return;
        }

        // Get user info
        const meRes = await fetch(window.APP_URLS.API_USER_ME, {
          headers: authHeaders()
        });

        if (meRes.ok) {
          const userData = await meRes.json();
          currentUser = userData;
          updateUserDisplay();
          await loadOrganizations();
          logMessage(gettext('Demo 登录成功'));
        } else {
          alert(gettext('Demo 登录过程中出现错误'));
        }
      } catch (error) {
        console.error('Demo login error:', error);
        alert(gettext('Demo 登录过程中出现错误'));
      }
    }

    // User display update
    function updateUserDisplay() {
      const userProfile = document.getElementById('user_profile');
      const userName = document.getElementById('user_name');
      const orgSelectContainer = document.getElementById('org_select') ? document.getElementById('org_select').parentElement : null;

      if (currentUser) {
        userName.textContent = currentUser.username || currentUser.email || gettext('用户');
        if (userProfile) userProfile.style.display = 'block';
        if (orgSelectContainer) orgSelectContainer.style.display = '';
      } else {
        userName.textContent = gettext('当前未登录');
        if (userProfile) userProfile.style.display = 'block';
        if (orgSelectContainer) orgSelectContainer.style.display = 'none';
      }
    }

    // Load organizations for current user and set the select options
    async function loadOrganizations() {
      if (!currentUser) return;
      try {
        const url = (window.APP_URLS && (window.APP_URLS.API_ORGS || window.APP_URLS.API_ORGANIZATIONS)) || '/api/v1/users/organizations/';
        const headers = authHeaders();
        const res = await fetch(url, { headers });
        if (!res.ok) return;
        const data = await res.json();
        const orgs = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
        const select = document.getElementById('org_select');
        if (!select) return;
        select.innerHTML = '<option value="">' + gettext('选择组织...') + '</option>';
    
        let selected = currentOrg;
        // If user has profile with organization, prefer that
        if ((!selected || selected === '') && currentUser && currentUser.profile && currentUser.profile.organization) {
          selected = currentUser.profile.organization.id || currentUser.profile.organization; // id could be string
        }
        // Fallback from localStorage
        if ((!selected || selected === '') && window.localStorage) {
          selected = localStorage.getItem('active_org') || '';
        }
    
        orgs.forEach(org => {
          const option = document.createElement('option');
          option.value = org.id;
          option.textContent = org.name;
          select.appendChild(option);
        });
    
        if (selected) {
          select.value = selected;
          currentOrg = selected;
        }
      } catch (e) {
        console.error('Failed to load organizations:', e);
      }
    }

    function onOrgChange() {
      const select = document.getElementById('org_select');
      if (!select) return;
      currentOrg = select.value;
      if (window.localStorage) {
        if (currentOrg) localStorage.setItem('active_org', currentOrg);
        else localStorage.removeItem('active_org');
      }
      if (currentOrg) {
        logMessage(gettext('切换到组织:') + ' ' + (select.options[select.selectedIndex]?.text || ''));
      }
    }

    // Update authHeaders to include X-Org from currentOrg
    function authHeaders(extra = {}) {
      const h = { 'X-CSRFToken': getCsrfToken() };
      if (currentOrg) h['X-Org'] = currentOrg;
      return Object.assign(h, extra);
    }

    // After login or demo login, call loadOrganizations and set UI
    function resetWorkflow() {
      if (confirm(gettext('确定要重置工作流程吗？'))) {
        currentStep = 'upload';
        uploadedFiles = [];
        stepRuns = {};
        
        // Reset UI
        document.getElementById('workflow_title').textContent = gettext('准备开始分析');
        document.getElementById('file_list').innerHTML = '';
        document.getElementById('run_btn').disabled = true;
        
        // Reset steps
        document.querySelectorAll('.step-item').forEach(item => {
          item.classList.remove('active', 'completed');
          item.querySelector('.step-status').textContent = gettext('待处理');
          item.querySelector('.step-status').className = 'step-status pending';
        });
        
        logMessage(gettext('工作流程已重置'));
      }
    }

    function runCurrentStep() {
      if (!currentOrg) {
        alert(gettext('请选择组织'));
        return;
      }
      
      logMessage(gettext('开始运行步骤:') + ' ' + currentStep);
      // Additional implementation would go here
    }

    // File handling
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      uploadedFiles = uploadedFiles.concat(files);
      
      const fileList = document.getElementById('file_list');
      fileList.innerHTML = '';
      
      uploadedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <div>
            <div class="name">${file.name}</div>
            <div class="size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
          </div>
          <button onclick="removeFile(${index})" style="background:none; border:none; color:var(--err); cursor:pointer;">✕</button>
        `;
        fileList.appendChild(fileItem);
      });
      
      if (uploadedFiles.length > 0) {
        document.getElementById('run_btn').disabled = false;
        logMessage(gettext('文件上传完成，可以开始分析'));
      }
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      handleFileSelect({ target: { files: uploadedFiles } });
      
      if (uploadedFiles.length === 0) {
        document.getElementById('run_btn').disabled = true;
      }
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById('tab_' + tabName).classList.add('active');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateUserDisplay();
      
      // Also sync current user and org from backend
      fetchCurrentUser();
      
      // Set up drag and drop
      const uploadArea = document.querySelector('.upload-area');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        document.getElementById('file_input').files = e.dataTransfer.files;
        handleFileSelect({ target: { files } });
      });
    });
  </script>
{% endblock %}