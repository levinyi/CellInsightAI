{% extends 'base.html' %}
{% load i18n %}

{% block title %}CellInsightAI {% trans "工作台" %}{% endblock %}

{% block extra_js %}
<!-- JavaScript i18n catalog -->
<script src="{% url 'javascript-catalog' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
  /* Main Layout */
  .main-container { display:grid; grid-template-columns:340px 1fr; height:calc(100vh - 105px); }

  /* Project Context Bar */
  .project-context {
    background:var(--panel); border-bottom:1px solid var(--border); padding:12px 24px;
    display:flex; align-items:center; justify-content:space-between; font-size:14px;
  }
  .project-info { display:flex; align-items:center; gap:12px; }
  .project-label { color:var(--muted); }
  .project-name {
    font-weight:600; color:var(--accent); cursor:pointer;
    text-decoration:underline; text-underline-offset:2px;
  }
  .project-name:hover { opacity:0.8; }
  .project-actions { display:flex; align-items:center; gap:8px; }
  .project-select {
    min-width:200px; background:var(--bg); border:1px solid var(--border);
    color:var(--text); border-radius:6px; padding:6px 12px;
  }

  /* Sidebar */
  .sidebar {
    background:var(--panel); border-right:1px solid var(--border); overflow-y:auto;
    display:flex; flex-direction:column;
  }
  .sidebar-section { padding:20px; border-bottom:1px solid var(--border); }
  .sidebar-section:last-child { border-bottom:none; flex:1; }
  .section-title { font-size:14px; font-weight:600; margin:0 0 16px 0; color:#bcd1ff; }

  /* Steps Section */
  .steps-container { max-height:400px; overflow-y:auto; }
  .step-item {
    display:flex; align-items:center; padding:12px; border-radius:8px; margin-bottom:8px;
    background:rgba(255,255,255,0.02); cursor:pointer; transition:all 0.2s;
  }
  .step-item:hover { background:rgba(255,255,255,0.06); }
  .step-item.active { background:var(--accent); color:white; }
  .step-item.completed { background:rgba(49,196,141,0.1); border:1px solid rgba(49,196,141,0.3); }
  .step-number {
    width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,0.1);
    display:flex; align-items:center; justify-content:center; font-size:12px; margin-right:12px;
  }
  .step-item.active .step-number { background:white; color:var(--accent); }
  .step-item.completed .step-number { background:var(--ok); color:white; }
  .step-info { flex:1; }
  .step-name { font-size:14px; font-weight:500; margin:0; }
  .step-desc { font-size:12px; color:var(--muted); margin:2px 0 0 0; }
  .step-status { font-size:11px; padding:2px 6px; border-radius:4px; }
  .step-status.pending { background:rgba(245,158,11,0.2); color:#f59e0b; }
  .step-status.running { background:rgba(79,141,245,0.2); color:var(--accent); }
  .step-status.completed { background:rgba(49,196,141,0.2); color:var(--ok); }
  .step-status.failed { background:rgba(244,63,94,0.2); color:#f43f5e; }

  /* Continue Analysis Section */
  .continue-section {
    background:rgba(79,141,245,0.1); border:1px solid rgba(79,141,245,0.3);
    border-radius:8px; padding:16px; margin-bottom:16px;
  }
  .continue-title {
    font-size:14px; font-weight:600; margin:0 0 12px 0; color:var(--accent);
    display:flex; align-items:center; gap:6px;
  }
  .continue-list { max-height:200px; overflow-y:auto; }
  .continue-item {
    background:rgba(255,255,255,0.04); border-radius:6px; padding:10px; margin-bottom:8px;
    cursor:pointer; transition:all 0.2s; display:flex; justify-content:space-between; align-items:center;
  }
  .continue-item:hover { background:rgba(255,255,255,0.08); }
  .continue-info { flex:1; }
  .continue-name { font-size:13px; font-weight:500; margin:0 0 2px 0; }
  .continue-meta { font-size:11px; color:var(--muted); }
  .continue-actions { display:flex; gap:6px; align-items:center; }
  .continue-btn {
    padding:4px 8px; background:var(--accent); color:white; border:none;
    border-radius:4px; font-size:11px; cursor:pointer;
  }
  .continue-btn:hover { background:#3b7ce6; }
  .delete-btn {
    padding:4px 8px; background:var(--err); color:white; border:none;
    border-radius:4px; font-size:11px; cursor:pointer;
  }
  .delete-btn:hover { background:#d93025; }

  /* Main Content */
  .content { display:flex; flex-direction:column; overflow:hidden; }

  /* Workflow Header */
  .workflow-header {
    padding:20px 24px; border-bottom:1px solid var(--border); background:var(--panel);
    display:flex; align-items:center; justify-content:space-between;
  }
  .workflow-title { font-size:20px; font-weight:600; margin:0; }
  .workflow-actions { display:flex; gap:12px; }

  .btn {
    padding:10px 20px; border-radius:8px; font-size:14px; font-weight:500;
    border:1px solid transparent; cursor:pointer; transition:all 0.2s ease;
  }
  .btn.primary { background:var(--accent); color:white; border:1px solid var(--accent); box-shadow:0 2px 8px rgba(79,141,245,0.3); }
  .btn.primary:hover:not(:disabled) { background:#3b7ce6; border-color:#3b7ce6; box-shadow:0 4px 12px rgba(79,141,245,0.4); transform:translateY(-1px); }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* Tabs */
  .tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel); }
  .tab { padding:12px 20px; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; font-size:14px; }
  .tab:hover { background:var(--hover); }
  .tab.active { border-bottom-color:var(--accent); color:var(--accent); }

  /* Tab Content */
  .tab-content { flex:1; overflow:auto; }
  .tab-pane { display:none; padding:24px; height:100%; }
  .tab-pane.active { display:block; }

  /* Parameters Panel */
  .params-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; }
  .param-group {
    background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:16px;
  }
  .param-group h3 { font-size:14px; margin:0 0 12px 0; color:#bcd1ff; }
  .param-row { margin-bottom:12px; }
  .param-row:last-child { margin-bottom:0; }
  .param-label { display:block; font-size:13px; color:#bcd1ff; margin-bottom:6px; }
  .param-input { width:100%; }

  /* Upload (big panel) */
  .upload-area {
    border:2px dashed rgba(255,255,255,0.2); border-radius:12px; padding:28px; text-align:center;
    cursor:pointer; transition:all 0.2s;
  }
  .upload-area:hover, .upload-area.dragover { border-color:var(--accent); background:rgba(79,141,245,0.05); }
  .upload-icon { font-size:36px; margin-bottom:12px; opacity:0.6; }
  .upload-text { margin:8px 0; }
  .upload-hint { font-size:12px; color:var(--muted); }
  .file-list { margin-top:16px; }
  .file-item {
    display:flex; align-items:center; justify-content:space-between; padding:8px 12px;
    background:rgba(255,255,255,0.04); border-radius:6px; margin-bottom:8px;
  }
  .file-item .name { font-size:14px; }
  .file-item .size { font-size:12px; color:var(--muted); }

  /* Results Panel */
  .results-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; height:100%; }
  .result-panel {
    background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px;
    display:flex; flex-direction:column;
  }
  .panel-header { padding:16px; border-bottom:1px solid var(--border); font-weight:600; }
  .panel-content { flex:1; padding:16px; overflow:auto; }
  .chart-placeholder {
    height:300px; background:rgba(255,255,255,0.02); border-radius:8px;
    display:flex; align-items:center; justify-content:center; color:var(--muted);
  }

  /* Artifact files list */
  .artifact-files { margin-top: 12px; }
  .artifact-item {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 12px; border:1px solid var(--border); border-radius:6px;
    background:rgba(255,255,255,0.02); margin-bottom:8px;
  }
  .artifact-item .name { font-size:14px; font-weight:500; }
  .artifact-item .meta { font-size:12px; color:var(--muted); }

  /* Metrics */
  .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px; }
  .metric-card { background:rgba(255,255,255,0.04); border-radius:8px; padding:12px; text-align:center; }
  .metric-value { font-size:20px; font-weight:600; margin-bottom:4px; }
  .metric-label { font-size:12px; color:var(--muted); }
  .metric-card.ok .metric-value { color:var(--ok); }
  .metric-card.warn .metric-value { color:var(--warn); }
  .metric-card.err .metric-value { color:var(--err); }

  /* Log */
  .log-container {
    background:#0a1120; border:1px solid var(--border); border-radius:8px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    height:200px; overflow:auto; padding:12px; font-size:12px; color:#a7b6d9;
  }

  /* Project Selection Modal (占位，当前用 prompt 简化) */
  .project-selection-overlay { display:none; }
</style>
{% endblock %}

{% block content %}
  <!-- Organization Selector -->
  <div style="background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <label style="font-size:14px;color:var(--muted);margin-right:8px;">{% trans "当前组织:" %}</label>
      <select id="org_select" style="min-width:200px;" onchange="onOrgChange()">
        <option value="">{% trans "选择组织..." %}</option>
      </select>
    </div>
    <div id="user_profile" style="display:none;">
      <span id="user_name">{% trans "未登录" %}</span>
      <button class="login-btn" onclick="showLoginModal()" style="margin-left:12px;padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">{% trans "点击登录" %}</button>
    </div>
  </div>

  <!-- Project Context Bar -->
  <div class="project-context">
    <div class="project-info">
      <span class="project-label">{% trans "当前项目:" %}</span>
      <span class="project-name" id="current_project_name" onclick="showProjectSelector()">{% trans "未选择项目" %}</span>
    </div>
    <div class="project-actions">
      <select class="project-select" id="project_quick_select" onchange="onProjectQuickChange()" style="display:none;">
        <option value="">{% trans "切换项目..." %}</option>
      </select>
      <a href="{{ APP_URLS.PROJECTS }}" style="color:var(--muted);text-decoration:none;font-size:13px;">{% trans "📁 项目管理" %}</a>
    </div>
  </div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Continue Analysis -->
      <div class="sidebar-section" id="continue_section" style="display:none;">
        <div class="continue-section">
          <div class="continue-title">
            🔄 {% trans "继续分析" %}
          </div>
          <div class="continue-list" id="continue_list"></div>
        </div>
      </div>

      <!-- Analysis Steps -->
      <div class="sidebar-section">
        <h2 class="section-title">🔬 {% trans "分析步骤" %}</h2>
        <div class="steps-container" id="steps_container">
          <div class="step-item" data-step="upload">
            <div class="step-number">1</div>
            <div class="step-info">
              <div class="step-name">{% trans "数据上传" %}</div>
              <div class="step-desc">{% trans "上传原始数据文件" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="qc">
            <div class="step-number">2</div>
            <div class="step-info">
              <div class="step-name">{% trans "质量控制" %}</div>
              <div class="step-desc">{% trans "过滤低质量细胞和基因" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="hvg">
            <div class="step-number">3</div>
            <div class="step-info">
              <div class="step-name">{% trans "高变基因" %}</div>
              <div class="step-desc">{% trans "识别高变异基因" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="pca">
            <div class="step-number">4</div>
            <div class="step-info">
              <div class="step-name">{% trans "主成分分析" %}</div>
              <div class="step-desc">{% trans "降维处理" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="umap">
            <div class="step-number">5</div>
            <div class="step-info">
              <div class="step-name">{% trans "UMAP嵌入" %}</div>
              <div class="step-desc">{% trans "2D可视化" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
          <div class="step-item" data-step="clustering">
            <div class="step-number">6</div>
            <div class="step-info">
              <div class="step-name">{% trans "细胞聚类" %}</div>
              <div class="step-desc">{% trans "识别细胞类型" %}</div>
            </div>
            <div class="step-status pending">{% trans "待处理" %}</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="sidebar-section">
        <h2 class="section-title">📊 {% trans "运行历史" %}</h2>
        <div class="history-list" id="history_list">
          <div style="text-align:center; color:var(--muted); padding:20px;">{% trans "暂无运行记录" %}</div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Header -->
      <div class="workflow-header">
        <h1 class="workflow-title" id="workflow_title">{% trans "数据上传" %}</h1>
        <div class="workflow-actions">
          <!-- Run 按钮仅在非上传步骤显示 -->
          <button class="btn primary" id="run_btn" onclick="runCurrentStep()" style="display:none;" disabled>
            {% trans "开始分析" %}
          </button>
        </div>
      </div>

      <!-- Tabs（仅在非上传步骤显示） -->
      <div id="tabs_wrapper" style="display:none;">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('params', event)">{% trans "参数配置" %}</div>
          <div class="tab" onclick="switchTab('results', event)">{% trans "结果展示" %}</div>
          <div class="tab" onclick="switchTab('logs', event)">{% trans "运行日志" %}</div>
        </div>

        <div class="tab-content">
          <!-- Parameters Tab -->
          <div class="tab-pane active" id="tab_params">
            <div class="params-grid" id="params_grid"></div>
          </div>

          <!-- Results Tab -->
          <div class="tab-pane" id="tab_results">
            <div class="results-grid">
              <div class="result-panel">
                <div class="panel-header">📊 {% trans "关键指标" %}</div>
                <div class="panel-content">
                  <div class="metrics-grid" id="metrics_grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <!-- 原始数据指标 -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_cells_raw">-</div>
                      <div class="metric-label">{% trans "原始细胞数" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_genes_raw">-</div>
                      <div class="metric-label">{% trans "原始基因数" %}</div>
                    </div>
                    
                    <!-- 过滤后数据指标 -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_cells_filtered">-</div>
                      <div class="metric-label">{% trans "过滤后细胞数" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_genes_filtered">-</div>
                      <div class="metric-label">{% trans "过滤后基因数" %}</div>
                    </div>
                    
                    <!-- 移除率指标 -->
                    <div class="metric-card warn">
                      <div class="metric-value" id="metric_cells_removal_rate">-</div>
                      <div class="metric-label">{% trans "细胞移除率" %}</div>
                    </div>
                    <div class="metric-card warn">
                      <div class="metric-value" id="metric_genes_removal_rate">-</div>
                      <div class="metric-label">{% trans "基因移除率" %}</div>
                    </div>
                    
                    <!-- 每细胞统计指标 -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_mean_genes_per_cell">-</div>
                      <div class="metric-label">{% trans "平均基因/细胞" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_median_genes_per_cell">-</div>
                      <div class="metric-label">{% trans "中位基因/细胞" %}</div>
                    </div>
                    
                    <!-- UMI 统计指标 -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_mean_umis_per_cell">-</div>
                      <div class="metric-label">{% trans "平均UMI/细胞" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_median_umis_per_cell">-</div>
                      <div class="metric-label">{% trans "中位UMI/细胞" %}</div>
                    </div>
                    
                    <!-- 质量指标 -->
                    <div class="metric-card err">
                      <div class="metric-value" id="metric_mean_mito_pct">-</div>
                      <div class="metric-label">{% trans "平均线粒体%" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_mean_ribo_pct">-</div>
                      <div class="metric-label">{% trans "平均核糖体%" %}</div>
                    </div>
                  </div>
                  <div class="chart-placeholder">
                    {% trans "分析完成后将显示 UMAP 图表" %}
                  </div>
                  <div class="artifact-files" id="artifact_files"></div>
                </div>
              </div>
              <div class="result-panel">
                <div class="panel-header">🤖 {% trans "AI 建议" %}</div>
                <div class="panel-content">
                  <div id="advice_content" style="color:var(--muted); text-align:center; padding:40px 20px;">
                    {% trans "运行分析后将显示 AI 优化建议" %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs Tab -->
          <div class="tab-pane" id="tab_logs">
            <div class="log-container" id="log_container">
              <div style="color:var(--muted);">[{% trans "系统" %}] {% trans "等待开始分析..." %}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Only（仅在第 1 步显示） -->
      <div id="upload_only_view" style="padding:24px;">
        <div id="upload_project_cta_mount"></div> <!-- ★ 无项目时的 CTA 挂载点 -->
        <div class="params-grid">
          <div class="param-group">
            <h3>📁 {% trans "上传单细胞数据" %}</h3>
            <p style="color:var(--muted);line-height:1.6;">
              {% trans "支持 .h5ad, .h5, .csv, .mtx, .zip 等；可拖拽或点击选择。" %}
              <br>
              {% trans "选择文件后，点击“上传数据”开始上传；完成后将自动进入质量控制步骤。" %}
            </p>
            <div id="big_upload_drop" class="upload-area" style="margin-top:12px;">
              <div class="upload-icon">📤</div>
              <div class="upload-text">{% trans "点击或拖拽到此处选择文件" %}</div>
              <div class="upload-hint">{% trans "建议优先使用 .h5ad 或 10x 压缩包" %}</div>
              <input type="file" id="big_file_input" style="display:none" multiple
                     accept=".h5ad,.h5,.csv,.mtx,.tsv,.txt,.gz,.zip">
            </div>
            <div class="file-list" id="big_file_list" style="margin-top:12px;"></div>
            <div style="display:flex;gap:12px;margin-top:16px;">
              <!-- 仅保留“上传数据”按钮 -->
              <button id="btn_submit_upload" class="btn primary" type="button" disabled>{% trans "上传数据" %}</button>
            </div>
            <div id="upload_progress" style="margin-top:12px;color:var(--muted);"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal hidden" id="login_modal">
    <div class="modal-content">
      <h2 class="modal-title">{% trans "登录 CellInsightAI" %}</h2>
      <div class="modal-row">
        <label class="param-label">{% trans "邮箱或用户名" %}</label>
        <input type="text" id="login_email" class="param-input" placeholder="your@email.com">
      </div>
      <div class="modal-row">
        <label class="param-label">{% trans "密码" %}</label>
        <input type="password" id="login_password" class="param-input" placeholder="••••••••">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="hideLoginModal()">{% trans "取消" %}</button>
        <button class="btn" onclick="demoLogin()">{% trans "Demo 登录" %}</button>
        <button class="btn primary" onclick="doLogin()">{% trans "登录" %}</button>
      </div>
    </div>
  </div>

  <script id="app-urls" type="application/json">{{ APP_URLS_JSON|safe }}</script>

  <script>
    // -------------------- Global State --------------------
    let currentUser = null;
    let currentOrg = localStorage.getItem('active_org') || null;
    let currentStep = 'upload';
    let uploadedFiles = [];
    let currentProject = null;
    let currentDataset = null;
    let currentSession = null;
    let availableSteps = [];
    let availableProjects = [];
    let recentSessions = [];

    /**
     * 保存当前会话相关状态到 localStorage
     * - 保存键：ci_current_project, ci_current_dataset, ci_current_session, ci_current_step
     */
    function saveSessionState() {
      try {
        if (currentProject) localStorage.setItem('ci_current_project', String(currentProject));
        else localStorage.removeItem('ci_current_project');

        if (currentDataset) localStorage.setItem('ci_current_dataset', String(currentDataset));
        else localStorage.removeItem('ci_current_dataset');

        if (currentSession) localStorage.setItem('ci_current_session', String(currentSession));
        else localStorage.removeItem('ci_current_session');

        if (currentStep) localStorage.setItem('ci_current_step', String(currentStep));
        else localStorage.removeItem('ci_current_step');

        // 同步 selected_project（已有逻辑使用该键）
        if (currentProject) localStorage.setItem('selected_project', String(currentProject));
        else localStorage.removeItem('selected_project');

        console.log('[persist] saved session state', { currentProject, currentDataset, currentSession, currentStep });
      } catch (e) {
        console.warn('saveSessionState failed:', e);
      }
    }

    /**
     * 从 localStorage 恢复会话状态
     * - 若存在 session 则调用 enterSession 进入并恢复步骤
     * - 若只有 project 则加载该项目的会话列表
     */
    async function restoreSessionState() {
      try {
        const p = localStorage.getItem('ci_current_project');
        const s = localStorage.getItem('ci_current_session');
        const d = localStorage.getItem('ci_current_dataset');
        const step = localStorage.getItem('ci_current_step') || 'qc';

        if (p) currentProject = p;
        if (d) currentDataset = d;

        if (s) {
          console.log('[persist] restoring session:', { p, s, d, step });
          await enterSession(s);
          if (step && step !== 'upload') setStepActive(step);
        } else if (p) {
          await loadProjectSessions(p);
          updateProjectUI();
          setStepActive('upload');
        }
      } catch (e) {
        console.warn('restoreSessionState failed:', e);
      } finally {
        updateRunButtonState();
      }
    }

    // ============ Project Context Helpers ============
    function updateProjectUI() {
      const nameEl = document.getElementById('current_project_name');
      const quickSelect = document.getElementById('project_quick_select');
      const cur = currentProject && availableProjects.find(p => String(p.id) === String(currentProject));
      if (nameEl) nameEl.textContent = cur ? (cur.name || ('#' + cur.id)) : gettext('未选择项目');
      if (quickSelect) {
        quickSelect.style.display = availableProjects.length ? '' : 'none';
        if (cur) quickSelect.value = String(cur.id);
      }
      updateUploadBtnDisabled();
      // 无项目时，渲染上传视图顶部 CTA
      const ctaMount = document.getElementById('upload_project_cta_mount');
      if (ctaMount) renderUploadEmptyProjectCTA(ctaMount);
    }

    async function loadAvailableProjects() {
      if (!currentOrg) { availableProjects = []; updateProjectUI(); return; }
      try {
        const url = `${window.APP_URLS.API_PROJECTS}?organization=${encodeURIComponent(currentOrg)}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        availableProjects = Array.isArray(data) ? data : (data.results || []);
        const quickSelect = document.getElementById('project_quick_select');
        if (quickSelect) {
          quickSelect.innerHTML = `<option value="">${gettext('切换项目...')}</option>` +
            availableProjects.map(p => `<option value="${p.id}">${p.name || ('#' + p.id)}</option>`).join('');
        }
        updateProjectUI();
      } catch (e) {
        console.error('loadAvailableProjects error:', e);
        availableProjects = [];
        updateProjectUI();
      }
    }

    async function initProjectContext() {
      const fromUrl = new URLSearchParams(location.search).get('project');
      const fromStore = localStorage.getItem('selected_project');
      currentProject = fromUrl || fromStore || null;
      if (currentProject && !availableProjects.find(p => String(p.id) === String(currentProject))) {
        currentProject = null;
      }
      updateProjectUI();
      if (currentProject) {
        await loadProjectSessions(currentProject);
      } else {
        renderContinueList([]);
      }
    }

    function showProjectSelector() {
      const quickSelect = document.getElementById('project_quick_select');
      if (!quickSelect) return;
      quickSelect.style.display = '';
      quickSelect.focus();
    }

    async function onProjectQuickChange() {
      const quickSelect = document.getElementById('project_quick_select');
      if (!quickSelect) return;
      const val = quickSelect.value || '';
      currentProject = val || null;
      if (currentProject) {
        localStorage.setItem('selected_project', currentProject);
        await loadProjectSessions(currentProject);
      } else {
        localStorage.removeItem('selected_project');
        renderContinueList([]);
      }
      updateProjectUI();
    }

    async function loadProjectSessions(projectId) {
      try {
        const url = `${window.APP_URLS.API_SESSIONS}?project=${encodeURIComponent(projectId)}&ordering=-updated_at&limit=10`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        recentSessions = Array.isArray(data) ? data : (data.results || []);
        renderContinueList(recentSessions);
      } catch (e) {
        console.error('loadProjectSessions error:', e);
        renderContinueList([]);
      }
    }

    function renderContinueList(list) {
      const sec = document.getElementById('continue_section');
      const ul = document.getElementById('continue_list');
      if (!sec || !ul) return;
      if (!list.length) {
        sec.style.display = 'none';
        ul.innerHTML = '';
        return;
      }
      sec.style.display = '';
      ul.innerHTML = list.map(s => {
        const status = s.status || 'paused';
        const step = s.current_step || 'upload';
        const when = s.updated_at ? new Date(s.updated_at).toLocaleString() : '';
        const label = s.name || (`#${s.id}`);
        return `
          <div class="continue-item" data-session-id="${s.id}">
            <div class="continue-info">
              <div class="continue-name">${label}</div>
              <div class="continue-meta">${gettext('状态')}: ${status} · ${gettext('当前步骤')}: ${step} · ${when}</div>
            </div>
            <div class="continue-actions">
              <button class="continue-btn" data-action="continue" data-session-id="${s.id}">${gettext('继续')}</button>
              <button class="delete-btn" data-action="delete" data-session-id="${s.id}" title="${gettext('删除此会话')}">${gettext('删除')}</button>
            </div>
          </div>
        `;
      }).join('');

      ul.onclick = async (e) => {
        e.stopPropagation();
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        
        const action = btn.getAttribute('data-action');
        const sid = btn.getAttribute('data-session-id');
        if (!sid) return;
        
        if (action === 'continue') {
          await enterSession(sid);
        } else if (action === 'delete') {
          await deleteSession(sid);
        }
      };
    }

    async function enterSession(sessionId) {
      try {
        const url = `${window.APP_URLS.API_SESSIONS}${sessionId}/`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const s = await res.json();
        currentSession = s.id;
        currentDataset = s.dataset;
        currentProject = s.project || currentProject;
        
        // 持久化会话状态到 localStorage
        saveSessionState();
        
        updateProjectUI();
        await loadSessionHistory();
        const step = s.current_step || 'qc';
        setStepActive(step);
      } catch (e) {
        console.error('enterSession error:', e);
        alert(gettext('加载会话失败'));
      } finally {
        updateRunButtonState();
      }
    }

    /**
     * 删除会话功能
     * @param {string} sessionId - 要删除的会话ID
     */
    async function deleteSession(sessionId) {
      if (!sessionId) {
        console.error('Session ID is required for deletion');
        return;
      }

      try {
        // 首先获取会话信息用于确认
        const sessionRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, {
          headers: authHeaders()
        });
        
        if (!sessionRes.ok) {
          throw new Error(gettext('无法获取会话信息'));
        }
        
        const session = await sessionRes.json();
        const sessionName = session.name || `#${session.id}`;
        
        // 显示确认对话框
        const confirmMessage = gettext('确定要删除会话 "') + sessionName + gettext('" 吗？\n\n此操作不可撤销，所有相关的分析数据和历史记录都将被永久删除。');
        
        if (!confirm(confirmMessage)) {
          return; // 用户取消操作
        }

        // 执行删除操作
        const deleteRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (!deleteRes.ok) {
          const errorText = await deleteRes.text();
          throw new Error(gettext('删除失败：') + errorText);
        }

        // 删除成功后的处理
        console.log('Session deleted successfully:', sessionId);
        
        // 如果删除的是当前活动会话，需要重置上下文
        if (currentSession && String(currentSession) === String(sessionId)) {
          currentSession = null;
          currentDataset = null;
          // 不重置 currentProject，让用户保持在当前项目
          
          // 切换到上传步骤
          setStepActive('upload');
          
          // 清空历史记录
          const historyList = document.getElementById('history_list');
          if (historyList) {
            historyList.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">' + gettext('暂无运行记录') + '</div>';
          }
          
          // 更新运行按钮状态
          updateRunButtonState();
        }

        // 刷新会话列表
        if (currentProject) {
          await loadProjectSessions(currentProject);
        }

        // 显示成功消息
        logMessage(gettext('会话 "') + sessionName + gettext('" 已成功删除'));
        
      } catch (error) {
        console.error('Delete session error:', error);
        alert(gettext('删除会话失败：') + (error.message || error));
      }
    }

    // -------------------- Utils --------------------
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }
    function getCsrfToken() { return getCookie('csrftoken') || ''; }
    function authHeaders(extra = {}) {
      const h = { 'X-CSRFToken': getCsrfToken() };
      if (currentOrg) h['X-Org'] = currentOrg;
      return Object.assign(h, extra);
    }
    function logMessage(message) {
      const container = document.getElementById('log_container');
      if (!container) return;
      const timestamp = new Date().toLocaleTimeString();
      container.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      container.scrollTop = container.scrollHeight;
    }

    // -------------------- App URLs --------------------
    try {
      window.APP_URLS = JSON.parse(document.getElementById('app-urls').textContent || '{}');
    } catch (e) {
      window.APP_URLS = {};
      console.error('Failed to parse APP_URLS JSON', e);
    }
    // ========= 新增帮助函数（放在最上面的“Global State”附近或 Utils 上方都可以） =========
    function getOrganizationsUrl() {
      // 兼容 API_ORGANIZATIONS / API_ORGS 两种 key
      const u = window.APP_URLS || {};
      return u.API_ORGANIZATIONS || u.API_ORGS || '/api/v1/organizations/';
    }
    function getDefaultOrgFromUser(user) {
      // 尽量从 /me 返回里取默认组织；兼容不同字段命名
      if (!user) return null;
      if (user.profile && (user.profile.organization || (user.profile.organization_id))) {
        return String(user.profile.organization?.id || user.profile.organization_id || user.profile.organization);
      }
      if (user.default_organization || user.default_organization_id) {
        return String(user.default_organization?.id || user.default_organization_id || user.default_organization);
      }
      // 一些后端会把当前 org 放在 user.organization
      if (user.organization || user.organization_id) {
        return String(user.organization?.id || user.organization_id || user.organization);
      }
      return null;
    }
    function setCurrentOrg(orgId) {
      currentOrg = orgId ? String(orgId) : null;
      const sel = document.getElementById('org_select');
      if (sel) sel.value = currentOrg || '';
      if (currentOrg) localStorage.setItem('active_org', currentOrg);
      else localStorage.removeItem('active_org');
    }
    // ========= 替换 fetchCurrentUser 函数 =========
    async function fetchCurrentUser() {
      try {
        const res = await fetch(window.APP_URLS.API_USER_ME, { headers: authHeaders() });
        const userProfile = document.getElementById('user_profile');
        const userName = document.getElementById('user_name');
        const loginBtn = userProfile.querySelector('.login-btn');

        if (res.ok) {
          const user = await res.json();
          currentUser = user;
          userName.textContent = user.username || user.email || gettext('用户');
          loginBtn.textContent = gettext('已登录');
          loginBtn.style.background = 'var(--ok)';
          loginBtn.onclick = null;
          userProfile.style.display = 'block';

          // 关键：在这里先解析“默认组织”，如有则覆盖本地的 active_org
          const userDefaultOrg = getDefaultOrgFromUser(user);
          // 如果本地没有 active_org 或本地的并不存在于该用户，统一以用户默认组织为准
          if (!currentOrg || currentOrg === 'undefined') {
            setCurrentOrg(userDefaultOrg);
          }

          await loadOrganizations(user);        // 传 user，方便函数内部兜底
          await loadAvailableProjects();        // 依赖 currentOrg 的列表
          await initProjectContext();
        } else {
          // 未登录分支
          currentUser = null;
          userName.textContent = gettext('未登录');
          loginBtn.textContent = gettext('点击登录');
          loginBtn.style.background = 'var(--accent)';
          loginBtn.onclick = showLoginModal;
          userProfile.style.display = 'block';
          // 清空本地 org
          setCurrentOrg(null);
        }
      } catch (e) {
        console.error('Error fetching user:', e);
      }
    }
    // ========= 替换 loadOrganizations 函数（新增 user 参数，自动选中逻辑） =========
    async function loadOrganizations(user = currentUser) {
      if (!user) return;
      try {
        const url = getOrganizationsUrl();
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const orgs = await res.json();

        const orgSelect = document.getElementById('org_select');
        if (orgSelect) {
          orgSelect.innerHTML = '<option value="">' + gettext('选择组织...') + '</option>';
          // 兼容返回结构：数组或 {results: []}
          const list = Array.isArray(orgs) ? orgs : (orgs.results || []);
          list.forEach(org => {
            const option = document.createElement('option');
            option.value = String(org.id);
            option.textContent = org.name || ('#' + org.id);
            orgSelect.appendChild(option);
          });

          // 自动选择策略：
          // 1) currentOrg（如果合法）；
          // 2) 用户默认组织 getDefaultOrgFromUser(user)；
          // 3) 只有一个组织时选它；
          // 4) 否则保持空
          const userDefaultOrg = getDefaultOrgFromUser(user);
          const ids = list.map(o => String(o.id));
          let nextOrg = null;

          if (currentOrg && ids.includes(String(currentOrg))) {
            nextOrg = String(currentOrg);
          } else if (userDefaultOrg && ids.includes(String(userDefaultOrg))) {
            nextOrg = String(userDefaultOrg);
          } else if (list.length === 1) {
            nextOrg = String(list[0].id);
          }

          setCurrentOrg(nextOrg);  // 会同步 select + localStorage
        }
      } catch (e) {
        console.error('Failed to load organizations:', e);
      }
    }

    async function autoSelectFirstOrganization() {
      try {
        console.log('Attempting to auto-select organization...');
        const res = await fetch(window.APP_URLS.API_ORGANIZATIONS, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          const orgsList = Array.isArray(data) ? data : (data.results || []);
          console.log('Organizations response:', orgsList);
          
          if (orgsList.length > 0) {
            const lowerEq = (a,b) => String(a||'').toLowerCase() === String(b||'').toLowerCase();
            const lowerInc = (a,b) => String(a||'').toLowerCase().includes(String(b||'').toLowerCase());
            
            // 1) 精确匹配名称为 'Demo Org'
            let targetOrg = orgsList.find(org => lowerEq(org.name, 'Demo Org'));
            // 2) 其次：名称包含 'demo' 或中文“演示/示例”
            if (!targetOrg) targetOrg = orgsList.find(org => lowerInc(org.name, 'demo') || lowerInc(org.name, '演示') || lowerInc(org.name, '示例'));
            // 3) 否则：第一个组织
            if (!targetOrg) targetOrg = orgsList[0];
            
            currentOrg = String(targetOrg.id);
            localStorage.setItem('active_org', currentOrg);
            console.log('Auto-selected organization:', targetOrg.name, 'ID:', currentOrg);
            
            const orgSelect = document.getElementById('org_select');
            if (orgSelect) {
              // 如果选项列表尚未加载/不存在该选项，则重建一次
              let needRebuild = true;
              if (orgSelect.options && orgSelect.options.length > 0) {
                for (let option of orgSelect.options) {
                  if (String(option.value) === String(currentOrg)) { needRebuild = false; break; }
                }
              }
              if (needRebuild) {
                orgSelect.innerHTML = '<option value="">' + gettext('选择组织...') + '</option>';
                orgsList.forEach(org => {
                  const opt = document.createElement('option');
                  opt.value = org.id;
                  opt.textContent = org.name;
                  orgSelect.appendChild(opt);
                });
              }
              orgSelect.value = currentOrg;
            }
            
            await loadAvailableProjects();
            updateProjectUI();
            updateUploadBtnDisabled();
          } else {
            console.log('No organizations found for auto-selection');
          }
        } else {
          console.error('Failed to fetch organizations:', res.status, await res.text());
        }
      } catch (e) {
        console.error('Failed to auto-select organization:', e);
      }
    }

    // ========= 小改 onOrgChange，确保写入本地并刷新相关依赖 =========
    function onOrgChange() {
      const select = document.getElementById('org_select');
      if (!select) return;
      setCurrentOrg(select.value || null);  // 统一入口
      loadAvailableProjects();              // 随组织切换刷新项目
      updateProjectUI();
      updateUploadBtnDisabled();
    }

    function showLoginModal() {
      const modal = document.getElementById('login_modal');
      if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('login_email').focus();
      }
    }

    function hideLoginModal() {
      const modal = document.getElementById('login_modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    async function doLogin() {
      const email = document.getElementById('login_email').value.trim();
      const password = document.getElementById('login_password').value;

      if (!email || !password) {
        alert(gettext('请输入邮箱和密码'));
        return;
      }

      try {
        const res = await fetch(`${window.APP_URLS.API_USERS_BASE}/login/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
          body: JSON.stringify({ email, password })
        });

        if (res.ok) {
          hideLoginModal();
          await fetchCurrentUser();
        } else {
          alert(gettext('登录失败，请检查邮箱和密码'));
        }
      } catch (e) {
        console.error('Login error:', e);
        alert(gettext('登录失败'));
      }
    }

    /**
     * 演示登录功能 - 自动关联到组织
     */
    async function demoLogin() {
      try {
        const res = await fetch(window.APP_URLS.API_DEMO_LOGIN, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCsrfToken() }
        });
        if (res.ok) {
          hideLoginModal();
          await fetchCurrentUser();
          // ★ Demo登录后自动选择第一个可用组织
          await autoSelectFirstOrganization();
        } else {
          alert(gettext('Demo 登录失败'));
        }
      } catch (e) {
        console.error('Demo login error:', e);
        alert(gettext('Demo 登录失败'));
      }
    }

    // -------------------- Steps Management --------------------
    async function loadAvailableSteps() {
      try {
        const res = await fetch(window.APP_URLS.API_STEPS, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          availableSteps = Array.isArray(data) ? data : (data.results || []);
        }
      } catch (e) {
        console.error('Failed to load steps:', e);
      }
    }

    function setStepActive(stepName) {
      currentStep = stepName;
      
      try { saveSessionState(); } catch (_) {}

      document.querySelectorAll('.step-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-step') === stepName) {
          item.classList.add('active');
        }
      });

      const titleEl = document.getElementById('workflow_title');
      const stepTitles = {
        'upload': gettext('数据上传'),
        'qc': gettext('质量控制'),
        'hvg': gettext('高变基因'),
        'pca': gettext('主成分分析'),
        'umap': gettext('UMAP嵌入'),
        'clustering': gettext('细胞聚类')
      };
      if (titleEl) {
        titleEl.textContent = stepTitles[stepName] || stepName;
      }

      const uploadView = document.getElementById('upload_only_view');
      const tabsWrapper = document.getElementById('tabs_wrapper');
      const runBtn = document.getElementById('run_btn');

      if (stepName === 'upload') {
        if (uploadView) uploadView.style.display = 'block';
        if (tabsWrapper) tabsWrapper.style.display = 'none';
        if (runBtn) runBtn.style.display = 'none';
        renderUploadView();
      } else {
        if (uploadView) uploadView.style.display = 'none';
        if (tabsWrapper) tabsWrapper.style.display = 'block';
        if (runBtn) runBtn.style.display = 'inline-block';
        renderParametersView(stepName);
      }

      updateRunButtonState();
    }

    function setStepStatus(stepName, status) {
      const stepItem = document.querySelector(`.step-item[data-step="${stepName}"]`);
      if (!stepItem) return;

      const statusEl = stepItem.querySelector('.step-status');
      if (statusEl) {
        statusEl.className = `step-status ${status}`;
        const statusTexts = {
          'pending': gettext('待处理'),
          'running': gettext('运行中'),
          'completed': gettext('已完成'),
          'failed': gettext('失败')
        };
        statusEl.textContent = statusTexts[status] || status;
      }

      stepItem.classList.remove('completed', 'failed');
      if (status === 'completed') stepItem.classList.add('completed');
      if (status === 'failed') stepItem.classList.add('failed');
    }

    function updateRunButtonState() {
      const runBtn = document.getElementById('run_btn');
      if (!runBtn) return;
      const hasRequiredContext = currentProject && currentDataset && currentSession;
      runBtn.disabled = !hasRequiredContext;
      runBtn.textContent = hasRequiredContext ? gettext('开始分析') : gettext('请先完成数据上传');
    }

    function updateUploadBtnDisabled() {
      const btn = document.getElementById('btn_submit_upload');
      if (!btn) return;
      const hasFiles = uploadedFiles && uploadedFiles.length > 0;
      const hasProject = !!currentProject;
      const hasOrg = !!currentOrg;
      btn.disabled = !(hasFiles && hasProject && hasOrg);
    }

    // -------------------- Tabs --------------------
    function switchTab(tabName, event) {
      if (event) event.preventDefault();
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      const targetPane = document.getElementById(`tab_${tabName}`);
      if (targetPane) targetPane.classList.add('active');
    }

    // -------------------- Session History --------------------
    async function loadSessionHistory() {
      if (!currentSession) return;
      try {
        const res = await fetch(`${window.APP_URLS.API_STEP_RUNS}?session=${currentSession}`, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          const runs = Array.isArray(data) ? data : (data.results || []);
          renderHistoryList(runs);
        }
      } catch (e) {
        console.error('Failed to load session history:', e);
      }
    }

    function renderHistoryList(runs) {
      const historyList = document.getElementById('history_list');
      if (!historyList) return;
      if (runs.length === 0) {
        historyList.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">' + gettext('暂无运行记录') + '</div>';
        return;
      }
      historyList.innerHTML = runs.map(run => `
        <div class="history-item" style="padding:8px 12px; border-bottom:1px solid var(--border); cursor:pointer;"
             onclick="loadAndRenderStepResults('${run.id}')">
          <div style="font-size:13px; font-weight:500;">${run.step.name}</div>
          <div style="font-size:11px; color:var(--muted);">${run.status} • ${new Date(run.created_at).toLocaleString()}</div>
        </div>
      `).join('');
    }

    // -------------------- Run Step --------------------
    async function runCurrentStep() {
      if (!currentProject || !currentDataset || !currentSession) {
        alert(gettext('请先完成数据上传'));
        return;
      }
      const stepInfo = availableSteps.find(s => s.step_type === currentStep);
      if (!stepInfo) { alert(gettext('未找到步骤配置')); return; }

      setStepStatus(currentStep, 'running');
      logMessage(gettext('开始执行步骤：') + stepInfo.name);

      try {
        const payload = { session: currentSession, step: stepInfo.id, parameters: {} };
        const res = await fetch(window.APP_URLS.API_CORE_RUN, {
          method: 'POST', headers: authHeaders({'Content-Type': 'application/json'}), body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        const runData = await res.json();
        setStepStatus(currentStep, 'completed');
        logMessage(gettext('步骤执行完成'));
        
        // 加载并渲染结果
        if (runData.step_run_id) {
          await loadAndRenderStepResults(runData.step_run_id);
        }
        
        await loadSessionHistory();
        const order = ['upload','qc','hvg','pca','umap','clustering'];
        const i = order.indexOf(currentStep);
        // 完成 QC 后停留在结果页面，不自动跳转到下一步骤
        if (currentStep !== 'qc' && i >= 0 && i < order.length - 1) {
          setStepActive(order[i+1]);
        }
      } catch (e) {
        console.error('Step execution failed:', e);
        setStepStatus(currentStep, 'failed');
        logMessage(gettext('步骤执行失败：') + (e.message || e));
      }
    }

    // -------------------- Results Rendering --------------------
    /**
     * 加载并渲染步骤运行结果
     * @param {string} stepRunId - StepRun ID
     */
    async function loadAndRenderStepResults(stepRunId) {
      if (!stepRunId) {
        console.warn('loadAndRenderStepResults: stepRunId is missing');
        return;
      }
      
      console.log('loadAndRenderStepResults called with stepRunId:', stepRunId);
      
      try {
        logMessage(gettext('正在加载分析结果...'));
        
        // 获取 StepRun 导出数据
        const exportUrl = `${window.APP_URLS.API_STEP_RUNS}${stepRunId}/export/`;
        console.log('Fetching export data from:', exportUrl);
        
        const exportRes = await fetch(exportUrl, {
          headers: authHeaders()
        });
        
        if (!exportRes.ok) {
          const errorText = await exportRes.text();
          console.error('Export fetch failed:', { status: exportRes.status, errorText });
          throw new Error(gettext('获取结果数据失败：') + errorText);
        }
        
        const exportData = await exportRes.json();
        console.log('Export data received:', exportData);
        console.log('exportData.run structure:', exportData.run);
        
        // 渲染指标
        await renderMetrics(exportData.run);
        
        // 渲染产物（图表、文件等）
        await renderArtifacts(exportData.artifacts || []);
        
        // 渲染AI建议（如果有）
        await renderAdvice(stepRunId);
        
        logMessage(gettext('结果加载完成 ✅'));
        
        // 自动切换到结果标签页
        const resultsTab = document.querySelector('.tab[onclick*="results"]');
        if (resultsTab) {
          resultsTab.click();
        }
        
      } catch (e) {
        console.error('Load results error:', e);
        logMessage(gettext('加载结果失败：') + (e.message || e));
      }
    }

    /**
     * 渲染分析指标
     * @param {Object} stepRun - StepRun 数据
     */
    async function renderMetrics(stepRun) {
      console.log('renderMetrics called with stepRun:', stepRun);
      
      if (!stepRun) {
        console.warn('renderMetrics: stepRun is null or undefined');
        return;
      }
      
      // 兼容多种后端字段命名：
      // - stepRun.metrics_json（旧格式，StepRun上直接存JSON）
      // - stepRun.metrics（导出结果把指标放在 run.metrics 下）
      // - 或者直接传入 metrics 对象
      const metrics = stepRun.metrics_json || stepRun.metrics || stepRun;
      
      console.log('Extracted metrics object:', metrics);
      
      if (!metrics || typeof metrics !== 'object') {
        console.warn('renderMetrics: metrics is not a valid object:', metrics);
        return;
      }
      
      console.log('Rendering metrics:', metrics);
      
      // 格式化数值函数
      const formatNumber = (value, precision = 0) => {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'number') {
          return precision > 0 ? value.toFixed(precision) : Math.round(value).toLocaleString();
        }
        return value;
      };
      
      const formatPercentage = (value, precision = 1) => {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'number') {
          // 如果值是小数形式 (0-1)，转换为百分比
          const percentage = value <= 1 ? value * 100 : value;
          return percentage.toFixed(precision) + '%';
        }
        return value;
      };
      
      // 更新所有指标卡片
      const metricElements = {
        // 原始数据指标
        'metric_cells_raw': formatNumber(metrics.cells_raw),
        'metric_genes_raw': formatNumber(metrics.genes_raw),
        
        // 过滤后数据指标
        'metric_cells_filtered': formatNumber(metrics.cells_filtered || metrics.cells),
        'metric_genes_filtered': formatNumber(metrics.genes_filtered || metrics.genes),
        
        // 移除率指标
        'metric_cells_removal_rate': formatPercentage(metrics.cells_removal_rate),
        'metric_genes_removal_rate': formatPercentage(metrics.genes_removal_rate),
        
        // 每细胞统计指标
        'metric_mean_genes_per_cell': formatNumber(metrics.mean_genes_per_cell, 1),
        'metric_median_genes_per_cell': formatNumber(metrics.median_genes_per_cell),
        
        // UMI 统计指标
        'metric_mean_umis_per_cell': formatNumber(metrics.mean_umis_per_cell, 1),
        'metric_median_umis_per_cell': formatNumber(metrics.median_umis_per_cell),
        
        // 质量指标
        'metric_mean_mito_pct': formatPercentage(metrics.mean_mito_pct),
        'metric_mean_ribo_pct': formatPercentage(metrics.mean_ribo_pct)
      };
      
      // 更新DOM元素
      Object.entries(metricElements).forEach(([elementId, value]) => {
        const el = document.getElementById(elementId);
        console.log(`Updating element ${elementId}:`, { found: !!el, value: value });
        if (el) {
          el.textContent = value;
          console.log(`Successfully updated ${elementId} to: ${value}`);
        } else {
          console.error(`Element with ID ${elementId} not found in DOM`);
        }
      });
      
      // 根据指标值设置警告状态
      updateMetricStatus('metric_cells_removal_rate', metrics.cells_removal_rate, 0.1); // 10%以上警告
      updateMetricStatus('metric_genes_removal_rate', metrics.genes_removal_rate, 0.3); // 30%以上警告
      updateMetricStatus('metric_mean_mito_pct', metrics.mean_mito_pct, 0.2); // 20%以上警告
      
      console.log('renderMetrics completed successfully');
    }

    /**
     * 更新指标状态（正常/警告/错误）
     * @param {string} elementId - 元素ID
     * @param {number} value - 指标值
     * @param {number} threshold - 警告阈值
     */
    function updateMetricStatus(elementId, value, threshold) {
      const el = document.getElementById(elementId);
      if (!el || value === undefined || value === null) return;
      
      const card = el.closest('.metric-card');
      if (!card) return;
      
      card.classList.remove('ok', 'warn', 'err');
      
      if (value > threshold * 1.5) {
        card.classList.add('err');
      } else if (value > threshold) {
        card.classList.add('warn');
      } else {
        card.classList.add('ok');
      }
    }

    /**
     * 渲染产物（图表、文件等）
     * @param {Array} artifacts - Artifact 列表
     */
    async function renderArtifacts(artifacts) {
      if (!artifacts || artifacts.length === 0) return;
      
      const chartPlaceholder = document.querySelector('.chart-placeholder');
      const filesContainer = document.getElementById('artifact_files');
      if (!chartPlaceholder) return;
      
      try {
        // 查找图表文件（PNG, PDF等）
        const chartArtifacts = artifacts.filter(artifact => 
          ['png', 'pdf', 'svg', 'jpg', 'jpeg'].includes(
            (artifact.artifact_type || '').toLowerCase()
          )
        );
        
        if (chartArtifacts.length === 0) {
          chartPlaceholder.innerHTML = '<div style="color:var(--muted);">' + gettext('暂无图表文件') + '</div>';
        } else {
          logMessage(gettext('正在加载图表...'));
          
          // 为每个图表生成预签名URL并显示
          const chartElements = await Promise.all(
            chartArtifacts.map(async (artifact) => {
              try {
                const presignRes = await fetch(window.APP_URLS.API_STORAGE_PRESIGN, {
                  method: 'POST',
                  headers: authHeaders({'Content-Type': 'application/json'}),
                  body: JSON.stringify({
                    path: artifact.file_path,
                    method: 'get'
                  })
                });
                
                if (!presignRes.ok) {
                  console.error('Failed to get presigned URL for:', artifact.name);
                  return null;
                }
                
                const presignData = await presignRes.json();
                
                return `
                  <div class="chart-item" style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text);">${artifact.name}</h4>
                    <div style="text-align: center; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px;">
                      <img src="${presignData.url}" alt="${artifact.name}" 
                           style="max-width: 100%; max-height: 400px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                      <div style="display: none; color: var(--muted); padding: 20px;">
                        ${gettext('图片加载失败')}
                      </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                      ${gettext('类型')}: ${artifact.artifact_type} | 
                      ${gettext('大小')}: ${formatFileSize(artifact.file_size)}
                    </div>
                  </div>
                `;
              } catch (e) {
                console.error('Error processing artifact:', artifact.name, e);
                return null;
              }
            })
          );
          
          const validCharts = chartElements.filter(el => el !== null);
          
          if (validCharts.length > 0) {
            chartPlaceholder.innerHTML = validCharts.join('');
            logMessage(gettext('图表加载完成'));
          } else {
            chartPlaceholder.innerHTML = '<div style="color:var(--muted);">' + gettext('图表加载失败') + '</div>';
          }
        }
        
        // 渲染非图像类产物（如 CSV/JSON/HTML/H5AD/ZIP 等）
        if (filesContainer) {
          const nonImageArtifacts = artifacts.filter(artifact => {
            const t = (artifact.artifact_type || '').toLowerCase();
            return !['png','pdf','svg','jpg','jpeg'].includes(t);
          });
          
          if (nonImageArtifacts.length === 0) {
            filesContainer.innerHTML = '';
          } else {
            logMessage(gettext('正在加载相关文件链接...'));
            const fileItems = await Promise.all(nonImageArtifacts.map(async (artifact) => {
              try {
                const presignRes = await fetch(window.APP_URLS.API_STORAGE_PRESIGN, {
                  method: 'POST',
                  headers: authHeaders({'Content-Type': 'application/json'}),
                  body: JSON.stringify({ path: artifact.file_path, method: 'get' })
                });
                if (!presignRes.ok) throw new Error(await presignRes.text());
                const presignData = await presignRes.json();
                const url = presignData.url;
                return `
                  <div class="artifact-item">
                    <div>
                      <div class="name">${artifact.name}</div>
                      <div class="meta">${gettext('类型')}: ${artifact.artifact_type} · ${gettext('大小')}: ${formatFileSize(artifact.file_size)}</div>
                    </div>
                    <div>
                      <a class="btn" style="padding:6px 12px;font-size:12px;" href="${url}" target="_blank" rel="noopener">
                        ⬇️ ${gettext('下载')}
                      </a>
                    </div>
                  </div>
                `;
              } catch (e) {
                console.error('Presign non-image artifact failed:', artifact.name, e);
                return null;
              }
            }));
            const valid = fileItems.filter(Boolean);
            if (valid.length) {
              filesContainer.innerHTML = `
                <div style="font-weight:600;margin:8px 0 6px 0;">📎 ${gettext('相关文件')}</div>
                ${valid.join('')}
              `;
              logMessage(gettext('文件链接已就绪'));
            } else {
              filesContainer.innerHTML = '';
            }
          }
        }
        
      } catch (e) {
        console.error('Render artifacts error:', e);
        chartPlaceholder.innerHTML = '<div style="color:var(--err);">' + gettext('图表加载出错：') + (e.message || e) + '</div>';
        if (filesContainer) {
          filesContainer.innerHTML = '';
        }
      }
    }

    /**
     * 渲染AI建议
     * @param {string} stepRunId - StepRun ID
     */
    async function renderAdvice(stepRunId) {
      const adviceEl = document.getElementById('advice_content');
      if (!adviceEl) return;
      
      try {
        const adviceRes = await fetch(`${window.APP_URLS.API_STEP_RUNS}${stepRunId}/advice/`, {
          headers: authHeaders()
        });
        
        if (!adviceRes.ok) {
          console.log('No advice available for this step run');
          return;
        }
        
        const adviceList = await adviceRes.json();
        
        if (!adviceList || adviceList.length === 0) {
          adviceEl.innerHTML = `
            <div style="color:var(--muted); text-align:center; padding:40px 20px;">
              ${gettext('暂无AI建议')}
            </div>
          `;
          return;
        }
        
        // 渲染建议列表
        const adviceHtml = adviceList.map(advice => `
          <div class="advice-item" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div class="advice-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
              <h4 style="margin: 0; font-size: 14px; color: var(--accent);">
                ${advice.advice_type === 'warning' ? '⚠️' : '💡'} ${advice.title || gettext('优化建议')}
              </h4>
              <span class="advice-priority" style="font-size: 12px; padding: 2px 8px; border-radius: 4px; background: var(--muted); color: white;">
                ${advice.priority || 'medium'}
              </span>
            </div>
            <div class="advice-content" style="color: var(--text); line-height: 1.5; margin-bottom: 12px;">
              ${advice.content || advice.description || ''}
            </div>
            <div class="advice-actions" style="display: flex; gap: 8px;">
              <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="applyAdvice('${advice.id}')">
                ${gettext('应用建议')}
              </button>
              <button class="btn" style="padding: 6px 12px; font-size: 12px; background: var(--muted);" onclick="dismissAdvice('${advice.id}')">
                ${gettext('忽略')}
              </button>
            </div>
          </div>
        `).join('');
        
        adviceEl.innerHTML = adviceHtml;
        
      } catch (e) {
        console.error('Render advice error:', e);
        adviceEl.innerHTML = `
          <div style="color:var(--muted); text-align:center; padding:40px 20px;">
            ${gettext('加载AI建议时出错')}
          </div>
        `;
      }
    }

    /**
     * 应用AI建议
     * @param {string} adviceId - 建议ID
     */
    async function applyAdvice(adviceId) {
      try {
        const res = await fetch(`${window.APP_URLS.API_ADVICE}${adviceId}/apply/`, {
          method: 'POST',
          headers: authHeaders()
        });
        
        if (!res.ok) {
          throw new Error(await res.text());
        }
        
        const result = await res.json();
        logMessage(gettext('AI建议已应用'));
        
        // 刷新参数视图
        renderParametersView(currentStep);
        
      } catch (e) {
        console.error('Apply advice error:', e);
        alert(gettext('应用建议失败：') + (e.message || e));
      }
    }

    /**
     * 忽略AI建议
     * @param {string} adviceId - 建议ID
     */
    async function dismissAdvice(adviceId) {
      // 简单隐藏建议项
      const adviceItem = document.querySelector(`[onclick*="${adviceId}"]`).closest('.advice-item');
      if (adviceItem) {
        adviceItem.style.display = 'none';
      }
    }

    /**
     * 格式化文件大小
     * @param {number} bytes - 字节数
     * @returns {string} 格式化后的大小
     */
    function formatFileSize(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }

    // -------------------- Parameters View --------------------
    function renderParametersView(stepName) {
      const paramsGrid = document.getElementById('params_grid');
      if (!paramsGrid) return;
      paramsGrid.innerHTML = `
        <div class="param-group">
          <h3>📊 ${gettext('参数配置')}</h3>
          <p style="color:var(--muted);">${gettext('步骤')} ${stepName} ${gettext('的参数配置将在此显示')}</p>
        </div>
      `;
    }

    // -------------------- 新增：创建项目（轻量 prompt） --------------------
    async function createProjectViaPrompt(defaultName = '') {
      if (!currentOrg) { 
        alert(gettext('请先选择组织')); 
        throw new Error('no org'); 
      }
      
      const name = prompt(
        gettext('请输入项目名称'), 
        defaultName || ('Project_' + new Date().toISOString().slice(0,16).replace(/[T:]/g,'-'))
      );
      
      if (!name || name.trim() === '') {
        throw new Error(gettext('项目名称不能为空'));
      }
      
      const payload = { 
        name: name.trim(), 
        organization: currentOrg 
      };
      
      const res = await fetch(window.APP_URLS.API_PROJECTS, {
        method:'POST', 
        headers:authHeaders({'Content-Type':'application/json'}), 
        body:JSON.stringify(payload)
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(gettext('创建项目失败：') + errorText);
      }
      
      const proj = await res.json();
      currentProject = String(proj.id);
      localStorage.setItem('selected_project', currentProject);
      
      await loadAvailableProjects();
      updateProjectUI();
      
      console.log('Project created successfully:', proj.name);
      return proj;
    }

    /**
     * 创建项目并开始上传流程
     */
    async function createProjectAndUpload() {
      try {
        const defaultName = 'Project_' + new Date().toLocaleString().replace(/[\/\s:]/g, '-');
        await createProjectViaPrompt(defaultName);
        
        // 若已选文件且组织已选，自动触发一次"上传数据"
        const submitBtn = document.getElementById('btn_submit_upload');
        if (uploadedFiles.length > 0 && submitBtn && !submitBtn.disabled) {
          submitBtn.click();
        }
      } catch(e) {
        console.error('Create project and upload failed:', e);
      }
    }

    /**
     * 渲染无项目空态 CTA
     */
    function renderUploadEmptyProjectCTA(mountEl) {
      if (!mountEl) return;
      if (currentProject) { 
        mountEl.innerHTML = ''; 
        return; 
      }
      
      mountEl.innerHTML = `
        <div class="continue-section" style="margin-bottom:12px;">
          <div class="continue-title">📁 ${gettext('开始前先建个项目？')}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btn_create_project" class="btn primary">${gettext('创建项目')}</button>
            <button id="btn_quick_upload_project" class="btn">${gettext('上传并新建项目')}</button>
          </div>
          <div class="continue-meta" style="margin-top:8px;color:var(--muted);font-size:12px;">
            ${gettext('项目用于归集数据与分析，便于权限与历史管理。')}
          </div>
        </div>
      `;
      
      // ★ 绑定创建项目按钮事件
      const btnCreate = document.getElementById('btn_create_project');
      const btnQuick = document.getElementById('btn_quick_upload_project');
      
      if (btnCreate) {
        btnCreate.onclick = async () => {
          try { 
            await createProjectViaPrompt(); 
          } catch(e) {
            console.error('Create project failed:', e);
          }
        };
      }
      
      if (btnQuick) {
        btnQuick.onclick = createProjectAndUpload;
      }
    }

    // -------------------- Upload View --------------------
    function renderUploadView() {
      const drop = document.getElementById('big_upload_drop');
      const input = document.getElementById('big_file_input');
      const list = document.getElementById('big_file_list');
      const submitBtn = document.getElementById('btn_submit_upload');
      const prog = document.getElementById('upload_progress');
      const ctaMount = document.getElementById('upload_project_cta_mount');

      // ★ 挂载无项目 CTA
      if (ctaMount) renderUploadEmptyProjectCTA(ctaMount);

      if (list) list.innerHTML = '';
      if (prog) prog.textContent = '';

      function renderBigList() {
        list.innerHTML = '';
        uploadedFiles.forEach((f, i) => {
          const row = document.createElement('div');
          row.className = 'file-item';
          row.innerHTML = `
            <div>
              <div class="name">${f.name}</div>
              <div class="size">${(f.size/1024/1024).toFixed(2)} MB</div>
            </div>
            <button data-idx="${i}" style="background:none;border:none;color:var(--err);cursor:pointer;">✕</button>
          `;
          list.appendChild(row);
        });
        updateUploadBtnDisabled();
      }

      function attachUploadEvents() {
        drop.addEventListener('click', () => input.click());
        drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
        drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
        drop.addEventListener('drop', e => {
          e.preventDefault(); drop.classList.remove('dragover');
          uploadedFiles = Array.from(e.dataTransfer.files || []);
          renderBigList();
        });
        input.addEventListener('change', () => {
          uploadedFiles = Array.from(input.files || []);
          renderBigList();
        });
        list.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-idx]');
          if (!btn) return;
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          uploadedFiles.splice(idx, 1);
          renderBigList();
        });
        submitBtn.addEventListener('click', submitUpload);
      }

      async function submitUpload() {
        if (!currentOrg) { alert(gettext('请选择组织')); return; }
        // ★ 若没有项目，则先引导创建（与 CTA 互补，确保一键成功）
        if (!currentProject) {
          try { await createProjectViaPrompt('Project_' + new Date().toLocaleString()); }
          catch(_) { return; }
        }
        if (uploadedFiles.length === 0) { alert(gettext('请先选择文件')); return; }

        setStepStatus('upload', 'running');
        if (prog) prog.textContent = gettext('正在上传...');

        try {
          // 1) 上传文件
          const fd = new FormData();
          const firstFile = uploadedFiles[0];
          fd.append('file', firstFile, firstFile.name);
          const res = await fetch(window.APP_URLS.API_STORAGE_UPLOAD, {
            method:'POST', headers:authHeaders(), body:fd
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();

          // 2) 创建数据集
          const datasetPayload = {
            project: currentProject,
            name: gettext('数据集') + ' ' + new Date().getTime(),
            dataset_type: 'single_cell',
            input_h5ad_path: data.path
          };
          const datasetRes = await fetch(window.APP_URLS.API_DATASETS, {
            method:'POST', headers:authHeaders({'Content-Type':'application/json'}),
            body: JSON.stringify(datasetPayload)
          });
          if (!datasetRes.ok) throw new Error(gettext('创建数据集失败：') + await datasetRes.text());
          const dataset = await datasetRes.json();
          currentDataset = dataset.id;

          // 3) 创建会话
          const sessionPayload = {
            dataset: currentDataset,
            name: gettext('分析会话') + ' ' + new Date().getTime(),
            description: gettext('新的单细胞分析会话')
          };
          const sessionRes = await fetch(window.APP_URLS.API_SESSIONS, {
            method:'POST', headers:authHeaders({'Content-Type':'application/json'}),
            body: JSON.stringify(sessionPayload)
          });
          if (!sessionRes.ok) throw new Error(gettext('创建会话失败：') + await sessionRes.text());
          const session = await sessionRes.json();
          currentSession = session.id;

          if (prog) prog.textContent = gettext('上传完成 ✅');
          setStepStatus('upload', 'completed');
          await loadSessionHistory();
          await loadProjectSessions(currentProject);
          setStepActive('qc');
        } catch(e) {
          if (prog) prog.textContent = gettext('上传失败：') + String(e.message || e);
          setStepStatus('upload', 'failed');
        } finally {
          updateRunButtonState();
        }
      }

      attachUploadEvents();
      renderBigList();
    }

    // -------------------- Init --------------------
    document.addEventListener('DOMContentLoaded', async function() {
      await fetchCurrentUser();
      await loadAvailableSteps();
      await restoreSessionState();

      // 绑定组织选择下拉框事件
      const orgSelect = document.getElementById('org_select');
      if (orgSelect) {
        orgSelect.addEventListener('change', onOrgChange);
      }

      // 绑定登录按钮事件
      const loginBtn = document.querySelector('#user_profile .login-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', showLoginModal);
      }

      const stepsContainer = document.getElementById('steps_container');
      if (stepsContainer) {
        stepsContainer.addEventListener('click', (e) => {
          const item = e.target.closest('.step-item');
          if (!item) return;
          const step = item.getAttribute('data-step');
          if (step !== 'upload' && (!currentDataset || !currentSession)) {
            alert(gettext('请先完成第 1 步：数据上传'));
            return;
          }
          setStepActive(step);
        });
      }

    /**
     * 删除分析会话
     * @param {string} sessionId - 要删除的会话ID
     */
    async function deleteSession(sessionId) {
      try {
        // 获取会话信息用于确认对话框
        const sessionRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, { 
          headers: authHeaders() 
        });
        
        if (!sessionRes.ok) {
          throw new Error(gettext('无法获取会话信息'));
        }
        
        const session = await sessionRes.json();
        const sessionName = session.name || `#${session.id}`;
        
        // 确认删除
        const confirmed = confirm(
          gettext('确定要删除分析会话"') + sessionName + gettext('"吗？') + '\n\n' +
          gettext('此操作不可恢复，将删除该会话的所有运行记录和结果。')
        );
        
        if (!confirmed) {
          return;
        }
        
        // 执行删除
        const deleteRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, {
          method: 'DELETE',
          headers: authHeaders()
        });
        
        if (!deleteRes.ok) {
          const errorText = await deleteRes.text();
          throw new Error(gettext('删除失败：') + errorText);
        }
        
        // 删除成功，刷新会话列表
        if (currentProject) {
          await loadProjectSessions(currentProject);
        }
        
        // 如果删除的是当前会话，清空当前会话状态
        if (currentSession === sessionId) {
          currentSession = null;
          currentDataset = null;
          setStepActive('upload');
          updateRunButtonState();
        }
        
        // 显示成功消息
        logMessage(gettext('会话"') + sessionName + gettext('"已删除'));
        
      } catch (e) {
        console.error('Delete session error:', e);
        alert(gettext('删除会话失败：') + (e.message || e));
      }
    }

      // 仅在没有恢复到其他会话时才默认设置为上传步骤
      if (!currentSession) setStepActive('upload');
    });
  </script>
{% endblock %}