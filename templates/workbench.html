{% extends 'base.html' %}
{% load i18n %}

{% block title %}CellInsightAI {% trans "å·¥ä½œå°" %}{% endblock %}

{% block extra_js %}
<!-- JavaScript i18n catalog -->
<script src="{% url 'javascript-catalog' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
  /* Main Layout */
  .main-container { display:grid; grid-template-columns:340px 1fr; height:calc(100vh - 105px); }

  /* Project Context Bar */
  .project-context {
    background:var(--panel); border-bottom:1px solid var(--border); padding:12px 24px;
    display:flex; align-items:center; justify-content:space-between; font-size:14px;
  }
  .project-info { display:flex; align-items:center; gap:12px; }
  .project-label { color:var(--muted); }
  .project-name {
    font-weight:600; color:var(--accent); cursor:pointer;
    text-decoration:underline; text-underline-offset:2px;
  }
  .project-name:hover { opacity:0.8; }
  .project-actions { display:flex; align-items:center; gap:8px; }
  .project-select {
    min-width:200px; background:var(--bg); border:1px solid var(--border);
    color:var(--text); border-radius:6px; padding:6px 12px;
  }

  /* Sidebar */
  .sidebar {
    background:var(--panel); border-right:1px solid var(--border); overflow-y:auto;
    display:flex; flex-direction:column;
  }
  .sidebar-section { padding:20px; border-bottom:1px solid var(--border); }
  .sidebar-section:last-child { border-bottom:none; flex:1; }
  .section-title { font-size:14px; font-weight:600; margin:0 0 16px 0; color:#bcd1ff; }

  /* Steps Section */
  .steps-container { max-height:400px; overflow-y:auto; }
  .step-item {
    display:flex; align-items:center; padding:12px; border-radius:8px; margin-bottom:8px;
    background:rgba(255,255,255,0.02); cursor:pointer; transition:all 0.2s;
  }
  .step-item:hover { background:rgba(255,255,255,0.06); }
  .step-item.active { background:var(--accent); color:white; }
  .step-item.completed { background:rgba(49,196,141,0.1); border:1px solid rgba(49,196,141,0.3); }
  .step-number {
    width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,0.1);
    display:flex; align-items:center; justify-content:center; font-size:12px; margin-right:12px;
  }
  .step-item.active .step-number { background:white; color:var(--accent); }
  .step-item.completed .step-number { background:var(--ok); color:white; }
  .step-info { flex:1; }
  .step-name { font-size:14px; font-weight:500; margin:0; }
  .step-desc { font-size:12px; color:var(--muted); margin:2px 0 0 0; }
  .step-status { font-size:11px; padding:2px 6px; border-radius:4px; }
  .step-status.pending { background:rgba(245,158,11,0.2); color:#f59e0b; }
  .step-status.running { background:rgba(79,141,245,0.2); color:var(--accent); }
  .step-status.completed { background:rgba(49,196,141,0.2); color:var(--ok); }
  .step-status.failed { background:rgba(244,63,94,0.2); color:#f43f5e; }

  /* Continue Analysis Section */
  .continue-section {
    background:rgba(79,141,245,0.1); border:1px solid rgba(79,141,245,0.3);
    border-radius:8px; padding:16px; margin-bottom:16px;
  }
  .continue-title {
    font-size:14px; font-weight:600; margin:0 0 12px 0; color:var(--accent);
    display:flex; align-items:center; gap:6px;
  }
  .continue-list { max-height:200px; overflow-y:auto; }
  .continue-item {
    background:rgba(255,255,255,0.04); border-radius:6px; padding:10px; margin-bottom:8px;
    cursor:pointer; transition:all 0.2s; display:flex; justify-content:space-between; align-items:center;
  }
  .continue-item:hover { background:rgba(255,255,255,0.08); }
  .continue-info { flex:1; }
  .continue-name { font-size:13px; font-weight:500; margin:0 0 2px 0; }
  .continue-meta { font-size:11px; color:var(--muted); }
  .continue-actions { display:flex; gap:6px; align-items:center; }
  .continue-btn {
    padding:4px 8px; background:var(--accent); color:white; border:none;
    border-radius:4px; font-size:11px; cursor:pointer;
  }
  .continue-btn:hover { background:#3b7ce6; }
  .delete-btn {
    padding:4px 8px; background:var(--err); color:white; border:none;
    border-radius:4px; font-size:11px; cursor:pointer;
  }
  .delete-btn:hover { background:#d93025; }

  /* Main Content */
  .content { display:flex; flex-direction:column; overflow:hidden; }

  /* Workflow Header */
  .workflow-header {
    padding:20px 24px; border-bottom:1px solid var(--border); background:var(--panel);
    display:flex; align-items:center; justify-content:space-between;
  }
  .workflow-title { font-size:20px; font-weight:600; margin:0; }
  .workflow-actions { display:flex; gap:12px; }

  .btn {
    padding:10px 20px; border-radius:8px; font-size:14px; font-weight:500;
    border:1px solid transparent; cursor:pointer; transition:all 0.2s ease;
  }
  .btn.primary { background:var(--accent); color:white; border:1px solid var(--accent); box-shadow:0 2px 8px rgba(79,141,245,0.3); }
  .btn.primary:hover:not(:disabled) { background:#3b7ce6; border-color:#3b7ce6; box-shadow:0 4px 12px rgba(79,141,245,0.4); transform:translateY(-1px); }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* Tabs */
  .tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel); }
  .tab { padding:12px 20px; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; font-size:14px; }
  .tab:hover { background:var(--hover); }
  .tab.active { border-bottom-color:var(--accent); color:var(--accent); }

  /* Tab Content */
  .tab-content { flex:1; overflow:auto; }
  .tab-pane { display:none; padding:24px; height:100%; }
  .tab-pane.active { display:block; }

  /* Parameters Panel */
  .params-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px; }
  .param-group {
    background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:16px;
  }
  .param-group h3 { font-size:14px; margin:0 0 12px 0; color:#bcd1ff; }
  .param-row { margin-bottom:12px; }
  .param-row:last-child { margin-bottom:0; }
  .param-label { display:block; font-size:13px; color:#bcd1ff; margin-bottom:6px; }
  .param-input { width:100%; }

  /* Upload (big panel) */
  .upload-area {
    border:2px dashed rgba(255,255,255,0.2); border-radius:12px; padding:28px; text-align:center;
    cursor:pointer; transition:all 0.2s;
  }
  .upload-area:hover, .upload-area.dragover { border-color:var(--accent); background:rgba(79,141,245,0.05); }
  .upload-icon { font-size:36px; margin-bottom:12px; opacity:0.6; }
  .upload-text { margin:8px 0; }
  .upload-hint { font-size:12px; color:var(--muted); }
  .file-list { margin-top:16px; }
  .file-item {
    display:flex; align-items:center; justify-content:space-between; padding:8px 12px;
    background:rgba(255,255,255,0.04); border-radius:6px; margin-bottom:8px;
  }
  .file-item .name { font-size:14px; }
  .file-item .size { font-size:12px; color:var(--muted); }

  /* Results Panel */
  .results-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; height:100%; }
  .result-panel {
    background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px;
    display:flex; flex-direction:column;
  }
  .panel-header { padding:16px; border-bottom:1px solid var(--border); font-weight:600; }
  .panel-content { flex:1; padding:16px; overflow:auto; }
  .chart-placeholder {
    height:300px; background:rgba(255,255,255,0.02); border-radius:8px;
    display:flex; align-items:center; justify-content:center; color:var(--muted);
  }

  /* Artifact files list */
  .artifact-files { margin-top: 12px; }
  .artifact-item {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 12px; border:1px solid var(--border); border-radius:6px;
    background:rgba(255,255,255,0.02); margin-bottom:8px;
  }
  .artifact-item .name { font-size:14px; font-weight:500; }
  .artifact-item .meta { font-size:12px; color:var(--muted); }

  /* Metrics */
  .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px; }
  .metric-card { background:rgba(255,255,255,0.04); border-radius:8px; padding:12px; text-align:center; }
  .metric-value { font-size:20px; font-weight:600; margin-bottom:4px; }
  .metric-label { font-size:12px; color:var(--muted); }
  .metric-card.ok .metric-value { color:var(--ok); }
  .metric-card.warn .metric-value { color:var(--warn); }
  .metric-card.err .metric-value { color:var(--err); }

  /* Log */
  .log-container {
    background:#0a1120; border:1px solid var(--border); border-radius:8px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    height:200px; overflow:auto; padding:12px; font-size:12px; color:#a7b6d9;
  }

  /* Project Selection Modal (å ä½ï¼Œå½“å‰ç”¨ prompt ç®€åŒ–) */
  .project-selection-overlay { display:none; }
</style>
{% endblock %}

{% block content %}
  <!-- Organization Selector -->
  <div style="background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <label style="font-size:14px;color:var(--muted);margin-right:8px;">{% trans "å½“å‰ç»„ç»‡:" %}</label>
      <select id="org_select" style="min-width:200px;" onchange="onOrgChange()">
        <option value="">{% trans "é€‰æ‹©ç»„ç»‡..." %}</option>
      </select>
    </div>
    <div id="user_profile" style="display:none;">
      <span id="user_name">{% trans "æœªç™»å½•" %}</span>
      <button class="login-btn" onclick="showLoginModal()" style="margin-left:12px;padding:6px 12px;background:var(--accent);color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;">{% trans "ç‚¹å‡»ç™»å½•" %}</button>
    </div>
  </div>

  <!-- Project Context Bar -->
  <div class="project-context">
    <div class="project-info">
      <span class="project-label">{% trans "å½“å‰é¡¹ç›®:" %}</span>
      <span class="project-name" id="current_project_name" onclick="showProjectSelector()">{% trans "æœªé€‰æ‹©é¡¹ç›®" %}</span>
    </div>
    <div class="project-actions">
      <select class="project-select" id="project_quick_select" onchange="onProjectQuickChange()" style="display:none;">
        <option value="">{% trans "åˆ‡æ¢é¡¹ç›®..." %}</option>
      </select>
      <a href="{{ APP_URLS.PROJECTS }}" style="color:var(--muted);text-decoration:none;font-size:13px;">{% trans "ğŸ“ é¡¹ç›®ç®¡ç†" %}</a>
    </div>
  </div>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Continue Analysis -->
      <div class="sidebar-section" id="continue_section" style="display:none;">
        <div class="continue-section">
          <div class="continue-title">
            ğŸ”„ {% trans "ç»§ç»­åˆ†æ" %}
          </div>
          <div class="continue-list" id="continue_list"></div>
        </div>
      </div>

      <!-- Analysis Steps -->
      <div class="sidebar-section">
        <h2 class="section-title">ğŸ”¬ {% trans "åˆ†ææ­¥éª¤" %}</h2>
        <div class="steps-container" id="steps_container">
          <div class="step-item" data-step="upload">
            <div class="step-number">1</div>
            <div class="step-info">
              <div class="step-name">{% trans "æ•°æ®ä¸Šä¼ " %}</div>
              <div class="step-desc">{% trans "ä¸Šä¼ åŸå§‹æ•°æ®æ–‡ä»¶" %}</div>
            </div>
            <div class="step-status pending">{% trans "å¾…å¤„ç†" %}</div>
          </div>
          <div class="step-item" data-step="qc">
            <div class="step-number">2</div>
            <div class="step-info">
              <div class="step-name">{% trans "è´¨é‡æ§åˆ¶" %}</div>
              <div class="step-desc">{% trans "è¿‡æ»¤ä½è´¨é‡ç»†èƒå’ŒåŸºå› " %}</div>
            </div>
            <div class="step-status pending">{% trans "å¾…å¤„ç†" %}</div>
          </div>
          <div class="step-item" data-step="hvg">
            <div class="step-number">3</div>
            <div class="step-info">
              <div class="step-name">{% trans "é«˜å˜åŸºå› " %}</div>
              <div class="step-desc">{% trans "è¯†åˆ«é«˜å˜å¼‚åŸºå› " %}</div>
            </div>
            <div class="step-status pending">{% trans "å¾…å¤„ç†" %}</div>
          </div>
          <div class="step-item" data-step="pca">
            <div class="step-number">4</div>
            <div class="step-info">
              <div class="step-name">{% trans "ä¸»æˆåˆ†åˆ†æ" %}</div>
              <div class="step-desc">{% trans "é™ç»´å¤„ç†" %}</div>
            </div>
            <div class="step-status pending">{% trans "å¾…å¤„ç†" %}</div>
          </div>
          <div class="step-item" data-step="umap">
            <div class="step-number">5</div>
            <div class="step-info">
              <div class="step-name">{% trans "UMAPåµŒå…¥" %}</div>
              <div class="step-desc">{% trans "2Då¯è§†åŒ–" %}</div>
            </div>
            <div class="step-status pending">{% trans "å¾…å¤„ç†" %}</div>
          </div>
          <div class="step-item" data-step="clustering">
            <div class="step-number">6</div>
            <div class="step-info">
              <div class="step-name">{% trans "ç»†èƒèšç±»" %}</div>
              <div class="step-desc">{% trans "è¯†åˆ«ç»†èƒç±»å‹" %}</div>
            </div>
            <div class="step-status pending">{% trans "å¾…å¤„ç†" %}</div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="sidebar-section">
        <h2 class="section-title">ğŸ“Š {% trans "è¿è¡Œå†å²" %}</h2>
        <div class="history-list" id="history_list">
          <div style="text-align:center; color:var(--muted); padding:20px;">{% trans "æš‚æ— è¿è¡Œè®°å½•" %}</div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Header -->
      <div class="workflow-header">
        <h1 class="workflow-title" id="workflow_title">{% trans "æ•°æ®ä¸Šä¼ " %}</h1>
        <div class="workflow-actions">
          <!-- Run æŒ‰é’®ä»…åœ¨éä¸Šä¼ æ­¥éª¤æ˜¾ç¤º -->
          <button class="btn primary" id="run_btn" onclick="runCurrentStep()" style="display:none;" disabled>
            {% trans "å¼€å§‹åˆ†æ" %}
          </button>
        </div>
      </div>

      <!-- Tabsï¼ˆä»…åœ¨éä¸Šä¼ æ­¥éª¤æ˜¾ç¤ºï¼‰ -->
      <div id="tabs_wrapper" style="display:none;">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('params', event)">{% trans "å‚æ•°é…ç½®" %}</div>
          <div class="tab" onclick="switchTab('results', event)">{% trans "ç»“æœå±•ç¤º" %}</div>
          <div class="tab" onclick="switchTab('logs', event)">{% trans "è¿è¡Œæ—¥å¿—" %}</div>
        </div>

        <div class="tab-content">
          <!-- Parameters Tab -->
          <div class="tab-pane active" id="tab_params">
            <div class="params-grid" id="params_grid"></div>
          </div>

          <!-- Results Tab -->
          <div class="tab-pane" id="tab_results">
            <div class="results-grid">
              <div class="result-panel">
                <div class="panel-header">ğŸ“Š {% trans "å…³é”®æŒ‡æ ‡" %}</div>
                <div class="panel-content">
                  <div class="metrics-grid" id="metrics_grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <!-- åŸå§‹æ•°æ®æŒ‡æ ‡ -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_cells_raw">-</div>
                      <div class="metric-label">{% trans "åŸå§‹ç»†èƒæ•°" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_genes_raw">-</div>
                      <div class="metric-label">{% trans "åŸå§‹åŸºå› æ•°" %}</div>
                    </div>
                    
                    <!-- è¿‡æ»¤åæ•°æ®æŒ‡æ ‡ -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_cells_filtered">-</div>
                      <div class="metric-label">{% trans "è¿‡æ»¤åç»†èƒæ•°" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_genes_filtered">-</div>
                      <div class="metric-label">{% trans "è¿‡æ»¤ååŸºå› æ•°" %}</div>
                    </div>
                    
                    <!-- ç§»é™¤ç‡æŒ‡æ ‡ -->
                    <div class="metric-card warn">
                      <div class="metric-value" id="metric_cells_removal_rate">-</div>
                      <div class="metric-label">{% trans "ç»†èƒç§»é™¤ç‡" %}</div>
                    </div>
                    <div class="metric-card warn">
                      <div class="metric-value" id="metric_genes_removal_rate">-</div>
                      <div class="metric-label">{% trans "åŸºå› ç§»é™¤ç‡" %}</div>
                    </div>
                    
                    <!-- æ¯ç»†èƒç»Ÿè®¡æŒ‡æ ‡ -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_mean_genes_per_cell">-</div>
                      <div class="metric-label">{% trans "å¹³å‡åŸºå› /ç»†èƒ" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_median_genes_per_cell">-</div>
                      <div class="metric-label">{% trans "ä¸­ä½åŸºå› /ç»†èƒ" %}</div>
                    </div>
                    
                    <!-- UMI ç»Ÿè®¡æŒ‡æ ‡ -->
                    <div class="metric-card">
                      <div class="metric-value" id="metric_mean_umis_per_cell">-</div>
                      <div class="metric-label">{% trans "å¹³å‡UMI/ç»†èƒ" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_median_umis_per_cell">-</div>
                      <div class="metric-label">{% trans "ä¸­ä½UMI/ç»†èƒ" %}</div>
                    </div>
                    
                    <!-- è´¨é‡æŒ‡æ ‡ -->
                    <div class="metric-card err">
                      <div class="metric-value" id="metric_mean_mito_pct">-</div>
                      <div class="metric-label">{% trans "å¹³å‡çº¿ç²’ä½“%" %}</div>
                    </div>
                    <div class="metric-card">
                      <div class="metric-value" id="metric_mean_ribo_pct">-</div>
                      <div class="metric-label">{% trans "å¹³å‡æ ¸ç³–ä½“%" %}</div>
                    </div>
                  </div>
                  <div class="chart-placeholder">
                    {% trans "åˆ†æå®Œæˆåå°†æ˜¾ç¤º UMAP å›¾è¡¨" %}
                  </div>
                  <div class="artifact-files" id="artifact_files"></div>
                </div>
              </div>
              <div class="result-panel">
                <div class="panel-header">ğŸ¤– {% trans "AI å»ºè®®" %}</div>
                <div class="panel-content">
                  <div id="advice_content" style="color:var(--muted); text-align:center; padding:40px 20px;">
                    {% trans "è¿è¡Œåˆ†æåå°†æ˜¾ç¤º AI ä¼˜åŒ–å»ºè®®" %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Logs Tab -->
          <div class="tab-pane" id="tab_logs">
            <div class="log-container" id="log_container">
              <div style="color:var(--muted);">[{% trans "ç³»ç»Ÿ" %}] {% trans "ç­‰å¾…å¼€å§‹åˆ†æ..." %}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Onlyï¼ˆä»…åœ¨ç¬¬ 1 æ­¥æ˜¾ç¤ºï¼‰ -->
      <div id="upload_only_view" style="padding:24px;">
        <div id="upload_project_cta_mount"></div> <!-- â˜… æ— é¡¹ç›®æ—¶çš„ CTA æŒ‚è½½ç‚¹ -->
        <div class="params-grid">
          <div class="param-group">
            <h3>ğŸ“ {% trans "ä¸Šä¼ å•ç»†èƒæ•°æ®" %}</h3>
            <p style="color:var(--muted);line-height:1.6;">
              {% trans "æ”¯æŒ .h5ad, .h5, .csv, .mtx, .zip ç­‰ï¼›å¯æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹©ã€‚" %}
              <br>
              {% trans "é€‰æ‹©æ–‡ä»¶åï¼Œç‚¹å‡»â€œä¸Šä¼ æ•°æ®â€å¼€å§‹ä¸Šä¼ ï¼›å®Œæˆåå°†è‡ªåŠ¨è¿›å…¥è´¨é‡æ§åˆ¶æ­¥éª¤ã€‚" %}
            </p>
            <div id="big_upload_drop" class="upload-area" style="margin-top:12px;">
              <div class="upload-icon">ğŸ“¤</div>
              <div class="upload-text">{% trans "ç‚¹å‡»æˆ–æ‹–æ‹½åˆ°æ­¤å¤„é€‰æ‹©æ–‡ä»¶" %}</div>
              <div class="upload-hint">{% trans "å»ºè®®ä¼˜å…ˆä½¿ç”¨ .h5ad æˆ– 10x å‹ç¼©åŒ…" %}</div>
              <input type="file" id="big_file_input" style="display:none" multiple
                     accept=".h5ad,.h5,.csv,.mtx,.tsv,.txt,.gz,.zip">
            </div>
            <div class="file-list" id="big_file_list" style="margin-top:12px;"></div>
            <div style="display:flex;gap:12px;margin-top:16px;">
              <!-- ä»…ä¿ç•™â€œä¸Šä¼ æ•°æ®â€æŒ‰é’® -->
              <button id="btn_submit_upload" class="btn primary" type="button" disabled>{% trans "ä¸Šä¼ æ•°æ®" %}</button>
            </div>
            <div id="upload_progress" style="margin-top:12px;color:var(--muted);"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal hidden" id="login_modal">
    <div class="modal-content">
      <h2 class="modal-title">{% trans "ç™»å½• CellInsightAI" %}</h2>
      <div class="modal-row">
        <label class="param-label">{% trans "é‚®ç®±æˆ–ç”¨æˆ·å" %}</label>
        <input type="text" id="login_email" class="param-input" placeholder="your@email.com">
      </div>
      <div class="modal-row">
        <label class="param-label">{% trans "å¯†ç " %}</label>
        <input type="password" id="login_password" class="param-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="hideLoginModal()">{% trans "å–æ¶ˆ" %}</button>
        <button class="btn" onclick="demoLogin()">{% trans "Demo ç™»å½•" %}</button>
        <button class="btn primary" onclick="doLogin()">{% trans "ç™»å½•" %}</button>
      </div>
    </div>
  </div>

  <script id="app-urls" type="application/json">{{ APP_URLS_JSON|safe }}</script>

  <script>
    // -------------------- Global State --------------------
    let currentUser = null;
    let currentOrg = localStorage.getItem('active_org') || null;
    let currentStep = 'upload';
    let uploadedFiles = [];
    let currentProject = null;
    let currentDataset = null;
    let currentSession = null;
    let availableSteps = [];
    let availableProjects = [];
    let recentSessions = [];

    /**
     * ä¿å­˜å½“å‰ä¼šè¯ç›¸å…³çŠ¶æ€åˆ° localStorage
     * - ä¿å­˜é”®ï¼šci_current_project, ci_current_dataset, ci_current_session, ci_current_step
     */
    function saveSessionState() {
      try {
        if (currentProject) localStorage.setItem('ci_current_project', String(currentProject));
        else localStorage.removeItem('ci_current_project');

        if (currentDataset) localStorage.setItem('ci_current_dataset', String(currentDataset));
        else localStorage.removeItem('ci_current_dataset');

        if (currentSession) localStorage.setItem('ci_current_session', String(currentSession));
        else localStorage.removeItem('ci_current_session');

        if (currentStep) localStorage.setItem('ci_current_step', String(currentStep));
        else localStorage.removeItem('ci_current_step');

        // åŒæ­¥ selected_projectï¼ˆå·²æœ‰é€»è¾‘ä½¿ç”¨è¯¥é”®ï¼‰
        if (currentProject) localStorage.setItem('selected_project', String(currentProject));
        else localStorage.removeItem('selected_project');

        console.log('[persist] saved session state', { currentProject, currentDataset, currentSession, currentStep });
      } catch (e) {
        console.warn('saveSessionState failed:', e);
      }
    }

    /**
     * ä» localStorage æ¢å¤ä¼šè¯çŠ¶æ€
     * - è‹¥å­˜åœ¨ session åˆ™è°ƒç”¨ enterSession è¿›å…¥å¹¶æ¢å¤æ­¥éª¤
     * - è‹¥åªæœ‰ project åˆ™åŠ è½½è¯¥é¡¹ç›®çš„ä¼šè¯åˆ—è¡¨
     */
    async function restoreSessionState() {
      try {
        const p = localStorage.getItem('ci_current_project');
        const s = localStorage.getItem('ci_current_session');
        const d = localStorage.getItem('ci_current_dataset');
        const step = localStorage.getItem('ci_current_step') || 'qc';

        if (p) currentProject = p;
        if (d) currentDataset = d;

        if (s) {
          console.log('[persist] restoring session:', { p, s, d, step });
          await enterSession(s);
          if (step && step !== 'upload') setStepActive(step);
        } else if (p) {
          await loadProjectSessions(p);
          updateProjectUI();
          setStepActive('upload');
        }
      } catch (e) {
        console.warn('restoreSessionState failed:', e);
      } finally {
        updateRunButtonState();
      }
    }

    // ============ Project Context Helpers ============
    function updateProjectUI() {
      const nameEl = document.getElementById('current_project_name');
      const quickSelect = document.getElementById('project_quick_select');
      const cur = currentProject && availableProjects.find(p => String(p.id) === String(currentProject));
      if (nameEl) nameEl.textContent = cur ? (cur.name || ('#' + cur.id)) : gettext('æœªé€‰æ‹©é¡¹ç›®');
      if (quickSelect) {
        quickSelect.style.display = availableProjects.length ? '' : 'none';
        if (cur) quickSelect.value = String(cur.id);
      }
      updateUploadBtnDisabled();
      // æ— é¡¹ç›®æ—¶ï¼Œæ¸²æŸ“ä¸Šä¼ è§†å›¾é¡¶éƒ¨ CTA
      const ctaMount = document.getElementById('upload_project_cta_mount');
      if (ctaMount) renderUploadEmptyProjectCTA(ctaMount);
    }

    async function loadAvailableProjects() {
      if (!currentOrg) { availableProjects = []; updateProjectUI(); return; }
      try {
        const url = `${window.APP_URLS.API_PROJECTS}?organization=${encodeURIComponent(currentOrg)}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        availableProjects = Array.isArray(data) ? data : (data.results || []);
        const quickSelect = document.getElementById('project_quick_select');
        if (quickSelect) {
          quickSelect.innerHTML = `<option value="">${gettext('åˆ‡æ¢é¡¹ç›®...')}</option>` +
            availableProjects.map(p => `<option value="${p.id}">${p.name || ('#' + p.id)}</option>`).join('');
        }
        updateProjectUI();
      } catch (e) {
        console.error('loadAvailableProjects error:', e);
        availableProjects = [];
        updateProjectUI();
      }
    }

    async function initProjectContext() {
      const fromUrl = new URLSearchParams(location.search).get('project');
      const fromStore = localStorage.getItem('selected_project');
      currentProject = fromUrl || fromStore || null;
      if (currentProject && !availableProjects.find(p => String(p.id) === String(currentProject))) {
        currentProject = null;
      }
      updateProjectUI();
      if (currentProject) {
        await loadProjectSessions(currentProject);
      } else {
        renderContinueList([]);
      }
    }

    function showProjectSelector() {
      const quickSelect = document.getElementById('project_quick_select');
      if (!quickSelect) return;
      quickSelect.style.display = '';
      quickSelect.focus();
    }

    async function onProjectQuickChange() {
      const quickSelect = document.getElementById('project_quick_select');
      if (!quickSelect) return;
      const val = quickSelect.value || '';
      currentProject = val || null;
      if (currentProject) {
        localStorage.setItem('selected_project', currentProject);
        await loadProjectSessions(currentProject);
      } else {
        localStorage.removeItem('selected_project');
        renderContinueList([]);
      }
      updateProjectUI();
    }

    async function loadProjectSessions(projectId) {
      try {
        const url = `${window.APP_URLS.API_SESSIONS}?project=${encodeURIComponent(projectId)}&ordering=-updated_at&limit=10`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        recentSessions = Array.isArray(data) ? data : (data.results || []);
        renderContinueList(recentSessions);
      } catch (e) {
        console.error('loadProjectSessions error:', e);
        renderContinueList([]);
      }
    }

    function renderContinueList(list) {
      const sec = document.getElementById('continue_section');
      const ul = document.getElementById('continue_list');
      if (!sec || !ul) return;
      if (!list.length) {
        sec.style.display = 'none';
        ul.innerHTML = '';
        return;
      }
      sec.style.display = '';
      ul.innerHTML = list.map(s => {
        const status = s.status || 'paused';
        const step = s.current_step || 'upload';
        const when = s.updated_at ? new Date(s.updated_at).toLocaleString() : '';
        const label = s.name || (`#${s.id}`);
        return `
          <div class="continue-item" data-session-id="${s.id}">
            <div class="continue-info">
              <div class="continue-name">${label}</div>
              <div class="continue-meta">${gettext('çŠ¶æ€')}: ${status} Â· ${gettext('å½“å‰æ­¥éª¤')}: ${step} Â· ${when}</div>
            </div>
            <div class="continue-actions">
              <button class="continue-btn" data-action="continue" data-session-id="${s.id}">${gettext('ç»§ç»­')}</button>
              <button class="delete-btn" data-action="delete" data-session-id="${s.id}" title="${gettext('åˆ é™¤æ­¤ä¼šè¯')}">${gettext('åˆ é™¤')}</button>
            </div>
          </div>
        `;
      }).join('');

      ul.onclick = async (e) => {
        e.stopPropagation();
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        
        const action = btn.getAttribute('data-action');
        const sid = btn.getAttribute('data-session-id');
        if (!sid) return;
        
        if (action === 'continue') {
          await enterSession(sid);
        } else if (action === 'delete') {
          await deleteSession(sid);
        }
      };
    }

    async function enterSession(sessionId) {
      try {
        const url = `${window.APP_URLS.API_SESSIONS}${sessionId}/`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const s = await res.json();
        currentSession = s.id;
        currentDataset = s.dataset;
        currentProject = s.project || currentProject;
        
        // æŒä¹…åŒ–ä¼šè¯çŠ¶æ€åˆ° localStorage
        saveSessionState();
        
        updateProjectUI();
        await loadSessionHistory();
        const step = s.current_step || 'qc';
        setStepActive(step);
      } catch (e) {
        console.error('enterSession error:', e);
        alert(gettext('åŠ è½½ä¼šè¯å¤±è´¥'));
      } finally {
        updateRunButtonState();
      }
    }

    /**
     * åˆ é™¤ä¼šè¯åŠŸèƒ½
     * @param {string} sessionId - è¦åˆ é™¤çš„ä¼šè¯ID
     */
    async function deleteSession(sessionId) {
      if (!sessionId) {
        console.error('Session ID is required for deletion');
        return;
      }

      try {
        // é¦–å…ˆè·å–ä¼šè¯ä¿¡æ¯ç”¨äºç¡®è®¤
        const sessionRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, {
          headers: authHeaders()
        });
        
        if (!sessionRes.ok) {
          throw new Error(gettext('æ— æ³•è·å–ä¼šè¯ä¿¡æ¯'));
        }
        
        const session = await sessionRes.json();
        const sessionName = session.name || `#${session.id}`;
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        const confirmMessage = gettext('ç¡®å®šè¦åˆ é™¤ä¼šè¯ "') + sessionName + gettext('" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œæ‰€æœ‰ç›¸å…³çš„åˆ†ææ•°æ®å’Œå†å²è®°å½•éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚');
        
        if (!confirm(confirmMessage)) {
          return; // ç”¨æˆ·å–æ¶ˆæ“ä½œ
        }

        // æ‰§è¡Œåˆ é™¤æ“ä½œ
        const deleteRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (!deleteRes.ok) {
          const errorText = await deleteRes.text();
          throw new Error(gettext('åˆ é™¤å¤±è´¥ï¼š') + errorText);
        }

        // åˆ é™¤æˆåŠŸåçš„å¤„ç†
        console.log('Session deleted successfully:', sessionId);
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ´»åŠ¨ä¼šè¯ï¼Œéœ€è¦é‡ç½®ä¸Šä¸‹æ–‡
        if (currentSession && String(currentSession) === String(sessionId)) {
          currentSession = null;
          currentDataset = null;
          // ä¸é‡ç½® currentProjectï¼Œè®©ç”¨æˆ·ä¿æŒåœ¨å½“å‰é¡¹ç›®
          
          // åˆ‡æ¢åˆ°ä¸Šä¼ æ­¥éª¤
          setStepActive('upload');
          
          // æ¸…ç©ºå†å²è®°å½•
          const historyList = document.getElementById('history_list');
          if (historyList) {
            historyList.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">' + gettext('æš‚æ— è¿è¡Œè®°å½•') + '</div>';
          }
          
          // æ›´æ–°è¿è¡ŒæŒ‰é’®çŠ¶æ€
          updateRunButtonState();
        }

        // åˆ·æ–°ä¼šè¯åˆ—è¡¨
        if (currentProject) {
          await loadProjectSessions(currentProject);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        logMessage(gettext('ä¼šè¯ "') + sessionName + gettext('" å·²æˆåŠŸåˆ é™¤'));
        
      } catch (error) {
        console.error('Delete session error:', error);
        alert(gettext('åˆ é™¤ä¼šè¯å¤±è´¥ï¼š') + (error.message || error));
      }
    }

    // -------------------- Utils --------------------
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }
    function getCsrfToken() { return getCookie('csrftoken') || ''; }
    function authHeaders(extra = {}) {
      const h = { 'X-CSRFToken': getCsrfToken() };
      if (currentOrg) h['X-Org'] = currentOrg;
      return Object.assign(h, extra);
    }
    function logMessage(message) {
      const container = document.getElementById('log_container');
      if (!container) return;
      const timestamp = new Date().toLocaleTimeString();
      container.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      container.scrollTop = container.scrollHeight;
    }

    // -------------------- App URLs --------------------
    try {
      window.APP_URLS = JSON.parse(document.getElementById('app-urls').textContent || '{}');
    } catch (e) {
      window.APP_URLS = {};
      console.error('Failed to parse APP_URLS JSON', e);
    }
    // ========= æ–°å¢å¸®åŠ©å‡½æ•°ï¼ˆæ”¾åœ¨æœ€ä¸Šé¢çš„â€œGlobal Stateâ€é™„è¿‘æˆ– Utils ä¸Šæ–¹éƒ½å¯ä»¥ï¼‰ =========
    function getOrganizationsUrl() {
      // å…¼å®¹ API_ORGANIZATIONS / API_ORGS ä¸¤ç§ key
      const u = window.APP_URLS || {};
      return u.API_ORGANIZATIONS || u.API_ORGS || '/api/v1/organizations/';
    }
    function getDefaultOrgFromUser(user) {
      // å°½é‡ä» /me è¿”å›é‡Œå–é»˜è®¤ç»„ç»‡ï¼›å…¼å®¹ä¸åŒå­—æ®µå‘½å
      if (!user) return null;
      if (user.profile && (user.profile.organization || (user.profile.organization_id))) {
        return String(user.profile.organization?.id || user.profile.organization_id || user.profile.organization);
      }
      if (user.default_organization || user.default_organization_id) {
        return String(user.default_organization?.id || user.default_organization_id || user.default_organization);
      }
      // ä¸€äº›åç«¯ä¼šæŠŠå½“å‰ org æ”¾åœ¨ user.organization
      if (user.organization || user.organization_id) {
        return String(user.organization?.id || user.organization_id || user.organization);
      }
      return null;
    }
    function setCurrentOrg(orgId) {
      currentOrg = orgId ? String(orgId) : null;
      const sel = document.getElementById('org_select');
      if (sel) sel.value = currentOrg || '';
      if (currentOrg) localStorage.setItem('active_org', currentOrg);
      else localStorage.removeItem('active_org');
    }
    // ========= æ›¿æ¢ fetchCurrentUser å‡½æ•° =========
    async function fetchCurrentUser() {
      try {
        const res = await fetch(window.APP_URLS.API_USER_ME, { headers: authHeaders() });
        const userProfile = document.getElementById('user_profile');
        const userName = document.getElementById('user_name');
        const loginBtn = userProfile.querySelector('.login-btn');

        if (res.ok) {
          const user = await res.json();
          currentUser = user;
          userName.textContent = user.username || user.email || gettext('ç”¨æˆ·');
          loginBtn.textContent = gettext('å·²ç™»å½•');
          loginBtn.style.background = 'var(--ok)';
          loginBtn.onclick = null;
          userProfile.style.display = 'block';

          // å…³é”®ï¼šåœ¨è¿™é‡Œå…ˆè§£æâ€œé»˜è®¤ç»„ç»‡â€ï¼Œå¦‚æœ‰åˆ™è¦†ç›–æœ¬åœ°çš„ active_org
          const userDefaultOrg = getDefaultOrgFromUser(user);
          // å¦‚æœæœ¬åœ°æ²¡æœ‰ active_org æˆ–æœ¬åœ°çš„å¹¶ä¸å­˜åœ¨äºè¯¥ç”¨æˆ·ï¼Œç»Ÿä¸€ä»¥ç”¨æˆ·é»˜è®¤ç»„ç»‡ä¸ºå‡†
          if (!currentOrg || currentOrg === 'undefined') {
            setCurrentOrg(userDefaultOrg);
          }

          await loadOrganizations(user);        // ä¼  userï¼Œæ–¹ä¾¿å‡½æ•°å†…éƒ¨å…œåº•
          await loadAvailableProjects();        // ä¾èµ– currentOrg çš„åˆ—è¡¨
          await initProjectContext();
        } else {
          // æœªç™»å½•åˆ†æ”¯
          currentUser = null;
          userName.textContent = gettext('æœªç™»å½•');
          loginBtn.textContent = gettext('ç‚¹å‡»ç™»å½•');
          loginBtn.style.background = 'var(--accent)';
          loginBtn.onclick = showLoginModal;
          userProfile.style.display = 'block';
          // æ¸…ç©ºæœ¬åœ° org
          setCurrentOrg(null);
        }
      } catch (e) {
        console.error('Error fetching user:', e);
      }
    }
    // ========= æ›¿æ¢ loadOrganizations å‡½æ•°ï¼ˆæ–°å¢ user å‚æ•°ï¼Œè‡ªåŠ¨é€‰ä¸­é€»è¾‘ï¼‰ =========
    async function loadOrganizations(user = currentUser) {
      if (!user) return;
      try {
        const url = getOrganizationsUrl();
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error(await res.text());
        const orgs = await res.json();

        const orgSelect = document.getElementById('org_select');
        if (orgSelect) {
          orgSelect.innerHTML = '<option value="">' + gettext('é€‰æ‹©ç»„ç»‡...') + '</option>';
          // å…¼å®¹è¿”å›ç»“æ„ï¼šæ•°ç»„æˆ– {results: []}
          const list = Array.isArray(orgs) ? orgs : (orgs.results || []);
          list.forEach(org => {
            const option = document.createElement('option');
            option.value = String(org.id);
            option.textContent = org.name || ('#' + org.id);
            orgSelect.appendChild(option);
          });

          // è‡ªåŠ¨é€‰æ‹©ç­–ç•¥ï¼š
          // 1) currentOrgï¼ˆå¦‚æœåˆæ³•ï¼‰ï¼›
          // 2) ç”¨æˆ·é»˜è®¤ç»„ç»‡ getDefaultOrgFromUser(user)ï¼›
          // 3) åªæœ‰ä¸€ä¸ªç»„ç»‡æ—¶é€‰å®ƒï¼›
          // 4) å¦åˆ™ä¿æŒç©º
          const userDefaultOrg = getDefaultOrgFromUser(user);
          const ids = list.map(o => String(o.id));
          let nextOrg = null;

          if (currentOrg && ids.includes(String(currentOrg))) {
            nextOrg = String(currentOrg);
          } else if (userDefaultOrg && ids.includes(String(userDefaultOrg))) {
            nextOrg = String(userDefaultOrg);
          } else if (list.length === 1) {
            nextOrg = String(list[0].id);
          }

          setCurrentOrg(nextOrg);  // ä¼šåŒæ­¥ select + localStorage
        }
      } catch (e) {
        console.error('Failed to load organizations:', e);
      }
    }

    async function autoSelectFirstOrganization() {
      try {
        console.log('Attempting to auto-select organization...');
        const res = await fetch(window.APP_URLS.API_ORGANIZATIONS, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          const orgsList = Array.isArray(data) ? data : (data.results || []);
          console.log('Organizations response:', orgsList);
          
          if (orgsList.length > 0) {
            const lowerEq = (a,b) => String(a||'').toLowerCase() === String(b||'').toLowerCase();
            const lowerInc = (a,b) => String(a||'').toLowerCase().includes(String(b||'').toLowerCase());
            
            // 1) ç²¾ç¡®åŒ¹é…åç§°ä¸º 'Demo Org'
            let targetOrg = orgsList.find(org => lowerEq(org.name, 'Demo Org'));
            // 2) å…¶æ¬¡ï¼šåç§°åŒ…å« 'demo' æˆ–ä¸­æ–‡â€œæ¼”ç¤º/ç¤ºä¾‹â€
            if (!targetOrg) targetOrg = orgsList.find(org => lowerInc(org.name, 'demo') || lowerInc(org.name, 'æ¼”ç¤º') || lowerInc(org.name, 'ç¤ºä¾‹'));
            // 3) å¦åˆ™ï¼šç¬¬ä¸€ä¸ªç»„ç»‡
            if (!targetOrg) targetOrg = orgsList[0];
            
            currentOrg = String(targetOrg.id);
            localStorage.setItem('active_org', currentOrg);
            console.log('Auto-selected organization:', targetOrg.name, 'ID:', currentOrg);
            
            const orgSelect = document.getElementById('org_select');
            if (orgSelect) {
              // å¦‚æœé€‰é¡¹åˆ—è¡¨å°šæœªåŠ è½½/ä¸å­˜åœ¨è¯¥é€‰é¡¹ï¼Œåˆ™é‡å»ºä¸€æ¬¡
              let needRebuild = true;
              if (orgSelect.options && orgSelect.options.length > 0) {
                for (let option of orgSelect.options) {
                  if (String(option.value) === String(currentOrg)) { needRebuild = false; break; }
                }
              }
              if (needRebuild) {
                orgSelect.innerHTML = '<option value="">' + gettext('é€‰æ‹©ç»„ç»‡...') + '</option>';
                orgsList.forEach(org => {
                  const opt = document.createElement('option');
                  opt.value = org.id;
                  opt.textContent = org.name;
                  orgSelect.appendChild(opt);
                });
              }
              orgSelect.value = currentOrg;
            }
            
            await loadAvailableProjects();
            updateProjectUI();
            updateUploadBtnDisabled();
          } else {
            console.log('No organizations found for auto-selection');
          }
        } else {
          console.error('Failed to fetch organizations:', res.status, await res.text());
        }
      } catch (e) {
        console.error('Failed to auto-select organization:', e);
      }
    }

    // ========= å°æ”¹ onOrgChangeï¼Œç¡®ä¿å†™å…¥æœ¬åœ°å¹¶åˆ·æ–°ç›¸å…³ä¾èµ– =========
    function onOrgChange() {
      const select = document.getElementById('org_select');
      if (!select) return;
      setCurrentOrg(select.value || null);  // ç»Ÿä¸€å…¥å£
      loadAvailableProjects();              // éšç»„ç»‡åˆ‡æ¢åˆ·æ–°é¡¹ç›®
      updateProjectUI();
      updateUploadBtnDisabled();
    }

    function showLoginModal() {
      const modal = document.getElementById('login_modal');
      if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('login_email').focus();
      }
    }

    function hideLoginModal() {
      const modal = document.getElementById('login_modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    async function doLogin() {
      const email = document.getElementById('login_email').value.trim();
      const password = document.getElementById('login_password').value;

      if (!email || !password) {
        alert(gettext('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç '));
        return;
      }

      try {
        const res = await fetch(`${window.APP_URLS.API_USERS_BASE}/login/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
          body: JSON.stringify({ email, password })
        });

        if (res.ok) {
          hideLoginModal();
          await fetchCurrentUser();
        } else {
          alert(gettext('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç '));
        }
      } catch (e) {
        console.error('Login error:', e);
        alert(gettext('ç™»å½•å¤±è´¥'));
      }
    }

    /**
     * æ¼”ç¤ºç™»å½•åŠŸèƒ½ - è‡ªåŠ¨å…³è”åˆ°ç»„ç»‡
     */
    async function demoLogin() {
      try {
        const res = await fetch(window.APP_URLS.API_DEMO_LOGIN, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCsrfToken() }
        });
        if (res.ok) {
          hideLoginModal();
          await fetchCurrentUser();
          // â˜… Demoç™»å½•åè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨ç»„ç»‡
          await autoSelectFirstOrganization();
        } else {
          alert(gettext('Demo ç™»å½•å¤±è´¥'));
        }
      } catch (e) {
        console.error('Demo login error:', e);
        alert(gettext('Demo ç™»å½•å¤±è´¥'));
      }
    }

    // -------------------- Steps Management --------------------
    async function loadAvailableSteps() {
      try {
        const res = await fetch(window.APP_URLS.API_STEPS, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          availableSteps = Array.isArray(data) ? data : (data.results || []);
        }
      } catch (e) {
        console.error('Failed to load steps:', e);
      }
    }

    function setStepActive(stepName) {
      currentStep = stepName;
      
      try { saveSessionState(); } catch (_) {}

      document.querySelectorAll('.step-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-step') === stepName) {
          item.classList.add('active');
        }
      });

      const titleEl = document.getElementById('workflow_title');
      const stepTitles = {
        'upload': gettext('æ•°æ®ä¸Šä¼ '),
        'qc': gettext('è´¨é‡æ§åˆ¶'),
        'hvg': gettext('é«˜å˜åŸºå› '),
        'pca': gettext('ä¸»æˆåˆ†åˆ†æ'),
        'umap': gettext('UMAPåµŒå…¥'),
        'clustering': gettext('ç»†èƒèšç±»')
      };
      if (titleEl) {
        titleEl.textContent = stepTitles[stepName] || stepName;
      }

      const uploadView = document.getElementById('upload_only_view');
      const tabsWrapper = document.getElementById('tabs_wrapper');
      const runBtn = document.getElementById('run_btn');

      if (stepName === 'upload') {
        if (uploadView) uploadView.style.display = 'block';
        if (tabsWrapper) tabsWrapper.style.display = 'none';
        if (runBtn) runBtn.style.display = 'none';
        renderUploadView();
      } else {
        if (uploadView) uploadView.style.display = 'none';
        if (tabsWrapper) tabsWrapper.style.display = 'block';
        if (runBtn) runBtn.style.display = 'inline-block';
        renderParametersView(stepName);
      }

      updateRunButtonState();
    }

    function setStepStatus(stepName, status) {
      const stepItem = document.querySelector(`.step-item[data-step="${stepName}"]`);
      if (!stepItem) return;

      const statusEl = stepItem.querySelector('.step-status');
      if (statusEl) {
        statusEl.className = `step-status ${status}`;
        const statusTexts = {
          'pending': gettext('å¾…å¤„ç†'),
          'running': gettext('è¿è¡Œä¸­'),
          'completed': gettext('å·²å®Œæˆ'),
          'failed': gettext('å¤±è´¥')
        };
        statusEl.textContent = statusTexts[status] || status;
      }

      stepItem.classList.remove('completed', 'failed');
      if (status === 'completed') stepItem.classList.add('completed');
      if (status === 'failed') stepItem.classList.add('failed');
    }

    function updateRunButtonState() {
      const runBtn = document.getElementById('run_btn');
      if (!runBtn) return;
      const hasRequiredContext = currentProject && currentDataset && currentSession;
      runBtn.disabled = !hasRequiredContext;
      runBtn.textContent = hasRequiredContext ? gettext('å¼€å§‹åˆ†æ') : gettext('è¯·å…ˆå®Œæˆæ•°æ®ä¸Šä¼ ');
    }

    function updateUploadBtnDisabled() {
      const btn = document.getElementById('btn_submit_upload');
      if (!btn) return;
      const hasFiles = uploadedFiles && uploadedFiles.length > 0;
      const hasProject = !!currentProject;
      const hasOrg = !!currentOrg;
      btn.disabled = !(hasFiles && hasProject && hasOrg);
    }

    // -------------------- Tabs --------------------
    function switchTab(tabName, event) {
      if (event) event.preventDefault();
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      const targetPane = document.getElementById(`tab_${tabName}`);
      if (targetPane) targetPane.classList.add('active');
    }

    // -------------------- Session History --------------------
    async function loadSessionHistory() {
      if (!currentSession) return;
      try {
        const res = await fetch(`${window.APP_URLS.API_STEP_RUNS}?session=${currentSession}`, { headers: authHeaders() });
        if (res.ok) {
          const data = await res.json();
          const runs = Array.isArray(data) ? data : (data.results || []);
          renderHistoryList(runs);
        }
      } catch (e) {
        console.error('Failed to load session history:', e);
      }
    }

    function renderHistoryList(runs) {
      const historyList = document.getElementById('history_list');
      if (!historyList) return;
      if (runs.length === 0) {
        historyList.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">' + gettext('æš‚æ— è¿è¡Œè®°å½•') + '</div>';
        return;
      }
      historyList.innerHTML = runs.map(run => `
        <div class="history-item" style="padding:8px 12px; border-bottom:1px solid var(--border); cursor:pointer;"
             onclick="loadAndRenderStepResults('${run.id}')">
          <div style="font-size:13px; font-weight:500;">${run.step.name}</div>
          <div style="font-size:11px; color:var(--muted);">${run.status} â€¢ ${new Date(run.created_at).toLocaleString()}</div>
        </div>
      `).join('');
    }

    // -------------------- Run Step --------------------
    async function runCurrentStep() {
      if (!currentProject || !currentDataset || !currentSession) {
        alert(gettext('è¯·å…ˆå®Œæˆæ•°æ®ä¸Šä¼ '));
        return;
      }
      const stepInfo = availableSteps.find(s => s.step_type === currentStep);
      if (!stepInfo) { alert(gettext('æœªæ‰¾åˆ°æ­¥éª¤é…ç½®')); return; }

      setStepStatus(currentStep, 'running');
      logMessage(gettext('å¼€å§‹æ‰§è¡Œæ­¥éª¤ï¼š') + stepInfo.name);

      try {
        const payload = { session: currentSession, step: stepInfo.id, parameters: {} };
        const res = await fetch(window.APP_URLS.API_CORE_RUN, {
          method: 'POST', headers: authHeaders({'Content-Type': 'application/json'}), body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        const runData = await res.json();
        setStepStatus(currentStep, 'completed');
        logMessage(gettext('æ­¥éª¤æ‰§è¡Œå®Œæˆ'));
        
        // åŠ è½½å¹¶æ¸²æŸ“ç»“æœ
        if (runData.step_run_id) {
          await loadAndRenderStepResults(runData.step_run_id);
        }
        
        await loadSessionHistory();
        const order = ['upload','qc','hvg','pca','umap','clustering'];
        const i = order.indexOf(currentStep);
        // å®Œæˆ QC ååœç•™åœ¨ç»“æœé¡µé¢ï¼Œä¸è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€æ­¥éª¤
        if (currentStep !== 'qc' && i >= 0 && i < order.length - 1) {
          setStepActive(order[i+1]);
        }
      } catch (e) {
        console.error('Step execution failed:', e);
        setStepStatus(currentStep, 'failed');
        logMessage(gettext('æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼š') + (e.message || e));
      }
    }

    // -------------------- Results Rendering --------------------
    /**
     * åŠ è½½å¹¶æ¸²æŸ“æ­¥éª¤è¿è¡Œç»“æœ
     * @param {string} stepRunId - StepRun ID
     */
    async function loadAndRenderStepResults(stepRunId) {
      if (!stepRunId) {
        console.warn('loadAndRenderStepResults: stepRunId is missing');
        return;
      }
      
      console.log('loadAndRenderStepResults called with stepRunId:', stepRunId);
      
      try {
        logMessage(gettext('æ­£åœ¨åŠ è½½åˆ†æç»“æœ...'));
        
        // è·å– StepRun å¯¼å‡ºæ•°æ®
        const exportUrl = `${window.APP_URLS.API_STEP_RUNS}${stepRunId}/export/`;
        console.log('Fetching export data from:', exportUrl);
        
        const exportRes = await fetch(exportUrl, {
          headers: authHeaders()
        });
        
        if (!exportRes.ok) {
          const errorText = await exportRes.text();
          console.error('Export fetch failed:', { status: exportRes.status, errorText });
          throw new Error(gettext('è·å–ç»“æœæ•°æ®å¤±è´¥ï¼š') + errorText);
        }
        
        const exportData = await exportRes.json();
        console.log('Export data received:', exportData);
        console.log('exportData.run structure:', exportData.run);
        
        // æ¸²æŸ“æŒ‡æ ‡
        await renderMetrics(exportData.run);
        
        // æ¸²æŸ“äº§ç‰©ï¼ˆå›¾è¡¨ã€æ–‡ä»¶ç­‰ï¼‰
        await renderArtifacts(exportData.artifacts || []);
        
        // æ¸²æŸ“AIå»ºè®®ï¼ˆå¦‚æœæœ‰ï¼‰
        await renderAdvice(stepRunId);
        
        logMessage(gettext('ç»“æœåŠ è½½å®Œæˆ âœ…'));
        
        // è‡ªåŠ¨åˆ‡æ¢åˆ°ç»“æœæ ‡ç­¾é¡µ
        const resultsTab = document.querySelector('.tab[onclick*="results"]');
        if (resultsTab) {
          resultsTab.click();
        }
        
      } catch (e) {
        console.error('Load results error:', e);
        logMessage(gettext('åŠ è½½ç»“æœå¤±è´¥ï¼š') + (e.message || e));
      }
    }

    /**
     * æ¸²æŸ“åˆ†ææŒ‡æ ‡
     * @param {Object} stepRun - StepRun æ•°æ®
     */
    async function renderMetrics(stepRun) {
      console.log('renderMetrics called with stepRun:', stepRun);
      
      if (!stepRun) {
        console.warn('renderMetrics: stepRun is null or undefined');
        return;
      }
      
      // å…¼å®¹å¤šç§åç«¯å­—æ®µå‘½åï¼š
      // - stepRun.metrics_jsonï¼ˆæ—§æ ¼å¼ï¼ŒStepRunä¸Šç›´æ¥å­˜JSONï¼‰
      // - stepRun.metricsï¼ˆå¯¼å‡ºç»“æœæŠŠæŒ‡æ ‡æ”¾åœ¨ run.metrics ä¸‹ï¼‰
      // - æˆ–è€…ç›´æ¥ä¼ å…¥ metrics å¯¹è±¡
      const metrics = stepRun.metrics_json || stepRun.metrics || stepRun;
      
      console.log('Extracted metrics object:', metrics);
      
      if (!metrics || typeof metrics !== 'object') {
        console.warn('renderMetrics: metrics is not a valid object:', metrics);
        return;
      }
      
      console.log('Rendering metrics:', metrics);
      
      // æ ¼å¼åŒ–æ•°å€¼å‡½æ•°
      const formatNumber = (value, precision = 0) => {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'number') {
          return precision > 0 ? value.toFixed(precision) : Math.round(value).toLocaleString();
        }
        return value;
      };
      
      const formatPercentage = (value, precision = 1) => {
        if (value === null || value === undefined || value === '') return '-';
        if (typeof value === 'number') {
          // å¦‚æœå€¼æ˜¯å°æ•°å½¢å¼ (0-1)ï¼Œè½¬æ¢ä¸ºç™¾åˆ†æ¯”
          const percentage = value <= 1 ? value * 100 : value;
          return percentage.toFixed(precision) + '%';
        }
        return value;
      };
      
      // æ›´æ–°æ‰€æœ‰æŒ‡æ ‡å¡ç‰‡
      const metricElements = {
        // åŸå§‹æ•°æ®æŒ‡æ ‡
        'metric_cells_raw': formatNumber(metrics.cells_raw),
        'metric_genes_raw': formatNumber(metrics.genes_raw),
        
        // è¿‡æ»¤åæ•°æ®æŒ‡æ ‡
        'metric_cells_filtered': formatNumber(metrics.cells_filtered || metrics.cells),
        'metric_genes_filtered': formatNumber(metrics.genes_filtered || metrics.genes),
        
        // ç§»é™¤ç‡æŒ‡æ ‡
        'metric_cells_removal_rate': formatPercentage(metrics.cells_removal_rate),
        'metric_genes_removal_rate': formatPercentage(metrics.genes_removal_rate),
        
        // æ¯ç»†èƒç»Ÿè®¡æŒ‡æ ‡
        'metric_mean_genes_per_cell': formatNumber(metrics.mean_genes_per_cell, 1),
        'metric_median_genes_per_cell': formatNumber(metrics.median_genes_per_cell),
        
        // UMI ç»Ÿè®¡æŒ‡æ ‡
        'metric_mean_umis_per_cell': formatNumber(metrics.mean_umis_per_cell, 1),
        'metric_median_umis_per_cell': formatNumber(metrics.median_umis_per_cell),
        
        // è´¨é‡æŒ‡æ ‡
        'metric_mean_mito_pct': formatPercentage(metrics.mean_mito_pct),
        'metric_mean_ribo_pct': formatPercentage(metrics.mean_ribo_pct)
      };
      
      // æ›´æ–°DOMå…ƒç´ 
      Object.entries(metricElements).forEach(([elementId, value]) => {
        const el = document.getElementById(elementId);
        console.log(`Updating element ${elementId}:`, { found: !!el, value: value });
        if (el) {
          el.textContent = value;
          console.log(`Successfully updated ${elementId} to: ${value}`);
        } else {
          console.error(`Element with ID ${elementId} not found in DOM`);
        }
      });
      
      // æ ¹æ®æŒ‡æ ‡å€¼è®¾ç½®è­¦å‘ŠçŠ¶æ€
      updateMetricStatus('metric_cells_removal_rate', metrics.cells_removal_rate, 0.1); // 10%ä»¥ä¸Šè­¦å‘Š
      updateMetricStatus('metric_genes_removal_rate', metrics.genes_removal_rate, 0.3); // 30%ä»¥ä¸Šè­¦å‘Š
      updateMetricStatus('metric_mean_mito_pct', metrics.mean_mito_pct, 0.2); // 20%ä»¥ä¸Šè­¦å‘Š
      
      console.log('renderMetrics completed successfully');
    }

    /**
     * æ›´æ–°æŒ‡æ ‡çŠ¶æ€ï¼ˆæ­£å¸¸/è­¦å‘Š/é”™è¯¯ï¼‰
     * @param {string} elementId - å…ƒç´ ID
     * @param {number} value - æŒ‡æ ‡å€¼
     * @param {number} threshold - è­¦å‘Šé˜ˆå€¼
     */
    function updateMetricStatus(elementId, value, threshold) {
      const el = document.getElementById(elementId);
      if (!el || value === undefined || value === null) return;
      
      const card = el.closest('.metric-card');
      if (!card) return;
      
      card.classList.remove('ok', 'warn', 'err');
      
      if (value > threshold * 1.5) {
        card.classList.add('err');
      } else if (value > threshold) {
        card.classList.add('warn');
      } else {
        card.classList.add('ok');
      }
    }

    /**
     * æ¸²æŸ“äº§ç‰©ï¼ˆå›¾è¡¨ã€æ–‡ä»¶ç­‰ï¼‰
     * @param {Array} artifacts - Artifact åˆ—è¡¨
     */
    async function renderArtifacts(artifacts) {
      if (!artifacts || artifacts.length === 0) return;
      
      const chartPlaceholder = document.querySelector('.chart-placeholder');
      const filesContainer = document.getElementById('artifact_files');
      if (!chartPlaceholder) return;
      
      try {
        // æŸ¥æ‰¾å›¾è¡¨æ–‡ä»¶ï¼ˆPNG, PDFç­‰ï¼‰
        const chartArtifacts = artifacts.filter(artifact => 
          ['png', 'pdf', 'svg', 'jpg', 'jpeg'].includes(
            (artifact.artifact_type || '').toLowerCase()
          )
        );
        
        if (chartArtifacts.length === 0) {
          chartPlaceholder.innerHTML = '<div style="color:var(--muted);">' + gettext('æš‚æ— å›¾è¡¨æ–‡ä»¶') + '</div>';
        } else {
          logMessage(gettext('æ­£åœ¨åŠ è½½å›¾è¡¨...'));
          
          // ä¸ºæ¯ä¸ªå›¾è¡¨ç”Ÿæˆé¢„ç­¾åURLå¹¶æ˜¾ç¤º
          const chartElements = await Promise.all(
            chartArtifacts.map(async (artifact) => {
              try {
                const presignRes = await fetch(window.APP_URLS.API_STORAGE_PRESIGN, {
                  method: 'POST',
                  headers: authHeaders({'Content-Type': 'application/json'}),
                  body: JSON.stringify({
                    path: artifact.file_path,
                    method: 'get'
                  })
                });
                
                if (!presignRes.ok) {
                  console.error('Failed to get presigned URL for:', artifact.name);
                  return null;
                }
                
                const presignData = await presignRes.json();
                
                return `
                  <div class="chart-item" style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text);">${artifact.name}</h4>
                    <div style="text-align: center; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px;">
                      <img src="${presignData.url}" alt="${artifact.name}" 
                           style="max-width: 100%; max-height: 400px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                      <div style="display: none; color: var(--muted); padding: 20px;">
                        ${gettext('å›¾ç‰‡åŠ è½½å¤±è´¥')}
                      </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
                      ${gettext('ç±»å‹')}: ${artifact.artifact_type} | 
                      ${gettext('å¤§å°')}: ${formatFileSize(artifact.file_size)}
                    </div>
                  </div>
                `;
              } catch (e) {
                console.error('Error processing artifact:', artifact.name, e);
                return null;
              }
            })
          );
          
          const validCharts = chartElements.filter(el => el !== null);
          
          if (validCharts.length > 0) {
            chartPlaceholder.innerHTML = validCharts.join('');
            logMessage(gettext('å›¾è¡¨åŠ è½½å®Œæˆ'));
          } else {
            chartPlaceholder.innerHTML = '<div style="color:var(--muted);">' + gettext('å›¾è¡¨åŠ è½½å¤±è´¥') + '</div>';
          }
        }
        
        // æ¸²æŸ“éå›¾åƒç±»äº§ç‰©ï¼ˆå¦‚ CSV/JSON/HTML/H5AD/ZIP ç­‰ï¼‰
        if (filesContainer) {
          const nonImageArtifacts = artifacts.filter(artifact => {
            const t = (artifact.artifact_type || '').toLowerCase();
            return !['png','pdf','svg','jpg','jpeg'].includes(t);
          });
          
          if (nonImageArtifacts.length === 0) {
            filesContainer.innerHTML = '';
          } else {
            logMessage(gettext('æ­£åœ¨åŠ è½½ç›¸å…³æ–‡ä»¶é“¾æ¥...'));
            const fileItems = await Promise.all(nonImageArtifacts.map(async (artifact) => {
              try {
                const presignRes = await fetch(window.APP_URLS.API_STORAGE_PRESIGN, {
                  method: 'POST',
                  headers: authHeaders({'Content-Type': 'application/json'}),
                  body: JSON.stringify({ path: artifact.file_path, method: 'get' })
                });
                if (!presignRes.ok) throw new Error(await presignRes.text());
                const presignData = await presignRes.json();
                const url = presignData.url;
                return `
                  <div class="artifact-item">
                    <div>
                      <div class="name">${artifact.name}</div>
                      <div class="meta">${gettext('ç±»å‹')}: ${artifact.artifact_type} Â· ${gettext('å¤§å°')}: ${formatFileSize(artifact.file_size)}</div>
                    </div>
                    <div>
                      <a class="btn" style="padding:6px 12px;font-size:12px;" href="${url}" target="_blank" rel="noopener">
                        â¬‡ï¸ ${gettext('ä¸‹è½½')}
                      </a>
                    </div>
                  </div>
                `;
              } catch (e) {
                console.error('Presign non-image artifact failed:', artifact.name, e);
                return null;
              }
            }));
            const valid = fileItems.filter(Boolean);
            if (valid.length) {
              filesContainer.innerHTML = `
                <div style="font-weight:600;margin:8px 0 6px 0;">ğŸ“ ${gettext('ç›¸å…³æ–‡ä»¶')}</div>
                ${valid.join('')}
              `;
              logMessage(gettext('æ–‡ä»¶é“¾æ¥å·²å°±ç»ª'));
            } else {
              filesContainer.innerHTML = '';
            }
          }
        }
        
      } catch (e) {
        console.error('Render artifacts error:', e);
        chartPlaceholder.innerHTML = '<div style="color:var(--err);">' + gettext('å›¾è¡¨åŠ è½½å‡ºé”™ï¼š') + (e.message || e) + '</div>';
        if (filesContainer) {
          filesContainer.innerHTML = '';
        }
      }
    }

    /**
     * æ¸²æŸ“AIå»ºè®®
     * @param {string} stepRunId - StepRun ID
     */
    async function renderAdvice(stepRunId) {
      const adviceEl = document.getElementById('advice_content');
      if (!adviceEl) return;
      
      try {
        const adviceRes = await fetch(`${window.APP_URLS.API_STEP_RUNS}${stepRunId}/advice/`, {
          headers: authHeaders()
        });
        
        if (!adviceRes.ok) {
          console.log('No advice available for this step run');
          return;
        }
        
        const adviceList = await adviceRes.json();
        
        if (!adviceList || adviceList.length === 0) {
          adviceEl.innerHTML = `
            <div style="color:var(--muted); text-align:center; padding:40px 20px;">
              ${gettext('æš‚æ— AIå»ºè®®')}
            </div>
          `;
          return;
        }
        
        // æ¸²æŸ“å»ºè®®åˆ—è¡¨
        const adviceHtml = adviceList.map(advice => `
          <div class="advice-item" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div class="advice-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
              <h4 style="margin: 0; font-size: 14px; color: var(--accent);">
                ${advice.advice_type === 'warning' ? 'âš ï¸' : 'ğŸ’¡'} ${advice.title || gettext('ä¼˜åŒ–å»ºè®®')}
              </h4>
              <span class="advice-priority" style="font-size: 12px; padding: 2px 8px; border-radius: 4px; background: var(--muted); color: white;">
                ${advice.priority || 'medium'}
              </span>
            </div>
            <div class="advice-content" style="color: var(--text); line-height: 1.5; margin-bottom: 12px;">
              ${advice.content || advice.description || ''}
            </div>
            <div class="advice-actions" style="display: flex; gap: 8px;">
              <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="applyAdvice('${advice.id}')">
                ${gettext('åº”ç”¨å»ºè®®')}
              </button>
              <button class="btn" style="padding: 6px 12px; font-size: 12px; background: var(--muted);" onclick="dismissAdvice('${advice.id}')">
                ${gettext('å¿½ç•¥')}
              </button>
            </div>
          </div>
        `).join('');
        
        adviceEl.innerHTML = adviceHtml;
        
      } catch (e) {
        console.error('Render advice error:', e);
        adviceEl.innerHTML = `
          <div style="color:var(--muted); text-align:center; padding:40px 20px;">
            ${gettext('åŠ è½½AIå»ºè®®æ—¶å‡ºé”™')}
          </div>
        `;
      }
    }

    /**
     * åº”ç”¨AIå»ºè®®
     * @param {string} adviceId - å»ºè®®ID
     */
    async function applyAdvice(adviceId) {
      try {
        const res = await fetch(`${window.APP_URLS.API_ADVICE}${adviceId}/apply/`, {
          method: 'POST',
          headers: authHeaders()
        });
        
        if (!res.ok) {
          throw new Error(await res.text());
        }
        
        const result = await res.json();
        logMessage(gettext('AIå»ºè®®å·²åº”ç”¨'));
        
        // åˆ·æ–°å‚æ•°è§†å›¾
        renderParametersView(currentStep);
        
      } catch (e) {
        console.error('Apply advice error:', e);
        alert(gettext('åº”ç”¨å»ºè®®å¤±è´¥ï¼š') + (e.message || e));
      }
    }

    /**
     * å¿½ç•¥AIå»ºè®®
     * @param {string} adviceId - å»ºè®®ID
     */
    async function dismissAdvice(adviceId) {
      // ç®€å•éšè—å»ºè®®é¡¹
      const adviceItem = document.querySelector(`[onclick*="${adviceId}"]`).closest('.advice-item');
      if (adviceItem) {
        adviceItem.style.display = 'none';
      }
    }

    /**
     * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
     * @param {number} bytes - å­—èŠ‚æ•°
     * @returns {string} æ ¼å¼åŒ–åçš„å¤§å°
     */
    function formatFileSize(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }

    // -------------------- Parameters View --------------------
    function renderParametersView(stepName) {
      const paramsGrid = document.getElementById('params_grid');
      if (!paramsGrid) return;
      paramsGrid.innerHTML = `
        <div class="param-group">
          <h3>ğŸ“Š ${gettext('å‚æ•°é…ç½®')}</h3>
          <p style="color:var(--muted);">${gettext('æ­¥éª¤')} ${stepName} ${gettext('çš„å‚æ•°é…ç½®å°†åœ¨æ­¤æ˜¾ç¤º')}</p>
        </div>
      `;
    }

    // -------------------- æ–°å¢ï¼šåˆ›å»ºé¡¹ç›®ï¼ˆè½»é‡ promptï¼‰ --------------------
    async function createProjectViaPrompt(defaultName = '') {
      if (!currentOrg) { 
        alert(gettext('è¯·å…ˆé€‰æ‹©ç»„ç»‡')); 
        throw new Error('no org'); 
      }
      
      const name = prompt(
        gettext('è¯·è¾“å…¥é¡¹ç›®åç§°'), 
        defaultName || ('Project_' + new Date().toISOString().slice(0,16).replace(/[T:]/g,'-'))
      );
      
      if (!name || name.trim() === '') {
        throw new Error(gettext('é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º'));
      }
      
      const payload = { 
        name: name.trim(), 
        organization: currentOrg 
      };
      
      const res = await fetch(window.APP_URLS.API_PROJECTS, {
        method:'POST', 
        headers:authHeaders({'Content-Type':'application/json'}), 
        body:JSON.stringify(payload)
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(gettext('åˆ›å»ºé¡¹ç›®å¤±è´¥ï¼š') + errorText);
      }
      
      const proj = await res.json();
      currentProject = String(proj.id);
      localStorage.setItem('selected_project', currentProject);
      
      await loadAvailableProjects();
      updateProjectUI();
      
      console.log('Project created successfully:', proj.name);
      return proj;
    }

    /**
     * åˆ›å»ºé¡¹ç›®å¹¶å¼€å§‹ä¸Šä¼ æµç¨‹
     */
    async function createProjectAndUpload() {
      try {
        const defaultName = 'Project_' + new Date().toLocaleString().replace(/[\/\s:]/g, '-');
        await createProjectViaPrompt(defaultName);
        
        // è‹¥å·²é€‰æ–‡ä»¶ä¸”ç»„ç»‡å·²é€‰ï¼Œè‡ªåŠ¨è§¦å‘ä¸€æ¬¡"ä¸Šä¼ æ•°æ®"
        const submitBtn = document.getElementById('btn_submit_upload');
        if (uploadedFiles.length > 0 && submitBtn && !submitBtn.disabled) {
          submitBtn.click();
        }
      } catch(e) {
        console.error('Create project and upload failed:', e);
      }
    }

    /**
     * æ¸²æŸ“æ— é¡¹ç›®ç©ºæ€ CTA
     */
    function renderUploadEmptyProjectCTA(mountEl) {
      if (!mountEl) return;
      if (currentProject) { 
        mountEl.innerHTML = ''; 
        return; 
      }
      
      mountEl.innerHTML = `
        <div class="continue-section" style="margin-bottom:12px;">
          <div class="continue-title">ğŸ“ ${gettext('å¼€å§‹å‰å…ˆå»ºä¸ªé¡¹ç›®ï¼Ÿ')}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btn_create_project" class="btn primary">${gettext('åˆ›å»ºé¡¹ç›®')}</button>
            <button id="btn_quick_upload_project" class="btn">${gettext('ä¸Šä¼ å¹¶æ–°å»ºé¡¹ç›®')}</button>
          </div>
          <div class="continue-meta" style="margin-top:8px;color:var(--muted);font-size:12px;">
            ${gettext('é¡¹ç›®ç”¨äºå½’é›†æ•°æ®ä¸åˆ†æï¼Œä¾¿äºæƒé™ä¸å†å²ç®¡ç†ã€‚')}
          </div>
        </div>
      `;
      
      // â˜… ç»‘å®šåˆ›å»ºé¡¹ç›®æŒ‰é’®äº‹ä»¶
      const btnCreate = document.getElementById('btn_create_project');
      const btnQuick = document.getElementById('btn_quick_upload_project');
      
      if (btnCreate) {
        btnCreate.onclick = async () => {
          try { 
            await createProjectViaPrompt(); 
          } catch(e) {
            console.error('Create project failed:', e);
          }
        };
      }
      
      if (btnQuick) {
        btnQuick.onclick = createProjectAndUpload;
      }
    }

    // -------------------- Upload View --------------------
    function renderUploadView() {
      const drop = document.getElementById('big_upload_drop');
      const input = document.getElementById('big_file_input');
      const list = document.getElementById('big_file_list');
      const submitBtn = document.getElementById('btn_submit_upload');
      const prog = document.getElementById('upload_progress');
      const ctaMount = document.getElementById('upload_project_cta_mount');

      // â˜… æŒ‚è½½æ— é¡¹ç›® CTA
      if (ctaMount) renderUploadEmptyProjectCTA(ctaMount);

      if (list) list.innerHTML = '';
      if (prog) prog.textContent = '';

      function renderBigList() {
        list.innerHTML = '';
        uploadedFiles.forEach((f, i) => {
          const row = document.createElement('div');
          row.className = 'file-item';
          row.innerHTML = `
            <div>
              <div class="name">${f.name}</div>
              <div class="size">${(f.size/1024/1024).toFixed(2)} MB</div>
            </div>
            <button data-idx="${i}" style="background:none;border:none;color:var(--err);cursor:pointer;">âœ•</button>
          `;
          list.appendChild(row);
        });
        updateUploadBtnDisabled();
      }

      function attachUploadEvents() {
        drop.addEventListener('click', () => input.click());
        drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
        drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
        drop.addEventListener('drop', e => {
          e.preventDefault(); drop.classList.remove('dragover');
          uploadedFiles = Array.from(e.dataTransfer.files || []);
          renderBigList();
        });
        input.addEventListener('change', () => {
          uploadedFiles = Array.from(input.files || []);
          renderBigList();
        });
        list.addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-idx]');
          if (!btn) return;
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          uploadedFiles.splice(idx, 1);
          renderBigList();
        });
        submitBtn.addEventListener('click', submitUpload);
      }

      async function submitUpload() {
        if (!currentOrg) { alert(gettext('è¯·é€‰æ‹©ç»„ç»‡')); return; }
        // â˜… è‹¥æ²¡æœ‰é¡¹ç›®ï¼Œåˆ™å…ˆå¼•å¯¼åˆ›å»ºï¼ˆä¸ CTA äº’è¡¥ï¼Œç¡®ä¿ä¸€é”®æˆåŠŸï¼‰
        if (!currentProject) {
          try { await createProjectViaPrompt('Project_' + new Date().toLocaleString()); }
          catch(_) { return; }
        }
        if (uploadedFiles.length === 0) { alert(gettext('è¯·å…ˆé€‰æ‹©æ–‡ä»¶')); return; }

        setStepStatus('upload', 'running');
        if (prog) prog.textContent = gettext('æ­£åœ¨ä¸Šä¼ ...');

        try {
          // 1) ä¸Šä¼ æ–‡ä»¶
          const fd = new FormData();
          const firstFile = uploadedFiles[0];
          fd.append('file', firstFile, firstFile.name);
          const res = await fetch(window.APP_URLS.API_STORAGE_UPLOAD, {
            method:'POST', headers:authHeaders(), body:fd
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();

          // 2) åˆ›å»ºæ•°æ®é›†
          const datasetPayload = {
            project: currentProject,
            name: gettext('æ•°æ®é›†') + ' ' + new Date().getTime(),
            dataset_type: 'single_cell',
            input_h5ad_path: data.path
          };
          const datasetRes = await fetch(window.APP_URLS.API_DATASETS, {
            method:'POST', headers:authHeaders({'Content-Type':'application/json'}),
            body: JSON.stringify(datasetPayload)
          });
          if (!datasetRes.ok) throw new Error(gettext('åˆ›å»ºæ•°æ®é›†å¤±è´¥ï¼š') + await datasetRes.text());
          const dataset = await datasetRes.json();
          currentDataset = dataset.id;

          // 3) åˆ›å»ºä¼šè¯
          const sessionPayload = {
            dataset: currentDataset,
            name: gettext('åˆ†æä¼šè¯') + ' ' + new Date().getTime(),
            description: gettext('æ–°çš„å•ç»†èƒåˆ†æä¼šè¯')
          };
          const sessionRes = await fetch(window.APP_URLS.API_SESSIONS, {
            method:'POST', headers:authHeaders({'Content-Type':'application/json'}),
            body: JSON.stringify(sessionPayload)
          });
          if (!sessionRes.ok) throw new Error(gettext('åˆ›å»ºä¼šè¯å¤±è´¥ï¼š') + await sessionRes.text());
          const session = await sessionRes.json();
          currentSession = session.id;

          if (prog) prog.textContent = gettext('ä¸Šä¼ å®Œæˆ âœ…');
          setStepStatus('upload', 'completed');
          await loadSessionHistory();
          await loadProjectSessions(currentProject);
          setStepActive('qc');
        } catch(e) {
          if (prog) prog.textContent = gettext('ä¸Šä¼ å¤±è´¥ï¼š') + String(e.message || e);
          setStepStatus('upload', 'failed');
        } finally {
          updateRunButtonState();
        }
      }

      attachUploadEvents();
      renderBigList();
    }

    // -------------------- Init --------------------
    document.addEventListener('DOMContentLoaded', async function() {
      await fetchCurrentUser();
      await loadAvailableSteps();
      await restoreSessionState();

      // ç»‘å®šç»„ç»‡é€‰æ‹©ä¸‹æ‹‰æ¡†äº‹ä»¶
      const orgSelect = document.getElementById('org_select');
      if (orgSelect) {
        orgSelect.addEventListener('change', onOrgChange);
      }

      // ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶
      const loginBtn = document.querySelector('#user_profile .login-btn');
      if (loginBtn) {
        loginBtn.addEventListener('click', showLoginModal);
      }

      const stepsContainer = document.getElementById('steps_container');
      if (stepsContainer) {
        stepsContainer.addEventListener('click', (e) => {
          const item = e.target.closest('.step-item');
          if (!item) return;
          const step = item.getAttribute('data-step');
          if (step !== 'upload' && (!currentDataset || !currentSession)) {
            alert(gettext('è¯·å…ˆå®Œæˆç¬¬ 1 æ­¥ï¼šæ•°æ®ä¸Šä¼ '));
            return;
          }
          setStepActive(step);
        });
      }

    /**
     * åˆ é™¤åˆ†æä¼šè¯
     * @param {string} sessionId - è¦åˆ é™¤çš„ä¼šè¯ID
     */
    async function deleteSession(sessionId) {
      try {
        // è·å–ä¼šè¯ä¿¡æ¯ç”¨äºç¡®è®¤å¯¹è¯æ¡†
        const sessionRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, { 
          headers: authHeaders() 
        });
        
        if (!sessionRes.ok) {
          throw new Error(gettext('æ— æ³•è·å–ä¼šè¯ä¿¡æ¯'));
        }
        
        const session = await sessionRes.json();
        const sessionName = session.name || `#${session.id}`;
        
        // ç¡®è®¤åˆ é™¤
        const confirmed = confirm(
          gettext('ç¡®å®šè¦åˆ é™¤åˆ†æä¼šè¯"') + sessionName + gettext('"å—ï¼Ÿ') + '\n\n' +
          gettext('æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åˆ é™¤è¯¥ä¼šè¯çš„æ‰€æœ‰è¿è¡Œè®°å½•å’Œç»“æœã€‚')
        );
        
        if (!confirmed) {
          return;
        }
        
        // æ‰§è¡Œåˆ é™¤
        const deleteRes = await fetch(`${window.APP_URLS.API_SESSIONS}${sessionId}/`, {
          method: 'DELETE',
          headers: authHeaders()
        });
        
        if (!deleteRes.ok) {
          const errorText = await deleteRes.text();
          throw new Error(gettext('åˆ é™¤å¤±è´¥ï¼š') + errorText);
        }
        
        // åˆ é™¤æˆåŠŸï¼Œåˆ·æ–°ä¼šè¯åˆ—è¡¨
        if (currentProject) {
          await loadProjectSessions(currentProject);
        }
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œæ¸…ç©ºå½“å‰ä¼šè¯çŠ¶æ€
        if (currentSession === sessionId) {
          currentSession = null;
          currentDataset = null;
          setStepActive('upload');
          updateRunButtonState();
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        logMessage(gettext('ä¼šè¯"') + sessionName + gettext('"å·²åˆ é™¤'));
        
      } catch (e) {
        console.error('Delete session error:', e);
        alert(gettext('åˆ é™¤ä¼šè¯å¤±è´¥ï¼š') + (e.message || e));
      }
    }

      // ä»…åœ¨æ²¡æœ‰æ¢å¤åˆ°å…¶ä»–ä¼šè¯æ—¶æ‰é»˜è®¤è®¾ç½®ä¸ºä¸Šä¼ æ­¥éª¤
      if (!currentSession) setStepActive('upload');
    });
  </script>
{% endblock %}