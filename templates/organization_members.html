{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "组织成员" %} - CellInsightAI{% endblock %}

{% block extra_css %}
<style>
/**** 保留原有样式，略微精简以适配 base ****/
.page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
.page-header h1{ font-size:20px; margin:0; }
.toolbar { display:flex; gap:8px; flex-wrap:wrap; }
.table thead th { color:#8ea0b7; font-weight:500; }
.badge-role { padding:4px 8px; border-radius: 6px; font-size: 12px; }
.badge-role.owner { background: rgba(244, 196, 61, .15); color: #e0b74b; }
.badge-role.admin { background: rgba(79, 141, 245, .15); color: #4f8df5; }
.badge-role.member { background: rgba(49, 196, 141, .15); color: #31c48d; }
.badge-role.viewer { background: rgba(142, 160, 183, .15); color: #8ea0b7; }
.role-select { background:#0d1628; color:#eaf0ff; border:1px solid rgba(255,255,255,0.08); border-radius:6px; padding: 6px 10px; }
.card-section { background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-header">
    <h1>{% trans "组织成员" %}</h1>
    <div class="toolbar">
      <input id="searchInput" type="text" class="form-control" placeholder="{% trans '搜索用户邮箱/姓名' %}">
      <button class="btn btn-primary" id="inviteBtn"><i class="fa fa-user-plus"></i> {% trans "邀请" %}</button>
      <button class="btn btn-secondary" id="bulkInviteBtn">{% trans "批量邀请" %}</button>
      <button class="btn btn-outline-light" id="refreshBtn">{% trans "刷新" %}</button>
    </div>
  </div>

  <div id="alertBox"></div>

  <div class="card-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <strong>{% trans "成员" %}</strong>
        <small class="text-muted ms-2">{% trans "支持按角色筛选与搜索" %}</small>
      </div>
      <div>
        <select id="roleFilter" class="form-select form-select-sm" style="width:auto; display:inline-block">
          <option value="">{% trans "全部角色" %}</option>
          <option value="owner">{% trans "所有者" %}</option>
          <option value="admin">{% trans "管理员" %}</option>
          <option value="member">{% trans "成员" %}</option>
          <option value="viewer">{% trans "只读" %}</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle">
        <thead>
          <tr>
            <th>{% trans "用户" %}</th>
            <th>{% trans "邮箱" %}</th>
            <th>{% trans "角色" %}</th>
            <th>{% trans "加入时间" %}</th>
            <th style="width:120px">{% trans "操作" %}</th>
          </tr>
        </thead>
        <tbody id="membersBody"></tbody>
      </table>
    </div>

    <nav>
      <ul class="pagination" id="pagination"></ul>
    </nav>
  </div>
</div>

<!-- 简单邀请 Modal -->
<div class="modal" tabindex="-1" id="inviteModal">
  <div class="modal-dialog">
    <div class="modal-content bg-dark">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "邀请成员" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">{% trans "邮箱" %}</label>
          <input type="email" class="form-control" id="inviteEmail" placeholder="user@example.com">
        </div>
        <div class="mb-3">
          <label class="form-label">{% trans "角色" %}</label>
          <select class="form-select" id="inviteRole">
            <option value="member">{% trans "成员" %}</option>
            <option value="viewer">{% trans "只读" %}</option>
            <option value="admin">{% trans "管理员" %}</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "取消" %}</button>
        <button type="button" class="btn btn-primary" id="inviteSubmit">{% trans "发送邀请" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- 批量邀请 Modal -->
<div class="modal" tabindex="-1" id="bulkInviteModal">
  <div class="modal-dialog">
    <div class="modal-content bg-dark">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "批量邀请" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">{% trans "每行一个邮箱，最多一次 50 个" %}</p>
        <textarea id="bulkInviteEmails" class="form-control" rows="6" placeholder="user1@example.com\nuser2@example.com\n..."></textarea>
        <div class="mt-3">
          <label class="form-label">{% trans "默认角色" %}</label>
          <select class="form-select" id="bulkInviteRole">
            <option value="member">{% trans "成员" %}</option>
            <option value="viewer">{% trans "只读" %}</option>
            <option value="admin">{% trans "管理员" %}</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "取消" %}</button>
        <button type="button" class="btn btn-primary" id="bulkInviteSubmit">{% trans "发送邀请" %}</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% url 'javascript-catalog' %}"></script>
<script>
  function showAlert(type, msg) {
    const html = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    document.getElementById('alertBox').innerHTML = html;
  }

  function roleLabel(role) {
    const map = {owner: gettext('所有者'), admin: gettext('管理员'), member: gettext('成员'), viewer: gettext('只读')};
    return map[role] || role;
  }

  function roleBadge(role) {
    const map = {owner:'owner', admin:'admin', member:'member', viewer:'viewer'};
    const klass = map[role] || 'member';
    return `<span class="badge-role ${klass}">${roleLabel(role)}</span>`;
  }

  function fmtDate(s){ if(!s) return '-'; const d=new Date(s); return d.toLocaleString(); }

  async function loadMembers(page=1, search='', role='') {
    const params = new URLSearchParams({page});
    if (search) params.set('search', search);
    if (role) params.set('role', role);
    const headers = Object.assign({'X-CSRFToken': getCsrfToken()}, window.currentOrgId ? {'X-Org': window.currentOrgId} : {});
    const res = await fetch(`${window.APP_URLS.API_MEMBERSHIPS}?${params.toString()}`, {headers});
    if (!res.ok) { showAlert('danger', gettext('加载成员失败')); return; }
    const data = await res.json();
    const list = data.results || data;
    const tbody = document.getElementById('membersBody');
    tbody.innerHTML = '';
    for (const m of list) {
      const tr = document.createElement('tr');
      const user = m.user || {};
      tr.innerHTML = `
        <td>${user.first_name||''} ${user.last_name||''}</td>
        <td>${user.email||m.user_email||'-'}</td>
        <td>
          <select class="role-select" data-id="${m.id}">
            <option value="owner" ${m.role==='owner'?'selected':''}>${gettext('所有者')}</option>
            <option value="admin" ${m.role==='admin'?'selected':''}>${gettext('管理员')}</option>
            <option value="member" ${m.role==='member'?'selected':''}>${gettext('成员')}</option>
            <option value="viewer" ${m.role==='viewer'?'selected':''}>${gettext('只读')}</option>
          </select>
        </td>
        <td>${fmtDate(m.created_at || m.accepted_at)}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" data-action="remove" data-id="${m.id}">${gettext('移除')}</button>
        </td>`;
      tbody.appendChild(tr);
    }
    // TODO: pagination render
  }

  async function invite(email, role) {
    const headers = Object.assign({'Content-Type':'application/json','X-CSRFToken': getCsrfToken()}, window.currentOrgId ? {'X-Org': window.currentOrgId} : {});
    const body = JSON.stringify({ user_email: email, role });
    const res = await fetch(window.APP_URLS.API_MEMBERSHIPS, {method:'POST', headers, body});
    if (res.ok) {
      showAlert('success', gettext('邀请已发送或成员已加入'));
      loadMembers();
    } else {
      const err = await res.json().catch(()=>({detail:gettext('未知错误')}));
      showAlert('danger', gettext('邀请失败：') + (err.detail||JSON.stringify(err)));
    }
  }

  async function updateRole(id, role) {
    const headers = Object.assign({'Content-Type':'application/json','X-CSRFToken': getCsrfToken()}, window.currentOrgId ? {'X-Org': window.currentOrgId} : {});
    const res = await fetch(`${window.APP_URLS.API_MEMBERSHIPS}${id}/`, {method:'PATCH', headers, body: JSON.stringify({role})});
    if (res.ok) {
      showAlert('success', gettext('角色已更新'));
    } else {
      const err = await res.json().catch(()=>({detail:gettext('未知错误')}));
      showAlert('danger', gettext('更新失败：') + (err.detail||JSON.stringify(err)));
      loadMembers();
    }
  }

  async function removeMember(id) {
    if (!confirm(gettext('确认移除该成员？'))) return;
    const headers = Object.assign({'X-CSRFToken': getCsrfToken()}, window.currentOrgId ? {'X-Org': window.currentOrgId} : {});
    const res = await fetch(`${window.APP_URLS.API_MEMBERSHIPS}${id}/`, {method:'DELETE', headers});
    if (res.ok) {
      showAlert('success', gettext('成员已移除'));
      loadMembers();
    } else {
      const err = await res.json().catch(()=>({detail:gettext('未知错误')}));
      showAlert('danger', gettext('移除失败：') + (err.detail||JSON.stringify(err)));
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // 事件绑定
    document.getElementById('refreshBtn').addEventListener('click', () => loadMembers(1, document.getElementById('searchInput').value, document.getElementById('roleFilter').value));
    document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('refreshBtn').click(); });
    document.getElementById('roleFilter').addEventListener('change', () => document.getElementById('refreshBtn').click());

    document.getElementById('inviteBtn').addEventListener('click', ()=> new bootstrap.Modal(document.getElementById('inviteModal')).show());
    document.getElementById('bulkInviteBtn').addEventListener('click', ()=> new bootstrap.Modal(document.getElementById('bulkInviteModal')).show());

    document.getElementById('inviteSubmit').addEventListener('click', async ()=>{
      const email = document.getElementById('inviteEmail').value.trim();
      const role = document.getElementById('inviteRole').value;
      if (!email) { showAlert('warning', gettext('请输入邮箱')); return; }
      await invite(email, role);
      bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
    });

    document.getElementById('bulkInviteSubmit').addEventListener('click', async ()=>{
      const lines = document.getElementById('bulkInviteEmails').value.split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,50);
      const role = document.getElementById('bulkInviteRole').value;
      if (!lines.length) { showAlert('warning', gettext('请输入至少一个邮箱')); return; }
      for (const email of lines) { await invite(email, role); }
      bootstrap.Modal.getInstance(document.getElementById('bulkInviteModal')).hide();
    });

    document.getElementById('membersBody').addEventListener('change', (e)=>{
      if (e.target.matches('select.role-select')) {
        updateRole(e.target.getAttribute('data-id'), e.target.value);
      }
    });

    document.getElementById('membersBody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action="remove"]');
      if (btn) removeMember(btn.getAttribute('data-id'));
    });

    // 初始加载
    loadMembers();
  });
</script>
{% endblock %}