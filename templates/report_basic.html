{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "运行报告" %} - CellInsightAI{% endblock %}

{% block extra_css %}
<style>
  body { margin: 24px; }
  h1 { font-size: 24px; margin-bottom: 8px; }
  h2 { font-size: 18px; margin-top: 24px; margin-bottom: 8px; }
  .meta { color: var(--muted); font-size: 12px; }
  .panel { border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 12px; }
  .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border-bottom: 1px solid var(--border); text-align: left; padding: 8px; font-size: 14px; }
  .kpi { display: flex; gap: 12px; }
  .kpi .item { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; padding: 12px; flex: 1; }
  .muted { color: var(--muted); }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(79,141,245,0.2); color: var(--accent); font-size: 12px; }
</style>
{% endblock %}

{% block content %}
<h1>CellInsightAI {% trans "运行报告" %}</h1>
<div class="meta">{% trans "生成时间：" %}{{ generated_at }} | {% trans "运行ID：" %}{{ run.id }} | {% trans "步骤：" %}{{ run.step.name }} ({{ run.step.step_type }})</div>

  <div class="panel">
    <h2>{% trans "样本信息" %}</h2>
    <div class="grid">
      <div>
        <div class="muted">{% trans "项目" %}</div>
        <div>{{ run.sample.project.name }}</div>
      </div>
      <div>
        <div class="muted">{% trans "样本" %}</div>
        <div>{{ run.sample.name }}</div>
      </div>
      <div>
        <div class="muted">{% trans "状态" %}</div>
        <div><span class="badge">{{ run.status }}</span></div>
      </div>
      <div>
        <div class="muted">{% trans "开始时间" %}</div>
        <div>{{ run.started_at }}</div>
      </div>
      <div>
        <div class="muted">{% trans "结束时间" %}</div>
        <div>{{ run.finished_at }}</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>{% trans "参数" %}</h2>
    <table>
      <thead><tr><th>{% trans "键" %}</th><th>{% trans "值" %}</th></tr></thead>
      <tbody>
      {% for k, v in run.params_json.items %}
        <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
      {% empty %}
        <tr><td colspan="2" class="muted">{% trans "无参数" %}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="panel">
    <h2>{% trans "指标" %}</h2>
    <div class="kpi">
      {% for k, v in (run.metrics_json or {}).items %}
        <div class="item">
          <div class="muted">{{ k }}</div>
          <div style="font-size:20px; font-weight:600;">{{ v }}</div>
        </div>
      {% empty %}
        <div class="muted">{% trans "暂无指标" %}</div>
      {% endfor %}
    </div>
  </div>

  <div class="panel">
    <h2>{% trans "证据" %}</h2>
    <table>
      <thead><tr><th>{% trans "类型" %}</th><th>{% trans "内容" %}</th></tr></thead>
      <tbody>
      {% for ev in (run.evidence_json or []) %}
        <tr><td>{{ ev.type }}</td><td>{{ ev.content }}</td></tr>
      {% empty %}
        <tr><td colspan="2" class="muted">{% trans "暂无" %}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="panel">
    <h2>{% trans "建议" %}</h2>
    <table>
      <thead><tr><th>ID</th><th>{% trans "标题" %}</th><th>{% trans "内容" %}</th><th>{% trans "是否已应用" %}</th></tr></thead>
      <tbody>
      {% for a in advice %}
        <tr>
          <td>{{ a.id }}</td>
          <td>{{ a.title }}</td>
          <td>{{ a.text }}</td>
          <td>{{ a.is_applied }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4" class="muted">{% trans "暂无建议" %}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}